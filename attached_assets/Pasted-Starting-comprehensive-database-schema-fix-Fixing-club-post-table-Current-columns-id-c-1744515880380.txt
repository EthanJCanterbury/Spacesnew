Starting comprehensive database schema fix...

--- Fixing club_post table ---
Current columns: id, club_id, author_id, content, created_at, updated_at, likes, attachments, user_id
❌ Error fixing club_post table: (psycopg2.errors.DuplicateColumn) column "user_id" of relation "club_post" already exists
CONTEXT:  SQL statement "ALTER TABLE club_post RENAME COLUMN author_id TO user_id"
PL/pgSQL function inline_code_block line 8 at SQL statement

[SQL: 
                DO $$ 
                BEGIN
                    -- Handle author_id to user_id conversion if needed
                    IF EXISTS (
                        SELECT 1 FROM information_schema.columns 
                        WHERE table_name = 'club_post' AND column_name = 'author_id'
                    ) THEN
                        ALTER TABLE club_post RENAME COLUMN author_id TO user_id;
                        RAISE NOTICE 'Renamed author_id to user_id';
                    END IF;
                    
                    -- Add user_id if it doesn't exist
                    IF NOT EXISTS (
                        SELECT 1 FROM information_schema.columns 
                        WHERE table_name = 'club_post' AND column_name = 'user_id'
                    ) THEN
                        ALTER TABLE club_post ADD COLUMN user_id INTEGER REFERENCES "user"(id);
                        RAISE NOTICE 'Added user_id column';
                    END IF;
                    
                    -- Make sure there's no NOT NULL constraint if we just added it
                    BEGIN
                        ALTER TABLE club_post ALTER COLUMN user_id DROP NOT NULL;
                        RAISE NOTICE 'Dropped NOT NULL constraint from user_id';
                    EXCEPTION WHEN OTHERS THEN
                        NULL;
                    END;
                END $$;
            ]
(Background on this error at: https://sqlalche.me/e/20/f405)

--- Fixing club_resource table ---
Current columns: id, club_id, creator_id, title, description, url, icon, created_at, created_by
❌ Error fixing club_resource table: (psycopg2.errors.DuplicateColumn) column "created_by" of relation "club_resource" already exists
CONTEXT:  SQL statement "ALTER TABLE club_resource RENAME COLUMN creator_id TO created_by"
PL/pgSQL function inline_code_block line 8 at SQL statement

[SQL: 
                DO $$ 
                BEGIN
                    -- Handle creator_id to created_by conversion if needed
                    IF EXISTS (
                        SELECT 1 FROM information_schema.columns 
                        WHERE table_name = 'club_resource' AND column_name = 'creator_id'
                    ) THEN
                        ALTER TABLE club_resource RENAME COLUMN creator_id TO created_by;
                        RAISE NOTICE 'Renamed creator_id to created_by';
                    END IF;
                    
                    -- Add created_by if it doesn't exist
                    IF NOT EXISTS (
                        SELECT 1 FROM information_schema.columns 
                        WHERE table_name = 'club_resource' AND column_name = 'created_by'
                    ) THEN
                        ALTER TABLE club_resource ADD COLUMN created_by INTEGER REFERENCES "user"(id);
                        RAISE NOTICE 'Added created_by column';
                    END IF;
                    
                    -- Make sure there's no NOT NULL constraint if we just added it
                    BEGIN
                        ALTER TABLE club_resource ALTER COLUMN created_by DROP NOT NULL;
                        RAISE NOTICE 'Dropped NOT NULL constraint from created_by';
                    EXCEPTION WHEN OTHERS THEN
                        NULL;
                    END;
                END $$;
            ]
(Background on this error at: https://sqlalche.me/e/20/f405)

--- Fixing club_assignment table ---
Current columns: id, club_id, creator_id, title, description, due_date, status, created_at, updated_at, created_by
✅ Successfully fixed club_assignment table schema

--- Fixing club_chat_message table ---
Current columns: id, channel_id, user_id, content, created_at
✅ Successfully fixed club_chat_message table schema

Database schema fixes completed.

Checking and creating default channels for clubs...
Club already has channels: CodetheTech (3 channels)
Club already has channels: EthanAtHackClub's Club (4 channels)
✅ Completed channel setup
