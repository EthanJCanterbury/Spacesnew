{% extends "base.html" %}

{% block body_class %}editor-page{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/eclipse.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/dialog/dialog.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/matchesonscrollbar.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
<style>
/* Editor tabs styling */
.editor-tabs {
    display: flex;
    background-color: #f5f5f5;
    border-bottom: 1px solid #ddd;
}

.editor-tab {
    padding: 8px 16px;
    border: none;
    background: none;
    cursor: pointer;
    font-weight: 500;
    color: #4a5568;
    transition: all 0.2s ease;
}

.editor-tab:hover {
    background-color: #e9ecef;
}

.editor-tab.active {
    background-color: #fff;
    color: #6a0dad;
    border-bottom: 2px solid #6a0dad;
}

.editor-container-tab {
    display: none;
    height: 100%;
}

.editor-container-tab.active {
    display: block;
    height: 100%;
}

.browser-address {
    display: flex;
    align-items: center;
    position: relative;
}

.browser-address #openDeployedSiteBtn {
    background: none;
    border: none;
    color: #ed6663;
    cursor: pointer;
    padding: 5px 8px;
    margin-left: 8px;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.browser-address #deployBtn {
    background: #6a0dad;
    border: none;
    color: white;
    cursor: pointer;
    padding: 5px 12px;
    margin-left: auto;
    border-radius: 4px;
    transition: all 0.2s ease;
    font-weight: 500;
}

.browser-address #openDeployedSiteBtn:hover {
    background-color: rgba(237, 102, 99, 0.1);
    color: #ed6663;
}

.modal-info {
    margin-top: 15px;
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 4px;
    border-left: 4px solid #6a0dad;
}

.site-url {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
    background-color: #f8f9fa;
    border-radius: 4px;
    padding: 5px;
}

.site-url input {
    flex-grow: 1;
    padding: 8px;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    font-family: monospace;
    margin-right: 5px;
}

.site-url button {
    padding: 8px 12px;
    background-color: #6a0dad;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin-right: 5px;
}

.site-url button:hover {
    background-color: #8a2be2;
}

.browser-address #deployBtn:hover {
    background-color: #8a2be2;
    color: white;
}

.dropdown {
    position: relative;
    display: inline-block;
}

.dropdown-toggle {
    cursor: pointer;
}

.remote-cursor {
    display: inline-block;
    border-left: 2px solid;
    height: 1.2em;
    position: relative;
}

.remote-cursor-label {
    position: absolute;
    top: -1.4em;
    left: -1px;
    font-size: 12px;
    font-weight: bold;
    color: white;
    padding: 2px 6px;
    border-radius: 3px;
    white-space: nowrap;
    user-select: none;
    pointer-events: none;
    z-index: 1000;
}

.dropdown-menu {
    position: absolute;
    top: 100%;
    right: 0;
    z-index: 1000;
    display: none;
    min-width: 200px;
    padding: 10px;
    margin-top: 5px;
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 15px rgba(0, 0, 0, 0.15);
}

.dropdown:hover .dropdown-menu {
    display: block;
}

.dropdown-section {
    padding: 8px 0;
    border-bottom: 1px solid #e2e8f0;
}

.dropdown-section:last-child {
    border-bottom: none;
}

.dropdown-section label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    font-size: 0.85rem;
    color: #4a5568;
}

.dropdown-section select {
    width: 100%;
    padding: 6px;
    border-radius: 4px;
    border: 1px solid #cbd5e0;
    background-color: #f8f9fa;
}

.dropdown-section.checkbox {
    display: flex;
    align-items: center;
}

.dropdown-section.checkbox label {
    display: flex;
    align-items: center;
    margin-bottom: 0;
    cursor: pointer;
}

.dropdown-section.checkbox input {
    margin-right: 8px;
}

.editor-statusbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 15px;
    height: 25px;
    background-color: #f1f3f5;
    border-top: 1px solid #e2e8f0;
    font-size: 0.8rem;
    color: #4a5568;
}

.editor-statusbar .status-section {
    display: flex;
    align-items: center;
}

.editor-statusbar .status-item {
    margin-right: 15px;
    display: flex;
    align-items: center;
}

.editor-statusbar .status-item i {
    margin-right: 5px;
    font-size: 0.9rem;
}

.cm-s-dracula.CodeMirror { background: #282a36; color: #f8f8f2; }
.cm-s-dracula .CodeMirror-gutters { background: #282a36; border-right: 0; }
.cm-s-dracula .CodeMirror-linenumber { color: #6D8A88; }
.cm-s-dracula .CodeMirror-cursor { border-left: 1px solid #f8f8f2; }

.cm-s-material.CodeMirror { background: #263238; color: #EEFFFF; }
.cm-s-material .CodeMirror-gutters { background: #263238; border-right: 0; }
.cm-s-material .CodeMirror-linenumber { color: #546E7A; }
.cm-s-material .CodeMirror-cursor { border-left: 1px solid #FFCC00; }

.shortcuts-modal {
    max-width: 600px;
}

.shortcuts-list {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin-top: 15px;
}

.shortcut-category {
    margin-bottom: 15px;
}

.shortcut-category h4 {
    margin-bottom: 10px;
    font-size: 1rem;
    color: #2d3748;
    border-bottom: 1px solid #e2e8f0;
    padding-bottom: 5px;
}

.shortcut-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
}

.shortcut-key {
    display: inline-block;
    padding: 2px 6px;
    background-color: #f1f3f5;
    border-radius: 3px;
    border: 1px solid #e2e8f0;
    font-family: monospace;
    font-size: 0.85rem;
}

.lint-error-marker {
    color: #e53e3e;
    position: relative;
}

.lint-warning-marker {
    color: #ecc94b;
    position: relative;
}

.lint-marker-hint {
    border-bottom: 1px dotted;
}

.split-layout .editor-main {
    display: grid;
    grid-template-columns: 1fr 1fr;
}

.split-layout .preview-pane {
    display: block !important;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal.show {
    display: flex;
}

/* Toast notifications */
#toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.toast {
    min-width: 250px;
    padding: 12px 15px;
    border-radius: 4px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    display: flex;
    align-items: center;
    justify-content: space-between;
    animation: slideIn 0.3s ease;
    background-color: #333;
    color: white;
}

.toast.success {
    background-color: #4CAF50;
}

.toast.error {
    background-color: #F44336;
}

.toast.info {
    background-color: #2196F3;
}

.toast-content {
    display: flex;
    align-items: center;
    gap: 10px;
}

.toast-close {
    background: none;
    border: none;
    color: white;
    font-size: 18px;
    cursor: pointer;
    padding: 0 5px;
}

.toast.fade-out {
    opacity: 0;
    transition: opacity 0.3s ease;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.modal-content {
    background-color: #ffffff;
    border-radius: 12px;
    max-width: 650px;
    width: 90%;
}

.coop-indicator {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
    border-left: 4px solid #4CAF50;
}

.coop-status {
    font-size: 1.1em;
    margin: 0;
}

.coop-status span {
    font-weight: bold;
}

.coop-section {
    margin-bottom: 25px;
}

.coop-form {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.coop-form input {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid #ced4da;
    border-radius: 4px;
}

.collaborators-container {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #e9ecef;
    border-radius: 4px;
}

.collaborator-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px;
    border-bottom: 1px solid #e9ecef;
}

.collaborator-item:last-child {
    border-bottom: none;
}

.collaborator-info {
    display: flex;
    align-items: center;
    gap: 10px;
}

.collaborator-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background-color: #6c757d;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

.active-collaborators {
    margin-top: 15px;
}

.active-collaborators ul {
    list-style: none;
    padding: 0;
    margin: 10px 0 0 0;
}

.active-collaborators li {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
}

.collaborator-cursor {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
}

.hidden {
    display: none;
}

.remote-cursor {
    position: absolute;
    pointer-events: none;
    z-index: 10;
}

.cursor-label {
    position: absolute;
    font-size: 12px;
    padding: 2px 4px;
    border-radius: 3px;
    white-space: nowrap;
    pointer-events: none;
    z-index: 11;
    color: white;
}

.modal-content {
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    animation: modalFadeIn 0.3s ease;
}

@keyframes modalFadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid #eaeef2;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #f9fafc;
    border-radius: 12px 12px 0 0;
}

.modal-header h2 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    color: #333;
}

.modal-header h2 i {
    margin-right: 10px;
    color: #ed6663;
}

.close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #888;
    transition: color 0.2s ease;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
}

.close-btn:hover {
    color: #ed6663;
    background-color: rgba(237, 102, 99, 0.1);
}

.modal-body {
    padding: 1.5rem;
    background-color: #ffffff;
    border-radius: 0 0 12px 12px;
}

.console-frame {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    border: 1px solid #ddd;
    border-radius: 8px;
    overflow: hidden;
}

.console-header {
    padding: 10px 15px;
    background-color: #f8f9fa;
    border-bottom: 1px solid #ddd;
    display: flex;
    align-items: center;
}

.console-title {
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
}

.console-title i {
    color: #6c757d;
}

.console-output {
    flex: 1;
    background-color: #2b2b2b;
    color: #f8f8f2;
    font-family: monospace;
    padding: 15px;
    margin: 0;
    overflow-y: auto;
    white-space: pre-wrap;
    height: 100%;
}

.analytics-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.analytics-summary {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    gap: 20px;
}

.analytics-count {
    text-align: center;
    padding: 20px;
    background-color: #f5f7fa;
    border-radius: 8px;
    min-width: 120px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    border: 1px solid #eaeef2;
}

.analytics-count span {
    display: block;
    font-size: 2.5rem;
    font-weight: 700;
    color: #ed6663;
    margin-bottom: 5px;
}

.analytics-count label {
    font-size: 0.9rem;
    color: #626262;
    font-weight: 500;
}

.analytics-actions {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.analytics-toggle {
    display: flex;
    align-items: center;
    gap: 10px;
    background-color: #f5f7fa;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #eaeef2;
}

#clearAnalyticsBtn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
    padding: 10px 15px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
}

#clearAnalyticsBtn:hover {
    background-color: #f1b0b7;
    color: #721c24;
}

#clearAnalyticsBtn i {
    font-size: 14px;
}

.analytics-info {
    background-color: #f8f0f0;
    padding: 15px;
    border-radius: 8px;
    margin-top: 20px;
    border-left: 4px solid #ed6663;
}

.analytics-info p {
    margin: 0;
    font-size: 0.9rem;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 8px;
}

.switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
}

.slider:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
}

input:checked + .slider {
    background-color: var(--primary);
}

input:focus + .slider {
    box-shadow: 0 0 1px var(--primary);
}

input:checked + .slider:before {
    transform: translateX(26px);
}

.slider.round {
    border-radius: 34px;
}

.slider.round:before {
    border-radius: 50%;
}

.admin-container {
    display: flex;
    min-height: 100vh;
    background-color: var(--background-secondary);
    color: var(--text-primary);
    transition: all 0.3s ease;
}

.orphy-widget {
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    display: none;
    pointer-events: none;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
}

.orphy-widget.active {
    display: block;
}

.orphy-container {
    width: 420px;
    height: 520px;
    background-color: white;
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transition: none;
    border: 1px solid #e2e8f0;
    position: absolute;
    top: 20%;
    right: 30px;
    pointer-events: auto;
    z-index: 2000;
    display: flex; 
    flex-direction: column; 
}

.orphy-header {
    background: linear-gradient(135deg, var(--primary), #f86b60);
    color: white;
    padding: 16px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: move;
    user-select: none;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.dragging {
    cursor: grabbing !important;
    opacity: 0.85;
    box-shadow: 0 15px 50px rgba(0, 0, 0, 0.3);
}

.orphy-emoji {
    font-size: 1rem;
    font-weight: normal;
    margin-left: 6px;
}

.orphy-close-btn {
    background: transparent;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    transition: all 0.2s;
}

.orphy-close-btn:hover {
    background-color: rgba(255, 255, 255, 0.2);
}

.orphy-title {
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

.orphy-actions {
    display: flex;
    gap: 8px;
}

.orphy-actions button {
    background: none;
    border: none;
    color: white;
    font-size: 14px;
    cursor: pointer;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: background-color 0.2s;
}

.orphy-actions button:hover {
    background-color: rgba(255, 255, 255, 0.2);
}

.orphy-chat {
    flex: 1;
    padding: 20px;
    overflow-y: scroll; 
    display: flex; 
    flex-direction: column; 
    max-height: calc(100% - 120px); 
    height: 100%; 
    background-color: #f9fafb;
    background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxwYXRoIGQ9Ik0zNiAxOGMwLTkuOTQtOC4wNi0xOC0xOC0xOEMzNyAwIDQ1IDggNDUgMThjMCA5Ljk0LTguMDYgMTgtMTggMTgiIGZpbGw9IiNmMGYyZjUiLz48L2c+PC9zdmc+');
    background-position: 0 0;
    background-size: 60px 60px;
    position: relative; 
}

.orphy-messages {
    display: flex;
    flex-direction: column;
    gap: 12px;
    width: 100%;
    height: auto;
    flex: 1;
    overflow-y: auto; 
    padding-right: 4px;
    scroll-behavior: smooth; 
    min-height: 0; 
}

.orphy-message {
    max-width: 85%;
    padding: 12px 16px;
    border-radius: 18px;
    position: relative;
    word-break: break-word;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    margin-bottom: 12px;
    animation: message-appear 0.3s ease;
}

.orphy-user {
    align-self: flex-end;
    background: linear-gradient(135deg, var(--primary), #f86b60);
    color: white;
    border-bottom-right-radius: 4px;
    text-shadow: 0 1px 1px rgba(0,0,0,0.1);
}

.orphy-assistant {
    align-self: flex-start;
    background-color: white;
    color: #3a3f4d;
    border: 1px solid #e2e8f0;
    border-bottom-left-radius: 4px;
    font-size: 15px;
}

.orphy-thinking {
    align-self: flex-start;
    background-color: #e9ecef;
    color: #495057;
    font-style: italic;
    border-bottom-left-radius: 4px;
}

.orphy-message-content {
    line-height: 1.4;
}

.orphy-message-content a {
    color: #0077cc;
    text-decoration: underline;
}

.orphy-input {
    padding: 16px;
    border-top: 1px solid #e2e8f0;
    display: flex;
    align-items: flex-end;
    gap: 12px;
    background-color: white;
    box-shadow: 0 -4px 10px rgba(0,0,0,0.03);
}

.orphy-input textarea {
    flex: 1;
    padding: 14px 18px;
    border: 1px solid #dce1e9;
    border-radius: 24px;
    resize: none;
    min-height: 48px;
    max-height: 150px;
    font-family: inherit;
    font-size: 15px;
    transition: all 0.2s;
    line-height: 1.5;
    box-shadow: 0 2px 5px rgba(0,0,0,0.04);
    width: calc(100% - 65px);
    outline: none;
    overflow-y: auto;
    scrollbar-width: thin;
}

.orphy-input textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(237, 102, 99, 0.25);
}

.orphy-send-btn {
    background: linear-gradient(135deg, var(--primary), #f86b60);
    color: white;
    border: none;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(237, 102, 99, 0.3);
    flex-shrink: 0;
}

.orphy-send-btn:hover {
    transform: scale(1.05);
    background-color: #d6564e;
}

.orphy-send-btn:active {
    transform: scale(0.95);
}

.orphy-input textarea::placeholder {
    color: #adb5bd;
}
@keyframes message-appear {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.typing-indicator {
    display: flex;
    align-items: center;
    gap: 5px;
}

.typing-dot {
    width: 8px;
    height: 8px;
    background-color: #adb5bd;
    border-radius: 50%;
    animation: typing-dot 1.4s infinite ease-in-out;
}

.typing-dot:nth-child(1) {
    animation-delay: 0s;
}

.typing-dot:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-dot:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing-dot {
    0%, 100% {
        transform: scale(0.7);
        opacity: 0.5;
    }
    50% {
        transform: scale(1);
        opacity: 1;
    }
}

/* Typing indicator animation */
.dot-typing {
    position: relative;
    margin-left: 8px;
    display: inline-block;
}

.dot-typing::after {
    content: '...';
    animation: dot-typing 1.5s infinite;
    letter-spacing: 2px;
}

@keyframes dot-typing {
    0% { content: '.'; }
    25% { content: '..'; }
    50% { content: '...'; }
    75% { content: '..'; }
}
</style>
{% endblock %}

{% block content %}
<div class="editor-container">
    <div class="editor-topbar">
        <div class="topbar-left">
            <a href="{{ url_for('welcome') }}" class="btn-icon" title="Back to Dashboard">
                <i class="fas fa-arrow-left"></i>
            </a>
            <h1>{{ site.name }}</h1>
        </div>
        <div class="topbar-actions">
            <button id="undoBtn" class="btn-icon" title="Undo (Ctrl+Z)" disabled>
                <i class="fas fa-undo"></i>
            </button>
            <button id="redoBtn" class="btn-icon" title="Redo (Ctrl+Y)" disabled>
                <i class="fas fa-redo"></i>
            </button>

            <div class="dropdown">
                <button class="btn-icon dropdown-toggle" title="Editor Settings">
                    <i class="fas fa-cog"></i>
                </button>
                <div class="dropdown-menu">
                    <div class="dropdown-section">
                        <label for="themeSelector">Theme:</label>
                        <select id="themeSelector" onchange="changeEditorTheme(this.value)">
                            <option value="eclipse">Eclipse</option>
                            <option value="monokai">Monokai</option>
                            <option value="dracula">Dracula</option>
                            <option value="material">Material</option>
                            <option value="mdn-like">MDN-like</option>
                            <option value="solarized dark">Solarized Dark</option>
                            <option value="solarized light">Solarized Light</option>
                        </select>
                    </div>
                    <div class="dropdown-section">
                        <label for="fontSizeSelector">Font Size:</label>
                        <select id="fontSizeSelector" onchange="changeEditorFontSize(this.value)">
                            <option value="12px">Small</option>
                            <option value="14px" selected>Medium</option>
                            <option value="16px">Large</option>
                            <option value="18px">X-Large</option>
                        </select>
                    </div>
                    <div class="dropdown-section checkbox">
                        <label>
                            <input type="checkbox" id="wordWrapToggle" checked onchange="toggleWordWrap(this.checked)">
                            Word Wrap
                        </label>
                    </div>
                    <div class="dropdown-section checkbox">
                        <label>
                            <input type="checkbox" id="lintToggle" onchange="toggleLinting(this.checked)">
                            Lint Code
                        </label>
                    </div>
                </div>
            </div>

            <button id="searchBtn" class="btn-icon" title="Search (Ctrl+F)" onclick="focusSearch()">
                <i class="fas fa-search"></i>
            </button>

            {% if site.site_type == 'web' %}
            <button id="copyLinkBtn" class="btn-primary" onclick="window.location.href='https://boba.hackclub.com/'">
                <i class="fa-solid fa-mug-hot"></i>
                Give Me My Boba!!!
            </button>
            <button id="analyticsBtn" class="btn-primary" onclick="openAnalyticsModal()">
                <i class="fas fa-chart-line"></i>
                Analytics
            </button>
            <button id="formatterBtn" class="btn-primary" onclick="openOrphyChat()">
                <i class="fas fa-magic"></i>
                Orphy
            </button>
            {% elif site.site_type == 'python' %}
            <button id="runBtn" class="btn-primary" onclick="runCode()">
                <i class="fas fa-play"></i>
                Run
            </button>
            <button id="formatterBtn" class="btn-primary" onclick="formatPythonCode()">
                <i class="fas fa-magic"></i>
                Format
            </button>
            {% endif %}

            <button id="saveBtn" class="btn-primary" onclick="saveContent()">
                <i class="fas fa-save"></i>
                Save Changes
            </button>
            {% if site.user_id == current_user.id %}
            <button id="gitBtn" class="btn-primary" onclick="handleGitAction()">
                <i class="fab fa-github"></i>
                Git
            </button>
            <button id="coopBtn" class="btn-primary" onclick="openCoopModal()">
                <i class="fas fa-users"></i>
                Co-op
            </button>
            {% else %}
            <button id="collaborationStatusBtn" class="btn-primary">
                <i class="fas fa-users"></i>
                <span id="quick-collab-status">Collaborating</span>
            </button>
            {% endif %}
        </div>
    </div>

    <div class="editor-main">
        <div class="editor-pane">
            <div class="editor-tabs">
                <button id="html-tab" class="editor-tab active">HTML</button>
                <button id="css-tab" class="editor-tab">CSS</button>
                <button id="js-tab" class="editor-tab">JS</button>
            </div>
            <div id="html-editor-container" class="editor-container-tab active">
                <textarea id="html-editor">{{ site.html_content }}</textarea>
            </div>
            <div id="css-editor-container" class="editor-container-tab">
                <textarea id="css-editor">{{ site.css_content or '' }}</textarea>
            </div>
            <div id="js-editor-container" class="editor-container-tab">
                <textarea id="js-editor">{{ site.js_content or '' }}</textarea>
            </div>
            <input type="hidden" id="site-slug" value="{{ site.slug }}">
            <input type="hidden" id="site-id" value="{{ site.id }}">
            <div class="editor-statusbar">
                <div class="status-section">
                    <div class="status-item" id="cursorPosition">
                        <i class="fas fa-map-marker-alt"></i> Line 1, Column 1
                    </div>
                    <div class="status-item" id="fileSizeInfo">
                        <i class="fas fa-file-alt"></i> <span id="fileSize">0</span> bytes
                    </div>
                </div>
                <div class="status-section">
                    <div class="status-item" id="editorMode">
                        {{ site.site_type|upper }}
                    </div>
                    <div class="status-item" id="editorSettings">
                        <i class="fas fa-keyboard"></i>
                        <a href="#" onclick="showKeyboardShortcutsModal(); return false;">Shortcuts</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="preview-pane">
            {% if site.site_type == 'web' %}
            <div class="browser-frame">
                <div class="browser-header">
                    <div class="browser-buttons">
                        <span class="browser-button close"></span>
                        <span class="browser-button minimize"></span>
                        <span class="browser-button maximize"></span>
                    </div>
                    <div class="browser-address">
                        <i class="fas fa-lock"></i>
                        <span class="browser-url">https://hackclub.space/s/{{ site.slug }}</span>
                        <div style="flex-grow: 1;"></div>
                        <button id="openDeployedSiteBtn" class="btn-icon" title="Open deployed site in new tab" onclick="openDeployedSite()">
                            <i class="fas fa-external-link-alt"></i>
                        </button>
                        <button id="deployBtn" title="Deploy your site" onclick="deploySite()">
                            <i class="fas fa-rocket" style="color: white;"></i> Deploy
                        </button>
                    </div>
                </div>
                <iframe id="preview" frameborder="0"></iframe>
            </div>
            {% elif site.site_type == 'python' %}
            <div class="console-frame">
                <div class="console-header">
                    <div class="console-title">
                        <i class="fas fa-terminal"></i>
                        Output Console
                    </div>
                </div>
                <pre id="output" class="console-output">Run your code to see the output here!</pre>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div id="githubModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fab fa-github"></i> GitHub Integration</h2>
            <button class="close-btn">&times;</button>
        </div>
        <div class="modal-body" id="githubModalBody">
            <div class="repo-actions">
                <button class="btn-danger" onclick="event.stopPropagation(); disconnectRepo()" title="Disconnect">
                    <i class="fas fa-unlink" style="color: white; font-size: 14px;"></i>
                </button>
                <button class="btn-danger-delete" onclick="event.stopPropagation(); deleteRepo()" title="Delete">
                    <i class="fas fa-trash" style="color: white; font-size: 14px;"></i>
                </button>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn-secondary close-modal">Cancel</button>
        </div>
    </div>
</div>

{% if site.site_type == 'web' %}
<div id="analyticsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Site Analytics</h2>
            <button class="close-btn">&times;</button>
        </div>
        <div class="modal-body">
            <div class="analytics-summary">
                <div class="analytics-count">
                    <span>1234</span>
                    <label>Total Views</label>
                </div>
                <div class="analytics-actions">
                    <div class="analytics-toggle">
                        <label for="analytics-toggle">Enable Analytics:</label>
                        <label class="switch">
                            <input type="checkbox" id="analytics-toggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <button id="clearAnalyticsBtn" class="btn-danger">
                        <i class="fas fa-trash"></i>
                        Clear Analytics
                    </button>
                </div>
            </div>
            <div class="analytics-info">
                <p><i class="fas fa-info-circle"></i> View count shows total visits to your site.</p></p>
            </div>
        </div>
    </div>
</div>

<div id="toast-container"></div>

<div id="deployModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-rocket"></i> Deploy Your Site</h2>
            <button class="close-btn" onclick="closeDeployModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p>Your site is available at the following URLs:</p>
            <div id="deployUrlsContainer">
                {% set siteSlug = site.slug %}
                {% set defaultDomain = 'hackclub.space' %}
                {% set domains = ['hackclub.space', 'imahacker.lol', 'myhack.club', 'hackclub.me'] %}
                
                {% for domain in domains %}
                    {% set url = 'https://' + domain + '/s/' + siteSlug %}
                    <div class="site-url">
                        <input type="text" value="{{ url }}" readonly>
                        <button onclick="navigator.clipboard.writeText('{{ url }}')" class="btn-copy">Copy</button>
                        <a href="{{ url }}" target="_blank" class="btn-icon" title="Open in new tab">
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                    </div>
                {% endfor %}
            </div>
            <div class="modal-info">
                <p><strong>Note:</strong> Your default domain is <code>https://{{ defaultDomain }}/{{ siteSlug }}</code></p>
                {% if request.host == 'spaces.hackclub.com' %}
                    <p><strong>Warning:</strong> Public hosting is not available on spaces.hackclub.com domain</p>
                {% endif %}
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn-secondary" onclick="closeDeployModal()">Close</button>
        </div>
    </div>
</div>

<div id="coopModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-users"></i> Collaboration Settings</h2>
            <button class="close-btn" onclick="closeCoopModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="coop-indicator" id="coopStatus">
                <p class="coop-status">Collaboration is currently <span id="coopStatusText">inactive</span></p>
                <div id="activeCollaborators" class="active-collaborators hidden">
                    <h4>Active Collaborators</h4>
                    <ul id="activeCollaboratorsList"></ul>
                </div>
            </div>

            <div class="coop-section">
                <h3>Add Collaborators</h3>
                <p>Enter email address to invite a user to collaborate on this space:</p>
                <div class="coop-form">
                    <input type="email" id="collaboratorEmail" placeholder="user@example.com">
                    <button class="btn-primary" onclick="addCollaborator()">Add</button>
                </div>
            </div>

            <div class="coop-section" id="collaboratorsList">
                <h3>Collaborators</h3>
                <div class="collaborators-container" id="collaboratorsContainer">
                    <div class="loading-indicator">Loading collaborators...</div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeCoopModal()">Close</button>
        </div>
    </div>
</div>

<div id="keyboardShortcutsModal" class="modal">
    <div class="modal-content shortcuts-modal">
        <div class="modal-header">
            <h2><i class="fas fa-keyboard"></i> Keyboard Shortcuts</h2>
            <button class="close-btn" onclick="closeKeyboardShortcutsModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="shortcuts-list">
                <div class="shortcut-category">
                    <h4>Editor</h4>
                    <div class="shortcut-item">
                        <span>Save</span>
                        <span class="shortcut-key">Ctrl+S</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Undo</span>
                        <span class="shortcut-key">Ctrl+Z</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Redo</span>
                        <span class="shortcut-key">Ctrl+Y</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Fold Code</span>
                        <span class="shortcut-key">Alt+F</span>
                    </div>
                </div>
                <div class="shortcut-category">
                    <h4>Search</h4>
                    <div class="shortcut-item">
                        <span>Find</span>
                        <span class="shortcut-key">Ctrl+F</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Find Next</span>
                        <span class="shortcut-key">Ctrl+G</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Find Previous</span>
                        <span class="shortcut-key">Shift+Ctrl+G</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Replace</span>
                        <span class="shortcut-key">Ctrl+H</span>
                    </div>
                </div>
            </div>
            {% if site.site_type == 'python' %}
            <div class="shortcut-category">
                <h4>Python</h4>
                <div class="shortcut-item">
                    <span>Run Code</span>
                    <span class="shortcut-key">Ctrl+Enter</span>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div id="splitViewToggle" class="btn-icon split-view-toggle" title="Toggle Split View" onclick="toggleSplitView()">
    <i class="fas fa-columns"></i>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/search.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/searchcursor.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/dialog/dialog.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/matchesonscrollbar.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/scroll/annotatescrollbar.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/match-highlighter.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/jump-to-line.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
{% if site.site_type == 'web' %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closetag.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/xml-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/html-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/brace-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/xml-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/comment-fold.min.js"></script>
<script src="{{ url_for('static', filename='js/github.js') }}"></script>
{% elif site.site_type == 'python' %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/python-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/indent-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/comment-fold.min.js"></script>
<script src="{{ url_for('static', filename='js/github.js') }}"></script>
{% endif %}
<!-- Editor.js removed to prevent conflicts -->

<script>
// Initialize the HTML editor
const htmlEditor = CodeMirror.fromTextArea(document.getElementById('html-editor'), {
    mode: "{{ 'htmlmixed' if site.site_type == 'web' else 'python' }}",
    theme: 'eclipse',
    lineNumbers: true,
    autoCloseBrackets: true,
    matchBrackets: true,
    indentUnit: 4,
    tabSize: 4,
    lineWrapping: true,
    foldGutter: true,
    gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
    extraKeys: {
        'Ctrl-Space': 'autocomplete',
        'Ctrl-F': 'findPersistent',
        'Ctrl-G': 'findNext',
        'Shift-Ctrl-G': 'findPrev',
        'Ctrl-H': 'replace',
        'Shift-Ctrl-H': 'replaceAll',
        'Alt-F': function(cm) {
            cm.foldCode(cm.getCursor());
        },
        'Tab': function(cm) {
            if (cm.somethingSelected()) {
                cm.indentSelection('add');
            } else {
                const cursor = cm.getCursor();
                const line = cm.getLine(cursor.line);
                const textBeforeCursor = line.slice(0, cursor.ch);

                if ("{{ site.site_type }}" === "web" && textBeforeCursor.trim() === "!") {
                    const htmlSkeleton = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>

</body>
</html>`;
                    cm.replaceRange(htmlSkeleton, 
                        {line: cursor.line, ch: cursor.ch - 1}, 
                        {line: cursor.line, ch: cursor.ch});
                    cm.setCursor({line: cursor.line + 8, ch: 4});
                } else if (!textBeforeCursor.trim()) {
                    cm.replaceSelection('    ', 'end');
                } else {
                    CodeMirror.commands.autocomplete(cm);
                }
            }
        }
    },
    autoCloseTags: true
});

// Initialize the CSS editor
const cssEditor = CodeMirror.fromTextArea(document.getElementById('css-editor'), {
    mode: "css",
    theme: 'eclipse',
    lineNumbers: true,
    autoCloseBrackets: true,
    matchBrackets: true,
    indentUnit: 4,
    tabSize: 4,
    lineWrapping: true,
    foldGutter: true,
    gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
    extraKeys: {
        'Ctrl-Space': 'autocomplete',
        'Ctrl-F': 'findPersistent',
        'Ctrl-G': 'findNext',
        'Shift-Ctrl-G': 'findPrev',
        'Ctrl-H': 'replace',
        'Shift-Ctrl-H': 'replaceAll',
        'Alt-F': function(cm) {
            cm.foldCode(cm.getCursor());
        },
        'Tab': function(cm) {
            if (cm.somethingSelected()) {
                cm.indentSelection('add');
            } else {
                const cursor = cm.getCursor();
                const line = cm.getLine(cursor.line);
                const textBeforeCursor = line.slice(0, cursor.ch);
                
                if (!textBeforeCursor.trim()) {
                    cm.replaceSelection('    ', 'end');
                } else {
                    CodeMirror.commands.autocomplete(cm);
                }
            }
        }
    }
});

// Initialize the JavaScript editor
const jsEditor = CodeMirror.fromTextArea(document.getElementById('js-editor'), {
    mode: "javascript",
    theme: 'eclipse',
    lineNumbers: true,
    autoCloseBrackets: true,
    matchBrackets: true,
    indentUnit: 4,
    tabSize: 4,
    lineWrapping: true,
    foldGutter: true,
    gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
    extraKeys: {
        'Ctrl-Space': 'autocomplete',
        'Ctrl-F': 'findPersistent',
        'Ctrl-G': 'findNext',
        'Shift-Ctrl-G': 'findPrev',
        'Ctrl-H': 'replace',
        'Shift-Ctrl-H': 'replaceAll',
        'Alt-F': function(cm) {
            cm.foldCode(cm.getCursor());
        },
        'Tab': function(cm) {
            if (cm.somethingSelected()) {
                cm.indentSelection('add');
            } else {
                const cursor = cm.getCursor();
                const line = cm.getLine(cursor.line);
                const textBeforeCursor = line.slice(0, cursor.ch);
                
                if (!textBeforeCursor.trim()) {
                    cm.replaceSelection('    ', 'end');
                } else {
                    CodeMirror.commands.autocomplete(cm);
                }
            }
        }
    }
});

// Reference to the current active editor (default: HTML)
let currentEditor = htmlEditor;


const undoBtn = document.getElementById('undoBtn');
const redoBtn = document.getElementById('redoBtn');

// Auto-save timer variable
let autoSaveTimer = null;

// Set up change handlers for all editors
// Common change handler function
function handleEditorChange(type, instance, changeObj) {
    undoBtn.disabled = !currentEditor.historySize().undo;
    redoBtn.disabled = !currentEditor.historySize().redo;
    
    updatePreview();

    if (changeObj.origin === 'setValue') {
        return;
    }
    
    // Reset and start auto-save timer
    clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(() => {
        if (!document.getElementById('saveBtn').disabled) {
            saveContent();
        }
    }, 30000); // 30 seconds

    if (socket?.connected && collaborationActive) {
        const now = Date.now();
        if (now - lastContentSyncTime > 300) {
            lastContentSyncTime = now;
            let content;
            switch(type) {
                case 'html':
                    content = htmlEditor.getValue();
                    break;
                case 'css':
                    content = cssEditor.getValue();
                    break;
                case 'js':
                    content = jsEditor.getValue();
                    break;
            }
            socket.emit('content_change', {
                site_id: {{ site.id }},
                content_type: type,
                content: content,
                origin: changeObj.origin,
                from: changeObj.from,
                to: changeObj.to,
                text: changeObj.text
            });
        } else {
            clearTimeout(contentSyncTimeout);
            contentSyncTimeout = setTimeout(() => {
                let content;
                switch(type) {
                    case 'html':
                        content = htmlEditor.getValue();
                        break;
                    case 'css':
                        content = cssEditor.getValue();
                        break;
                    case 'js':
                        content = jsEditor.getValue();
                        break;
                }
                socket.emit('content_change', {
                    site_id: {{ site.id }},
                    content_type: type,
                    content: content
                });
                lastContentSyncTime = Date.now();
            }, 300);
        }
    }
}

// Set up change handlers for each editor
htmlEditor.on('change', function(instance, changeObj) {
    handleEditorChange('html', instance, changeObj);
});

cssEditor.on('change', function(instance, changeObj) {
    handleEditorChange('css', instance, changeObj);
});

jsEditor.on('change', function(instance, changeObj) {
    handleEditorChange('js', instance, changeObj);
});

// Set up input read handlers for autocomplete
htmlEditor.on('inputRead', function(cm, change) {
    if (change.origin !== 'complete' && change.text[0] !== ' ' && change.text[0] !== '\t') {
        CodeMirror.commands.autocomplete(cm, null, {completeSingle: false});
    }
});

cssEditor.on('inputRead', function(cm, change) {
    if (change.origin !== 'complete' && change.text[0] !== ' ' && change.text[0] !== '\t') {
        CodeMirror.commands.autocomplete(cm, null, {completeSingle: false});
    }
});

jsEditor.on('inputRead', function(cm, change) {
    if (change.origin !== 'complete' && change.text[0] !== ' ' && change.text[0] !== '\t') {
        CodeMirror.commands.autocomplete(cm, null, {completeSingle: false});
    }
});

// Connect undo/redo buttons to the current active editor
undoBtn.addEventListener('click', () => currentEditor.undo());
redoBtn.addEventListener('click', () => currentEditor.redo());

const preview = document.getElementById('preview');
let previewTimeout;

function updatePreview() {
    clearTimeout(previewTimeout);
    previewTimeout = setTimeout(() => {
        // Get content from all three editors
        const htmlContent = htmlEditor.getValue();
        const cssContent = cssEditor.getValue();
        const jsContent = jsEditor.getValue();
        
        // Combine the contents into a single HTML document
        const combinedContent = `
<!DOCTYPE html>
<html>
<head>
    <style>
        ${cssContent}
    </style>
</head>
<body>
    ${htmlContent}
    <script>
        ${jsContent}
    </script>
</body>
</html>`;
        
        preview.srcdoc = combinedContent;
    }, 300);
}

updatePreview();

function openDeployedSite() {
    const url = `https://hackclub.space/s/{{ site.slug }}`;
    window.open(url, '_blank');
}

function showDeployModal() {
    const deployModal = document.getElementById('deployModal');
    deployModal.style.display = 'flex';
    deployModal.offsetHeight;
    deployModal.classList.add('show');
}

// Make the function globally accessible
window.showDeployModal = showDeployModal;

// Function to show toast notifications
function showToast(type, message) {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <div class="toast-content">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
            <span>${message}</span>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
    `;
    
    const container = document.getElementById('toast-container') || document.body;
    container.appendChild(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (toast.parentElement) {
            toast.classList.add('fade-out');
            setTimeout(() => toast.remove(), 300);
        }
    }, 5000);
}

// Simple function to show the deploy modal with domain options
function deploySite() {
    // Just show the deploy modal with all domain options
    showDeployModal();
}

function closeDeployModal() {
    const deployModal = document.getElementById('deployModal');
    deployModal.classList.remove('show');
    setTimeout(() => {
        deployModal.style.display = 'none';
    }, 300);
}

function openAnalyticsModal() {
    const modal = document.getElementById('analyticsModal');
    modal.style.display = 'flex';
    modal.classList.add('show');

    loadSiteAnalytics();
}

function closeAnalyticsModal() {
    const modal = document.getElementById('analyticsModal');
    modal.classList.remove('show');
    setTimeout(() => {
        modal.style.display = 'none';
    }, 300);
}

// Global variables for collaboration
let lastContentSyncTime = 0;
let contentSyncTimeout = null;
let collaborationActive = false;
let socket = null;

function initializeCollaboration() {
    if (socket) {
        socket.disconnect();
    }

    socket = io();

    socket.on('connect', () => {
        console.log('Connected to Socket.IO server');
        socket.emit('join', { site_id: document.getElementById('site-id').value });
    });

    socket.on('disconnect', () => {
        console.log('Disconnected from Socket.IO server');
        collaborationActive = false;
        updateCollaborationStatus([]);
    });

    socket.on('user_joined', (data) => {
        console.log('User joined:', data);
        showToast('info', `${data.username} joined the session`);
        loadCollaborators();
    });

    socket.on('user_left', (data) => {
        console.log('User left:', data);
        showToast('info', `${data.username} left the session`);
        loadCollaborators();
        if (remoteCursors[data.user_id]) {
            remoteCursors[data.user_id].clear();
            delete remoteCursors[data.user_id];
        }
    });

    socket.on('cursor_update', (data) => {
        if (!collaborationActive) return;
        updateRemoteCursor(data);
    });

    socket.on('content_update', (data) => {
        if (!collaborationActive) return;
        handleRemoteContentUpdate(data);
    });
}

function updateRemoteCursor(data) {
    if (data.user_id === {{ current_user.id }}) return;

    if (!remoteCursors[data.user_id]) {
        const color = cursorColors[Object.keys(remoteCursors).length % cursorColors.length];
        remoteCursors[data.user_id] = {
            color: color,
            marker: null,
            clear: function() {
                if (this.marker) {
                    this.marker.clear();
                }
            }
        };
    }

    const cursor = remoteCursors[data.user_id];
    if (cursor.marker) {
        cursor.marker.clear();
    }

    if (data.selection) {
        cursor.marker = editor.markText(
            data.selection.from,
            data.selection.to,
            {
                css: `background-color: ${cursor.color}40`,
                title: data.username
            }
        );
    } else if (data.position) {
        const pos = editor.posFromIndex(data.position);
        cursor.marker = editor.setBookmark(pos, {
            widget: createCursorWidget(data.username, cursor.color)
        });
    }
}

function createCursorWidget(username, color) {
    const widget = document.createElement('div');
    widget.className = 'remote-cursor';
    widget.style.borderLeftColor = color;
    
    const label = document.createElement('span');
    label.className = 'remote-cursor-label';
    label.style.backgroundColor = color;
    label.textContent = username;
    widget.appendChild(label);
    
    return widget;
}

function handleRemoteContentUpdate(data) {
    if (data.user_id === {{ current_user.id }}) return;

    const cursor = editor.getCursor();
    const scrollInfo = editor.getScrollInfo();

    editor.operation(() => {
        if (data.origin === '+input' || data.origin === '+delete') {
            editor.replaceRange(data.text, data.from, data.to);
        } else {
            editor.setValue(data.content);
        }
    });

    editor.setCursor(cursor);
    editor.scrollTo(scrollInfo.left, scrollInfo.top);
}

document.addEventListener('DOMContentLoaded', function() {
    // Set up tab switching
    const htmlTab = document.getElementById('html-tab');
    const cssTab = document.getElementById('css-tab');
    const jsTab = document.getElementById('js-tab');
    
    const htmlEditorContainer = document.getElementById('html-editor-container');
    const cssEditorContainer = document.getElementById('css-editor-container');
    const jsEditorContainer = document.getElementById('js-editor-container');
    
    htmlTab.addEventListener('click', function() {
        setActiveTab('html');
        currentEditor = htmlEditor;
        htmlEditor.refresh();
    });
    
    cssTab.addEventListener('click', function() {
        setActiveTab('css');
        currentEditor = cssEditor;
        cssEditor.refresh();
    });
    
    jsTab.addEventListener('click', function() {
        setActiveTab('js');
        currentEditor = jsEditor;
        jsEditor.refresh();
    });
    
    function setActiveTab(tabName) {
        // Reset all tabs and containers
        [htmlTab, cssTab, jsTab].forEach(tab => tab.classList.remove('active'));
        [htmlEditorContainer, cssEditorContainer, jsEditorContainer].forEach(container => 
            container.classList.remove('active'));
        
        // Set active tab and container
        if (tabName === 'html') {
            htmlTab.classList.add('active');
            htmlEditorContainer.classList.add('active');
        } else if (tabName === 'css') {
            cssTab.classList.add('active');
            cssEditorContainer.classList.add('active');
        } else if (tabName === 'js') {
            jsTab.classList.add('active');
            jsEditorContainer.classList.add('active');
        }
    }
    
    // Initialize collaboration features
    initializeCollaboration();
    loadCollaborators();

    {% if site.site_type == 'web' %}
    const modal = document.getElementById('analyticsModal');
    const closeBtn = modal.querySelector('.close-btn');
    {% endif %}

    if (closeBtn) {
        closeBtn.addEventListener('click', closeAnalyticsModal);
    }

    window.addEventListener('click', (event) => {
        if (event.target === modal) {
            closeAnalyticsModal();
        }
    });

    const analyticsToggle = document.getElementById('analytics-toggle');
    if (analyticsToggle) {
        analyticsToggle.addEventListener('change', function() {
            toggleAnalytics(this.checked);
        });
    }

    const clearAnalyticsBtn = document.getElementById('clearAnalyticsBtn');
    if (clearAnalyticsBtn) {
        clearAnalyticsBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to clear all analytics data? This action cannot be undone.')) {
                clearAnalytics();
            }
        });
    }
});

async function loadSiteAnalytics() {
    try {
        const pathParts = window.location.pathname.split('/');
        const siteId = pathParts[pathParts.indexOf('edit') + 1];

        if (!siteId) {
            showToast('error', 'Could not determine site ID');
            return;
        }

        const response = await fetch(`/api/sites/${siteId}/analytics`);
        if (!response.ok) {
            throw new Error('Failed to fetch analytics data');
        }

        const data = await response.json();

        const analyticsToggle = document.getElementById('analytics-toggle');
        if (analyticsToggle) {
            analyticsToggle.checked = data.analytics_enabled;
        }

        updateViewCount(data.total_views);

    } catch (error) {
        console.error('Error loading analytics:', error);
        showToast('error', 'Failed to load analytics data');
    }
}

function updateViewCount(count) {
    const viewCountElement = document.querySelector('.analytics-count span');
    if (viewCountElement) {
        viewCountElement.textContent = count || 0;
    }
}

async function toggleAnalytics(enabled) {
    try {
        const pathParts = window.location.pathname.split('/');
        const siteId = pathParts[pathParts.indexOf('edit') + 1];

        if (!siteId) {
            showToast('error', 'Could not determine site ID');
            return;
        }

        const response = await fetch(`/api/sites/${siteId}/analytics/toggle`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ enabled })
        });

        if (!response.ok) {
            throw new Error('Failed to update analytics settings');
        }

        showToast('success', `Analytics ${enabled ? 'enabled' : 'disabled'} successfully`);

        loadSiteAnalytics();
    } catch (error) {
        console.error('Error toggling analytics:', error);
        showToast('error', 'Failed to update analytics settings');
    }
}

async function clearAnalytics() {
    try {
        const pathParts = window.location.pathname.split('/');
        const siteId = pathParts[pathParts.indexOf('edit') + 1];

        if (!siteId) {
            showToast('error', 'Could not determine site ID');
            return;
        }

        const response = await fetch(`/api/sites/${siteId}/analytics/clear`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error('Failed to clear analytics data');
        }

        showToast('success', 'Analytics data cleared successfully');

        loadSiteAnalytics();
    } catch (error) {
        console.error('Error clearing analytics:', error);
        showToast('error', 'Failed to clear analytics data');
    }
}

async function saveContent() {
    const saveBtn = document.getElementById('saveBtn');
    saveBtn.disabled = true;

    if ({{ 'true' if site.user_id != current_user.id else 'false' }}) {
        try {
            const content = editor.getValue();
            if (socket && socket.connected) {
                socket.emit('content_change', {
                    site_id: {{ site.id }},
                    content: content
                });
                if (!window.shownCollaboratorMessage) {
                    showToast('info', 'Changes shared with collaborators. Only the space owner can save permanently.');
                    window.shownCollaboratorMessage = true;
                }
            } else {
                showToast('warning', 'Not connected to collaboration server. Changes may not be visible to others.');
            }
        } catch (error) {
            showToast('error', 'An error occurred while syncing changes');
        } finally {
            saveBtn.disabled = false;
        }
        return;
    }

    try {
        const content = editor.getValue();
        const formData = new FormData();
        formData.append('html_content', content);

        const response = await fetch(`/site/update/{{ site.id }}`, {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            showToast('success', 'Changes saved successfully!');

            updatePreview();

            if (socket?.connected && collaborationActive) {
                socket.emit('content_change', {
                    site_id: {{ site.id }},
                    content: content
                });
            }
        } else {
            showToast('error', 'Failed to save changes');
        }
    } catch (error) {
        showToast('error', 'An error occurred while saving changes');
    } finally {
        saveBtn.disabled = false;
    }
}



function showToast(type, message) {
    const toastContainer = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;

    const icon = type === 'success' ? 'check-circle' : 'exclamation-circle';

    toast.innerHTML = `
        <div class="toast-content">
            <i class="fas fa-${icon}"></i>
            <span>${message}</span>
        </div>
    `;

    toastContainer.appendChild(toast);

    toast.offsetHeight;

    toast.classList.add('show');

    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function changeEditorTheme(theme) {
    if (theme !== 'eclipse' && theme !== 'default') {
        const themeLink = document.createElement('link');
        themeLink.rel = 'stylesheet';
        themeLink.href = `https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/${theme}.min.css`;
        document.head.appendChild(themeLink);
    }

    editor.setOption('theme', theme);
    localStorage.setItem('editorTheme', theme);
}

function changeEditorFontSize(size) {
    document.querySelector('.CodeMirror').style.fontSize = size;
    localStorage.setItem('editorFontSize', size);
}

function toggleWordWrap(enabled) {
    editor.setOption('lineWrapping', enabled);
    localStorage.setItem('editorWordWrap', enabled);
}

function toggleLinting(enabled) {
    if (enabled) {
        if ("{{ site.site_type }}" === "web") {
            loadScript('https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/lint.min.js')
            .then(() => loadScript('https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/html-lint.min.js'))
            .then(() => loadScript('https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/css-lint.min.js'))
            .then(() => loadScript('https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/javascript-lint.min.js'))
            .then(() => {
                loadCSS('https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/lint.min.css');
                editor.setOption('lint', true);
            });
        } else {
            loadScript('https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/lint.min.js')
            .then(() => loadScript('https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/python-lint.min.js'))
            .then(() => {
                loadCSS('https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/lint.min.css');
                editor.setOption('lint', true);
            });
        }
    } else {
        editor.setOption('lint', false);
    }
    localStorage.setItem('editorLint', enabled);
}

function loadScript(src) {
    return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
    });
}

function loadCSS(href) {
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = href;
    document.head.appendChild(link);
}

// Handle cursor activity for the current editor
htmlEditor.on('cursorActivity', function() {
    const cursor = htmlEditor.getCursor();
    updateCursorPosition(cursor);
});

cssEditor.on('cursorActivity', function() {
    const cursor = cssEditor.getCursor();
    updateCursorPosition(cursor);
});

jsEditor.on('cursorActivity', function() {
    const cursor = jsEditor.getCursor();
    updateCursorPosition(cursor);
});

function updateCursorPosition(cursor) {
    document.getElementById('cursorPosition').innerHTML = 
        `<i class="fas fa-map-marker-alt"></i> Line ${cursor.line + 1}, Column ${cursor.ch + 1}`;

    // Send cursor position to collaborators
    if (socket?.connected && collaborationActive) {
        const selection = editor.getSelection();
        if (selection && selection !== '') {
            const from = editor.getCursor('from');
            const to = editor.getCursor('to');
            socket.emit('cursor_move', {
                site_id: document.getElementById('site-id').value,
                selection: { from, to }
            });
        } else {
            socket.emit('cursor_move', {
                site_id: document.getElementById('site-id').value,
                position: editor.indexFromPos(cursor)
            });
        }
    }
});

function updateFileSize() {
    // Calculate combined size of all editors
    const htmlContent = htmlEditor.getValue();
    const cssContent = cssEditor.getValue();
    const jsContent = jsEditor.getValue();
    const combinedContent = htmlContent + cssContent + jsContent;
    const bytes = new Blob([combinedContent]).size;
    document.getElementById('fileSize').textContent = bytes;
}
// Set up change handlers for CSS and JS editors
cssEditor.on('change', function(instance, changeObj) {
    updatePreview();
    
    if (collaborationActive && socket?.connected && changeObj.origin !== 'remote') {
        clearTimeout(window.contentSyncTimeout);
        window.contentSyncTimeout = setTimeout(() => {
            syncContent('css', cssEditor.getValue());
        }, 500);
    }
});

jsEditor.on('change', function(instance, changeObj) {
    updatePreview();
    
    if (collaborationActive && socket?.connected && changeObj.origin !== 'remote') {
        clearTimeout(window.contentSyncTimeout);
        window.contentSyncTimeout = setTimeout(() => {
            syncContent('js', jsEditor.getValue());
        }, 500);
    }
});

// Update file size when any editor changes
htmlEditor.on('change', function(cm, changeObj) {
    updateFileSize();

    if (collaborationActive && socket?.connected && changeObj.origin !== 'remote') {
        clearTimeout(window.contentSyncTimeout);
        window.contentSyncTimeout = setTimeout(() => {
            socket.emit('content_change', {
                site_id: document.getElementById('site-id').value,
                content: cm.getValue(),
                origin: changeObj.origin,
                from: changeObj.from,
                to: changeObj.to,
                text: changeObj.text.join('\n')
            });
        }, 300); // Debounce content sync
    }
});
updateFileSize();

function showKeyboardShortcutsModal() {
    const modal = document.getElementById('keyboardShortcutsModal');
    modal.style.display = 'flex';
}

function closeKeyboardShortcutsModal() {
    document.getElementById('keyboardShortcutsModal').style.display = 'none';
}

function focusSearch() {
    CodeMirror.commands.findPersistent(editor);
}

// Toggle split view
function toggleSplitView() {
    document.querySelector('.editor-container').classList.toggle('split-layout');
    const isActive = document.querySelector('.editor-container').classList.contains('split-layout');
    document.getElementById('splitViewToggle').classList.toggle('active', isActive);
}

{% if site.site_type == 'web' %}
function formatCode() {
    let content = editor.getValue();

    let formattedContent = content
        .replace(/>\s*</g, '>\n<')
        .replace(/(<[^\/][^>]*>)(?!\s*<)/g, '$1\n')
        .replace(/(<\/[^>]+>)(?!\s*<)/g, '$1\n');

    const cursor = editor.getCursor();
    editor.setValue(formattedContent);
    editor.setCursor(cursor);
    showToast('success', 'Code formatted!');
}
{% elif site.site_type == 'python' %}
function formatPythonCode() {
    let content = editor.getValue();

    content = content.replace(/,([^\s])/g, ', $1');

    content = content.replace(/([^\s])([+\-*/%=<>!&|^])/g, '$1 $2');
    content = content.replace(/([+\-*/%=<>!&|^])([^\s=])/g, '$1 $2');

    const cursor = editor.getCursor();
    editor.setValue(content);
    editor.setCursor(cursor);
    showToast('success', 'Code formatted!');
}
{% endif %}

let collaborationTimeout;
let isOwner = {{ 'true' if site.user_id == current_user.id else 'false' }};
let isCollaborator = {{ 'true' if site.user_id != current_user.id else 'false' }};
let remoteCursors = {};
let cursorColors = ['#FF5722', '#2196F3', '#9C27B0', '#4CAF50', '#FFC107'];

function openCoopModal() {
    const modal = document.getElementById('coopModal');
    modal.style.display = 'flex';
    modal.offsetHeight;
    modal.classList.add('show');
    loadCollaborators();
}

function closeCoopModal() {
    const modal = document.getElementById('coopModal');
    modal.classList.remove('show');
    setTimeout(() => {
        modal.style.display = 'none';
    }, 300);
}

async function loadCollaborators() {
    const container = document.getElementById('collaboratorsContainer');
    if (!container) return;

    container.innerHTML = `<div class="loading-indicator">Loading collaborators...</div>`;

    try {
        const response = await fetch(`/api/sites/{{ site.id }}/collaborators`);
        if (response.ok) {
            const data = await response.json();
            renderCollaborators(data.collaborators);
            updateCollaborationStatus(data.active_collaborators);
        } else {
            container.innerHTML = `<div class="error-message">Failed to load collaborators</div>`;
        }
    } catch (error) {
        container.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
    }
}

function renderCollaborators(collaborators) {
    const container = document.getElementById('collaboratorsContainer');

    if (collaborators.length === 0) {
        container.innerHTML = `<div class="empty-state">No collaborators added yet</div>`;
        return;
    }

    const html = collaborators.map(collaborator => `
        <div class="collaborator-item">
            <div class="collaborator-info">
                <div class="collaborator-avatar" style="background-color: ${getRandomColor()}">
                    ${collaborator.username.charAt(0).toUpperCase()}
                </div>
                <div>
                    <div>${collaborator.username}</div>
                    <div class="collaborator-email">${collaborator.email}</div>
                </div>
            </div>
            <button class="remove-collab-btn" onclick="removeCollaborator(${collaborator.id})">
                <i class="fas fa-times"></i> Remove
            </button>
        </div>
    `).join('');

    container.innerHTML = html;
}

function updateCollaborationStatus(activeCollaborators) {
    const statusText = document.getElementById('coopStatusText');
    const activeCollaboratorsDiv = document.getElementById('activeCollaborators');
    const activeCollaboratorsList = document.getElementById('activeCollaboratorsList');

    if (activeCollaborators && activeCollaborators.length > 0) {
        if (statusText) {
            statusText.textContent = 'active';
            statusText.style.color = '#4CAF50';
        }
        collaborationActive = true;

        if (document.getElementById('quick-collab-status')) {
            document.getElementById('quick-collab-status').textContent = 'Connected';
            document.getElementById('collaborationStatusBtn').classList.add('active-collaboration');
        }

        if (collaborationTimeout) {
            clearTimeout(collaborationTimeout);
        }
        collaborationTimeout = setTimeout(() => {
            deactivateCollaboration();
        }, 30 * 60 * 1000); // 30 min (stop breaking my servers)

        activeCollaboratorsDiv.classList.remove('hidden');

        activeCollaboratorsList.innerHTML = activeCollaborators.map((collaborator, index) => `
            <li>
                <span class="collaborator-cursor" style="background-color: ${cursorColors[index % cursorColors.length]}"></span>
                ${collaborator.username}
            </li>
        `).join('');

        initializeCollaboration();
    } else {
        statusText.textContent = 'inactive';
        statusText.style.color = '#6c757d';
        collaborationActive = false;
        activeCollaboratorsDiv.classList.add('hidden');

        cleanupRemoteCursors();
    }
}

async function addCollaborator() {
    const email = document.getElementById('collaboratorEmail').value.trim();
    if (!email) return;

    try {
        const response = await fetch(`/api/sites/{{ site.id }}/collaborators`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email }),
        });

        if (response.ok) {
            showToast('success', 'Collaborator added successfully');
            document.getElementById('collaboratorEmail').value = '';
            loadCollaborators();
        } else {
            const data = await response.json();
            showToast('error', data.message || 'Failed to add collaborator');
        }
    } catch (error) {
        showToast('error', `Error: ${error.message}`);
    }
}

async function removeCollaborator(collaboratorId) {
    try {
        const response = await fetch(`/api/sites/{{ site.id }}/collaborators/${collaboratorId}`, {
            method: 'DELETE',
        });

        if (response.ok) {
            showToast('success', 'Collaborator removed');
            loadCollaborators();
        } else {
            const data = await response.json();
            showToast('error', data.message || 'Failed to remove collaborator');
        }
    } catch (error) {
        showToast('error', `Error: ${error.message}`);
    }
}

function initializeCollaboration() {
    if (!socket) {
        socket = io();

        socket.on('connect', function() {
            console.log('Socket.IO connection established');
            socket.emit('join', {
                site_id: {{ site.id }}
            });

            sendCursorPosition();

            collaborationActive = true;

            startInactivityTimer();

            if (document.getElementById('coopStatusText')) {
                document.getElementById('coopStatusText').textContent = '';
            }

            if (document.getElementById('quick-collab-status')) {
                document.getElementById('quick-collab-status').textContent = 'Collaborating';
            }

            clearInterval(window.cursorInterval);
            window.cursorInterval = setInterval(sendCursorPosition, 2000);
        });

        socket.on('disconnect', function() {
            console.log('Socket.IO connection closed');

            collaborationActive = false;

            if (document.getElementById('coopStatusText')) {
                document.getElementById('coopStatusText').textContent = '';
            }

            if (document.getElementById('quick-collab-status')) {
                document.getElementById('quick-collab-status').textContent = 'Disconnected';
            }

            cleanupRemoteCursors();
            clearInterval(window.cursorInterval);
            clearTimeout(window.inactivityTimer);

            if ({{ 'true' if site.user_id != current_user.id else 'false' }}) {
                localStorage.setItem('collaboration_message', 'You have been disconnected from the collaboration session.');
                window.location.href = '/welcome';
            } else {
                showToast('info', 'Disconnected from collaboration server, trying to reconnect...');
            }
        });

        socket.on('user_joined', function(user) {
            showToast('success', `${user.username} joined the collaboration`);
            loadCollaborators(); 
        });

        socket.on('user_left', function(user) {
            showToast('info', `${user.username} left the collaboration`);
            removeRemoteCursor(user.user_id || user.id);
            loadCollaborators(); 


            if (user.is_owner && {{ 'true' if site.user_id != current_user.id else 'false' }}) {
                showToast('warning', 'Site owner has left. You will be redirected to the welcome page.');
                localStorage.setItem('collaboration_message', 'The site owner left the collaboration session.');
                setTimeout(() => {
                    window.location.href = '/welcome';
                }, 2000);
            }
        });

        socket.on('owner_timeout', function() {
            if ({{ 'true' if site.user_id != current_user.id else 'false' }}) {
                showToast('info', 'This collaboration session has ended due to inactivity.');
                socket.emit('owner_timeout', { site_id: {{ site.id }} });
                deactivateCollaboration();
            } else {
                localStorage.setItem('collaboration_message', 'The collaboration session ended due to 30 minutes of inactivity.');
                setTimeout(() => {
                    window.location.href = '/welcome';
                }, 2000);
            }
        });

        socket.on('cursor_update', function(data) {
            const userId = data.user_id;
            const username = data.username;
            const cursorPosition = {
                line: data.line,
                ch: data.ch
            };

            const selection = data.selection;
            const editorType = data.content_type || 'html';

            let colorIndex = 0;
            for (let i = 0; i < cursorColors.length; i++) {
                if (remoteCursors[`${userId}-${editorType}`] && remoteCursors[`${userId}-${editorType}`].colorIndex === i) {
                    colorIndex = i;
                    break;
                } else if (!Object.values(remoteCursors).some(c => c.colorIndex === i)) {
                    colorIndex = i;
                    break;
                }
            }

            updateRemoteCursor(userId, username, cursorPosition, colorIndex, selection, editorType);
        });

        socket.on('content_update', function(data) {
            if (data.user_id !== {{ current_user.id }}) {
                let targetEditor;
                let cursor;
                let scrollInfo;
                
                // Determine which editor to update based on content_type
                switch(data.content_type) {
                    case 'html':
                        targetEditor = htmlEditor;
                        break;
                    case 'css':
                        targetEditor = cssEditor;
                        break;
                    case 'js':
                        targetEditor = jsEditor;
                        break;
                    default:
                        // Legacy support - assume HTML if no content type specified
                        targetEditor = htmlEditor;
                        break;
                }
                
                cursor = targetEditor.getCursor();
                scrollInfo = targetEditor.getScrollInfo();

                const oldContent = targetEditor.getValue();
                const oldLines = oldContent.split('\n');

                if (data.content) {
                    if (targetEditor.off) {
                        targetEditor.off('cursorActivity', sendCursorPosition);
                    }

                    const isActivelyEditing = targetEditor.somethingSelected();

                    if (!isActivelyEditing) {
                        try {
                            if (oldContent !== data.content) {
                                const newLines = data.content.split('\n');
                                const newLineCount = newLines.length;
                                const oldLineCount = oldLines.length;

                                let lineMapping = new Map();

                                for (let i = 0; i < oldLineCount; i++) {
                                    const oldLine = oldLines[i].trim();
                                    if (oldLine.length < 3) continue; 

                                    let bestMatch = -1;
                                    let bestScore = 0;

                                    for (let j = 0; j < newLineCount; j++) {
                                        const newLine = newLines[j].trim();
                                        if (newLine === oldLine) {
                                            bestMatch = j;
                                            break;
                                        }

                                        if (newLine.includes(oldLine) || oldLine.includes(newLine)) {
                                            const score = Math.min(oldLine.length, newLine.length) / 
                                                          Math.max(oldLine.length, newLine.length);
                                            if (score > 0.7 && score > bestScore) { 
                                                bestScore = score;
                                                bestMatch = j;
                                            }
                                        }
                                    }

                                    if (bestMatch >= 0) {
                                        lineMapping.set(i, bestMatch);
                                    }
                                }


                                let newLine = cursor.line;
                                if (lineMapping.has(cursor.line)) {
                                    newLine = lineMapping.get(cursor.line);
                                } else {

                                    for (let i = 1; i <= 5; i++) { 
                                        if (lineMapping.has(cursor.line - i)) {
                                            newLine = lineMapping.get(cursor.line - i) + i;
                                            break;
                                        } else if (lineMapping.has(cursor.line + i)) {
                                            newLine = lineMapping.get(cursor.line + i) - i;
                                            break;
                                        }
                                    }
                                }

                                newLine = Math.max(0, Math.min(newLine, newLineCount - 1));

                                let newCh = cursor.ch;
                                if (newLine < newLineCount) {
                                    const oldLineContent = oldLines[cursor.line] || '';
                                    const newLineContent = newLines[newLine] || '';

                                    if (cursor.ch >= oldLineContent.length - 1) {
                                        newCh = newLineContent.length;
                                    } else {
                                        newCh = Math.min(cursor.ch, newLineContent.length);
                                    }
                                }

                                targetEditor.operation(() => {
                                    const prevChangeHandler = targetEditor._handlers.change;
                                    targetEditor._handlers.change = [];

                                    targetEditor.setValue(data.content);

                                    targetEditor._handlers.change = prevChangeHandler;
                                });

                                targetEditor.setCursor({line: newLine, ch: newCh});
                                targetEditor.scrollTo(scrollInfo.left, scrollInfo.top);
                            }
                        } catch (err) {
                            console.error('Error merging content:', err);
                            showToast('error', 'Failed to merge changes. You may need to refresh.');
                        }
                    } else {
                        window.pendingChanges = {
                            content: data.content,
                            type: data.content_type || 'html'
                        };
                        showToast('info', 'New changes available. Finish your edit or press Esc to apply them.');

                        const selectionHandler = function() {
                            if (window.pendingChanges && !targetEditor.somethingSelected()) {
                                const pendingContent = window.pendingChanges.content;
                                window.pendingChanges = null;

                                targetEditor.operation(() => {
                                    const prevChangeHandler = targetEditor._handlers.change;
                                    targetEditor._handlers.change = [];
                                    targetEditor.setValue(pendingContent);
                                    targetEditor._handlers.change = prevChangeHandler;
                                });

                                targetEditor.off('cursorActivity', selectionHandler);
                            }
                        };

                        targetEditor.on('cursorActivity', selectionHandler);
                    }

                    setTimeout(() => {
                        if (targetEditor.on) {
                            // Set up the appropriate cursor activity handler based on editor type
                            if (targetEditor === htmlEditor) {
                                targetEditor.on('cursorActivity', debounce(() => sendCursorPosition('html'), 300));
                            } else if (targetEditor === cssEditor) {
                                targetEditor.on('cursorActivity', debounce(() => sendCursorPosition('css'), 300));
                            } else if (targetEditor === jsEditor) {
                                targetEditor.on('cursorActivity', debounce(() => sendCursorPosition('js'), 300));
                            }
                        }
                    }, 200);
                }
            }
        });

        // Set up cursor activity for all editors
        htmlEditor.on('cursorActivity', debounce(() => sendCursorPosition('html'), 300));
        cssEditor.on('cursorActivity', debounce(() => sendCursorPosition('css'), 300));
        jsEditor.on('cursorActivity', debounce(() => sendCursorPosition('js'), 300));

        window.addEventListener('resize', debounce(function() {
            Object.keys(remoteCursors).forEach(userId => {
                const cursorInfo = remoteCursors[userId];
                if (cursorInfo && cursorInfo.position) {
                    updateRemoteCursor(
                        userId, 
                        cursorInfo.label && cursorInfo.label.textContent, 
                        cursorInfo.position, 
                        cursorInfo.colorIndex,
                        cursorInfo.editorType || 'html'
                    );
                }
            });
            resetInactivityTimer();
        }, 100));

        // Add scroll event handlers for all editors
        htmlEditor.on('scroll', debounce(function() {
            updateRemoteCursorsOnScroll('html');
        }, 50));
        
        cssEditor.on('scroll', debounce(function() {
            updateRemoteCursorsOnScroll('css');
        }, 50));
        
        jsEditor.on('scroll', debounce(function() {
            updateRemoteCursorsOnScroll('js');
        }, 50));
        
        function updateRemoteCursorsOnScroll(editorType) {
            Object.keys(remoteCursors).forEach(userId => {
                const cursorInfo = remoteCursors[userId];
                if (cursorInfo && cursorInfo.position && cursorInfo.editorType === editorType) {
                    updateRemoteCursor(
                        userId, 
                        cursorInfo.label && cursorInfo.label.textContent, 
                        cursorInfo.position, 
                        cursorInfo.colorIndex,
                        editorType
                    );
                }
            });
        }

        window.addEventListener('beforeunload', function() {
            if (socket && socket.connected) {
                socket.emit('leave', { site_id: {{ site.id }} });
            }
        });
    }
}

function sendCursorPosition(type) {
    if (socket?.connected && collaborationActive) {
        let cursor;
        let targetEditor;
        
        // Determine which editor to get cursor position from
        switch(type) {
            case 'html':
                targetEditor = htmlEditor;
                break;
            case 'css':
                targetEditor = cssEditor;
                break;
            case 'js':
                targetEditor = jsEditor;
                break;
            default:
                // Default to current active editor if type not specified
                targetEditor = currentEditor;
                break;
        }
        
        cursor = targetEditor.getCursor();

        const hasSelection = targetEditor.somethingSelected();
        const selection = hasSelection ? {
            from: targetEditor.getCursor('from'),
            to: targetEditor.getCursor('to'),
            text: targetEditor.getSelection()
        } : null;

        socket.emit('cursor_move', {
            site_id: {{ site.id }},
            cursor: {
                line: cursor.line,
                ch: cursor.ch,
                hasSelection: hasSelection,
                selection: selection
            }
        });

        Object.keys(remoteCursors).forEach(userId => {
            if (remoteCursors[userId] && remoteCursors[userId].position) {
                updateRemoteCursor(
                    userId,
                    remoteCursors[userId].label.textContent,
                    remoteCursors[userId].position,
                    remoteCursors[userId].colorIndex,
                    remoteCursors[userId].selection
                );
            }
        });
    }
}

function handleCollaborationEvent(data) {
    console.log('Custom collaboration event:', data);
}

function updateRemoteCursor(userId, username, position, colorIndex, selection) {
    removeRemoteCursor(userId);

    const cursorCoords = editor.charCoords(position, 'window');
    const editorWrapper = editor.getWrapperElement();
    const editorRect = editorWrapper.getBoundingClientRect();

    const relativeLeft = cursorCoords.left - editorRect.left;
    const relativeTop = cursorCoords.top - editorRect.top;

    const cursorEl = document.createElement('div');
    cursorEl.className = 'remote-cursor';
    cursorEl.style.height = '18px';
    cursorEl.style.width = '2px';
    cursorEl.style.backgroundColor = cursorColors[colorIndex % cursorColors.length];
    cursorEl.style.position = 'absolute';
    cursorEl.style.zIndex = '1000';
    cursorEl.style.pointerEvents = 'none';
    cursorEl.style.left = `${relativeLeft}px`;
    cursorEl.style.top = `${relativeTop}px`;
    cursorEl.style.animation = 'blink 1s infinite';
    cursorEl.style.transition = 'all 0.1s ease-out';

    const labelEl = document.createElement('div');
    labelEl.className = 'cursor-label';
    labelEl.textContent = username;
    labelEl.style.position = 'absolute';
    labelEl.style.zIndex = '1000';
    labelEl.style.padding = '2px 5px';
    labelEl.style.fontSize = '12px';
    labelEl.style.borderRadius = '3px';
    labelEl.style.color = 'white';
    labelEl.style.pointerEvents = 'none';
    labelEl.style.backgroundColor = cursorColors[colorIndex % cursorColors.length];
    labelEl.style.left = `${relativeLeft}px`;
    labelEl.style.top = `${relativeTop - 20}px`;
    labelEl.style.boxShadow = '0 1px 3px rgba(0,0,0,0.3)';
    labelEl.style.transition = 'all 0.1s ease-out';

    const cmContainer = document.querySelector('.CodeMirror');
    cmContainer.appendChild(cursorEl);
    cmContainer.appendChild(labelEl);

    let selectionMarkers = [];

    if (selection && selection.from && selection.to) {
        const selectColor = cursorColors[colorIndex % cursorColors.length];
        const selectColorWithAlpha = selectColor.replace(/rgb\(([^)]+)\)/, 'rgba($1, 0.2)').replace(/#([0-9a-f]{6})/i, 'rgba($1, 0.2)');

        selectionMarkers.push(
            editor.markText(
                selection.from,
                selection.to,
                {
                    css: `background-color: ${selectColorWithAlpha}; border: 1px solid ${selectColor};`,
                    className: `remote-selection-${userId}`
                }
            )
        );
    }

    remoteCursors[userId] = { 
        cursor: cursorEl, 
        label: labelEl, 
        colorIndex: colorIndex,
        position: position,
        selection: selection,
        selectionMarkers: selectionMarkers
    };
}

function removeRemoteCursor(userId) {
    if (remoteCursors[userId]) {
        const cmContainer = document.querySelector('.CodeMirror');

        if (remoteCursors[userId].cursor && remoteCursors[userId].cursor.parentNode) {
            cmContainer.removeChild(remoteCursors[userId].cursor);
        }

        if (remoteCursors[userId].label && remoteCursors[userId].label.parentNode) {
            cmContainer.removeChild(remoteCursors[userId].label);
        }

        if (remoteCursors[userId].selectionMarkers) {
            remoteCursors[userId].selectionMarkers.forEach(marker => {
                if (marker && marker.clear) marker.clear();
            });
        }

        delete remoteCursors[userId];
    }
}

function cleanupRemoteCursors() {
    Object.keys(remoteCursors).forEach(userId => {
        removeRemoteCursor(userId);
    });
    remoteCursors = {};
    console.log('Cleaned up all remote cursors');
}

function deactivateCollaboration() {
    collaborationActive = false;

    if (document.getElementById('coopStatusText')) {
        document.getElementById('coopStatusText').textContent = '';
    }

    if (document.getElementById('activeCollaborators')) {
        document.getElementById('activeCollaborators').classList.add('hidden');
    }

    if (document.getElementById('quick-collab-status')) {
        document.getElementById('quick-collab-status').textContent = 'Disconnected';
    }

    cleanupRemoteCursors();
    clearInterval(window.cursorInterval);
    clearTimeout(window.inactivityTimer);

    if (socket) {
        socket.emit('leave', { site_id: {{ site.id }} });
        socket.close();
        socket = null;
    }

    if ({{ 'true' if site.user_id != current_user.id else 'false' }}) {
        localStorage.setItem('collaboration_message', 'The collaboration session has ended.');
        window.location.href = '/welcome';
    } else {
        showToast('info', 'Collaboration session ended');
    }
}

function startInactivityTimer() {
    clearTimeout(window.inactivityTimer);

    window.inactivityTimer = setTimeout(() => {
        if (collaborationActive) {
            if ({{ 'false' if site.user_id != current_user.id else 'true' }}) {
                showToast('info', 'Collaboration session timed out after 30 minutes of inactivity');
                socket.emit('owner_timeout', { site_id: {{ site.id }} });
                deactivateCollaboration();
            } else {
                localStorage.setItem('collaboration_message', 'The collaboration session timed out after 30 minutes of inactivity.');
                window.location.href = '/welcome';
            }
        }
    }, 1800000); 
}

function resetInactivityTimer() {
    if (collaborationActive) {
        startInactivityTimer();
    }
}

function setupInactivityMonitoring() {
    ['keydown', 'mousedown', 'mousemove', 'click', 'scroll', 'touchstart'].forEach(eventName => {
        document.addEventListener(eventName, debounce(resetInactivityTimer, 60000));
    });
}

function getRandomColor() {
    const colors = ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#9C27B0', '#00ACC1', '#FF7043'];
    return colors[Math.floor(Math.random() * colors.length)];
}

function debounce(func, wait) {
    let timeout;
    return function(...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), wait);
    };
}

const style = document.createElement('style');
style.textContent = `
    /* Animation for remote cursors */
    @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* Remote selection styling */
    .remote-selection {
        position: absolute;
        background-color: rgba(255, 165, 0, 0.2);
        border: 1px solid rgba(255, 165, 0, 0.5);
        pointer-events: none;
        z-index: 2;
    }

    /* Collaborator styling */
    .remove-collab-btn {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        background-color: var(--primary);
        color: white;
        border: none;
        border-radius: 4px;
        padding: 5px 10px;
        font-size: 0.8rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .remove-collab-btn:hover {
        background-color: #d32f2f;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .remove-collab-btn i {
        font-size: 0.8rem;
    }

    .active-collaboration {
        background-color: #4CAF50 !important;
    }

    .collaborator-item {
        background-color: #f8f9fa;
        border-radius: 6px;
        padding: 10px;
        margin-bottom: 10px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transition: all 0.2s ease;
    }

    .collaborator-item:hover {
        box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }

    .collaborator-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
    }

    #activeCollaboratorsList {
        list-style: none;
        padding: 0;
        margin: 10px 0;
    }

    #activeCollaboratorsList li {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 5px 0;
    }

    .active-collaborator-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: #4CAF50;
        display: inline-block;
        margin-right: 5px;
    }

    .remote-cursor {
        position: absolute;
        height: 18px;
        width: 2px;
        z-index: 1000;
        animation: blink 1s ease infinite;
        pointer-events: none;
    }
    .cursor-label {
        position: absolute;
        font-size: 12px;
        border-radius: 3px;
        padding: 2px 5px;
        color: white;
        z-index: 1000;
        pointer-events: none;
    }
    @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
`;
document.head.appendChild(style);

document.addEventListener('DOMContentLoaded', function() {
    const savedTheme = localStorage.getItem('editorTheme');
    if (savedTheme) {
        document.getElementById('themeSelector').value = savedTheme;
        changeEditorTheme(savedTheme);
    }

    const savedFontSize = localStorage.getItem('editorFontSize');
    if (savedFontSize) {
        document.getElementById('fontSizeSelector').value = savedFontSize;
        changeEditorFontSize(savedFontSize);
    }

    const savedWordWrap = localStorage.getItem('editorWordWrap');
    if (savedWordWrap !== null) {
        const isWrapped = savedWordWrap === 'true';
        document.getElementById('wordWrapToggle').checked = isWrapped;
        toggleWordWrap(isWrapped);
    }

    const splitViewToggle = document.getElementById('splitViewToggle');
    splitViewToggle.style.position = 'fixed';
    splitViewToggle.style.right = '20px';
    splitViewToggle.style.bottom = '20px';
    splitViewToggle.style.zIndex = '100';
    splitViewToggle.style.backgroundColor = 'var(--primary)';
    splitViewToggle.style.color = 'white';
    splitViewToggle.style.width = '40px';
    splitViewToggle.style.height = '40px';
    splitViewToggle.style.borderRadius = '50%';
    splitViewToggle.style.display = 'flex';
    splitViewToggle.style.alignItems = 'center';
    splitViewToggle.style.justifyContent = 'center';
    splitViewToggle.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
    splitViewToggle.style.cursor = 'pointer';
});

document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        saveContent();
    }
    {% if site.site_type == 'python' %}
    else if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        runCode();
    }
    {% endif %}
});
</script>

{% if site.site_type == 'web' %}
<div id="githubModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fab fa-github"></i> GitHub Integration</h2>
            <button class="close-button" onclick="closeGitHubModal()">&times;</button>
        </div>
        <div id="githubModalBody" class="modal-body">
        </div>
    </div>
</div>
{% endif %}

{% if additional_scripts %}
{{ additional_scripts|safe }}
{% endif %}

<div id="orphy-widget" class="orphy-widget">
    <div class="orphy-container">
        <div class="orphy-header" id="orphy-header">
            <div class="orphy-title">
                <h2>Orphy <span class="orphy-emoji">🦖</span></h2>
            </div>
            <button class="orphy-close-btn" onclick="closeOrphyChat()">&times;</button>
        </div>
        <div class="orphy-chat">
            <div class="orphy-messages" id="orphyMessages"></div>
        </div>
        <div class="orphy-input">
            <textarea id="orphyInput" placeholder="Ask Orphy a question about your code..." rows="2"></textarea>
            <button class="orphy-send-btn" onclick="sendOrphyMessage()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
</div>

<script>
    // Orphy AI Chat Widget Functionality
    const orphyWidget = document.getElementById('orphy-widget');
    const orphyMessages = document.getElementById('orphyMessages');
    const orphyInput = document.getElementById('orphyInput');
    const orphyHeader = document.getElementById('orphy-header');
    let isThinking = false;
    
    // Initialize the widget with a welcome message
    document.addEventListener('DOMContentLoaded', function() {
        // Add Orphy chat open button to toolbar
        const toolbar = document.querySelector('.editor-toolbar');
        if (toolbar) {
            const orphyButton = document.createElement('button');
            orphyButton.className = 'toolbar-button';
            orphyButton.setAttribute('title', 'Ask Orphy AI Assistant');
            orphyButton.innerHTML = '<i class="fas fa-robot"></i>';
            orphyButton.onclick = openOrphyChat;
            toolbar.appendChild(orphyButton);
        }
        
        // Add welcome message to chat
        displayOrphyMessage('assistant', "👋 Hi there! I'm Orphy, your coding assistant. Ask me anything about your code or for suggestions to improve it!");
    });

    // Open the Orphy chat widget
    function openOrphyChat() {
        // Make widget visible by adding active class
        orphyWidget.classList.add('active');
        
        // Initialize draggable functionality
        makeOrphyDraggable();
        
        // Focus the input field for immediate typing
        orphyInput.focus();
        
        // Scroll to the latest message using the helper function
        scrollOrphyToBottom();
        
        // Ensure the Orphy container is visible by setting a default position
        // This is needed because we're now using absolute positioning
        const container = orphyWidget.querySelector('.orphy-container');
        
        // Center the widget in the viewport initially if not already positioned
        if (!container.style.left || container.style.left === '0px') {
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const containerWidth = container.offsetWidth;
            const containerHeight = container.offsetHeight;
            
            // Position in center-right of viewport
            const leftPos = Math.max(20, viewportWidth - containerWidth - 40);
            const topPos = Math.max(20, (viewportHeight - containerHeight) / 2);
            
            container.style.left = leftPos + 'px';
            container.style.top = topPos + 'px';
        }
    }

    // Close the Orphy chat widget
    function closeOrphyChat() {
        orphyWidget.classList.remove('active');
    }

    // Completely rebuilt dragging functionality for Orphy widget
    function makeOrphyDraggable() {
        const container = orphyWidget.querySelector('.orphy-container');
        const orphyHeader = orphyWidget.querySelector('.orphy-header');
        
        // Position tracking variables
        let pos = { left: 0, top: 0 };
        let offset = { x: 0, y: 0 };
        
        // Apply position directly without transform for better performance
        function setPosition(left, top) {
            pos.left = left;
            pos.top = top;
            
            // Apply position with direct style properties
            container.style.left = pos.left + 'px';
            container.style.top = pos.top + 'px';
        }
        
        // Initialize the container's position if not already set
        if (!container.style.left || !container.style.top) {
            // Get the current position from CSS or default position
            const rect = container.getBoundingClientRect();
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            // Use existing position or calculate a default position (top-right area)
            const left = rect.left || Math.max(20, viewportWidth - container.offsetWidth - 50);
            const top = rect.top || Math.max(60, viewportHeight / 5);
            
            setPosition(left, top);
        }
        
        // Start dragging
        function onMouseDown(e) {
            // Only allow dragging from the header
            if (e.target !== orphyHeader && !orphyHeader.contains(e.target)) return;
            
            e.preventDefault();
            
            // Calculate the offset from the mouse position to the container position
            const rect = container.getBoundingClientRect();
            offset.x = e.clientX - rect.left;
            offset.y = e.clientY - rect.top;
            
            // Add dragging class for visual feedback
            container.classList.add('dragging');
            
            // Add event listeners for dragging and releasing
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }
        
        // Handle dragging
        function onMouseMove(e) {
            e.preventDefault();
            
            // Calculate new position
            const left = e.clientX - offset.x;
            const top = e.clientY - offset.y;
            
            // Ensure the widget stays within viewport boundaries
            const maxLeft = window.innerWidth - container.offsetWidth;
            const maxTop = window.innerHeight - container.offsetHeight;
            
            // Apply the new position with boundary constraints
            setPosition(
                Math.max(0, Math.min(left, maxLeft)),
                Math.max(0, Math.min(top, maxTop))
            );
        }
        
        // End dragging
        function onMouseUp() {
            // Remove event listeners
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            
            // Remove dragging class
            container.classList.remove('dragging');
        }
        
        // Attach the mousedown event to the header
        orphyHeader.addEventListener('mousedown', onMouseDown);
    }

    // Rate limiting for Orphy requests
    let lastOrphyRequest = 0;
    const ORPHY_RATE_LIMIT = 500; // 500ms between requests

    // Send a message to Orphy - using different AI providers with fallback
    function sendOrphyMessage() {
        const message = orphyInput.value.trim();
        if (!message || isThinking) return;

        // Check rate limit
        const now = Date.now();
        if (now - lastOrphyRequest < ORPHY_RATE_LIMIT) {
            showToast('warning', 'Please wait a moment before sending another message');
            return;
        }
        lastOrphyRequest = now;

        displayOrphyMessage('user', message);
        
        // Clear input and resize
        orphyInput.value = '';
        resizeTextarea(orphyInput);

        // Show thinking indicator
        isThinking = true;
        const thinkingId = showThinkingIndicator();

        // Get current file content
        const editorContent = editor.getValue();
        const filename = document.querySelector('.topbar-left h1').textContent;

        // Send to our server endpoint - server will handle the API calls with fallbacks
        fetch('/api/orphy/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: message,
                code: editorContent,
                filename: filename
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Server error: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Remove thinking indicator
            removeThinkingIndicator(thinkingId);
            isThinking = false;
            
            // Display the AI's response without showing which provider was used
            displayOrphyMessage('assistant', data.response);
        })
        .catch(error => {
            console.error('Error communicating with Orphy:', error);
            
            // Remove thinking indicator
            removeThinkingIndicator(thinkingId);
            isThinking = false;
            
            // Provide fallback response
            displayOrphyMessage('assistant', `🤔 Hmm, I'm having a bit of trouble right now. Please try again in a moment.`);
        })
        .finally(() => {
            // Scroll to the bottom of the chat
            orphyMessages.scrollTop = orphyMessages.scrollHeight;
        });
    }

    // Add a message to the chat
    function displayOrphyMessage(role, message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `orphy-message orphy-${role}`;
        messageDiv.id = `orphy-msg-${Date.now()}`; // Add unique ID for targeting
        
        // Convert markdown to HTML for Orphy's messages
        if (role === 'assistant') {
            // Parse markdown and handle code blocks
            let htmlContent = message
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/```(.*?)\n([\s\S]*?)```/g, '<pre><code class="$1">$2</code></pre>')
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');

            messageDiv.innerHTML = `<div class="orphy-message-content">${htmlContent}</div>`;
            
            // For code blocks, add syntax highlighting if available
            if (window.hljs) {
                messageDiv.querySelectorAll('pre code').forEach(block => {
                    window.hljs.highlightElement(block);
                });
            }
        } else {
            // Simple text for user messages
            messageDiv.innerHTML = `<div class="orphy-message-content">${message}</div>`;
        }
        
        orphyMessages.appendChild(messageDiv);
        
        // First attempt - use the robust scroll function
        scrollOrphyToBottom();
        
        // Second approach - directly scroll this specific message into view
        // with increasing delays to ensure content has rendered
        [50, 150, 300, 600].forEach(delay => {
            setTimeout(() => {
                try {
                    // Force scroll the chat container
                    const chatContainer = document.querySelector('.orphy-chat');
                    const messagesContainer = document.querySelector('.orphy-messages');
                    
                    if (chatContainer) chatContainer.scrollTop = chatContainer.scrollHeight;
                    if (messagesContainer) messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    
                    // Direct scroll to this specific message
                    messageDiv.scrollIntoView({block: 'end', behavior: 'auto'});
                    console.log(`Scrolled message into view (${delay}ms):`, messageDiv.id);
                } catch (error) {
                    console.error(`Error scrolling at ${delay}ms:`, error);
                }
            }, delay);
        });
    }
    
    // Debug-focused method to force scrolling the chat to the bottom with multiple approaches
    function scrollOrphyToBottom() {
        // Exit early if the messages element doesn't exist
        if (!orphyMessages) {
            console.log('Orphy messages element not found');
            return;
        }
        
        // Get chat container and the orphy-chat element
        const chatContainer = document.querySelector('.orphy-chat');
        const messagesContainer = document.querySelector('.orphy-messages');
        
        if (!chatContainer || !messagesContainer) {
            console.log('Chat container elements not found');
            return;
        }
        
        // Attempt multiple scroll methods at different times to ensure one works
        // First immediate attempt
        try {
            // Method 1: Direct scrollTop setting
            chatContainer.scrollTop = chatContainer.scrollHeight;
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            orphyMessages.scrollTop = orphyMessages.scrollHeight;
            
            // Method 2: Using Element.scrollIntoView
            const messages = messagesContainer.querySelectorAll('.orphy-message');
            if (messages.length > 0) {
                const lastMessage = messages[messages.length - 1];
                lastMessage.scrollIntoView({block: 'end', inline: 'nearest'});
            }
            
            console.log('Initial scroll attempt completed');
        } catch (error) {
            console.error('Error during initial scroll attempt:', error);
        }
        
        // Schedule multiple delayed scroll attempts to ensure messages have rendered
        [50, 100, 250, 500, 1000].forEach(delay => {
            setTimeout(() => {
                try {
                    // Try all scrolling methods again
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    orphyMessages.scrollTop = orphyMessages.scrollHeight;
                    
                    const messages = messagesContainer.querySelectorAll('.orphy-message');
                    if (messages.length > 0) {
                        const lastMessage = messages[messages.length - 1];
                        lastMessage.scrollIntoView({block: 'end', inline: 'nearest'});
                    }
                    
                    console.log(`Scroll attempt at ${delay}ms completed`);
                } catch (error) {
                    console.error(`Error during scroll attempt at ${delay}ms:`, error);
                }
            }, delay);
        });
    }
    
    // Show the thinking indicator with animated dots
    function showThinkingIndicator() {
        const id = 'thinking-' + Date.now();
        const thinkingDiv = document.createElement('div');
        thinkingDiv.id = id;
        thinkingDiv.className = 'orphy-message orphy-assistant';
        thinkingDiv.innerHTML = `
            <div class="orphy-message-content">
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        `;
        orphyMessages.appendChild(thinkingDiv);
        // Use the scroll helper function with a small delay to ensure DOM update completes
        setTimeout(() => {
            scrollOrphyToBottom();
        }, 10);
        return id;
    }
    
    // Remove the thinking indicator
    function removeThinkingIndicator(id) {
        const thinkingElement = document.getElementById(id);
        if (thinkingElement) {
            thinkingElement.remove();
            // Ensure scroll to bottom happens after the thinking indicator is removed
            setTimeout(() => {
                scrollOrphyToBottom();
            }, 10);
        }
    }
    
    // Auto-resize textarea as user types
    function resizeTextarea(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
    }
    
    // Auto-resize the textarea as user types
    orphyInput.addEventListener('input', function() {
        resizeTextarea(this);
    });
    
    // Handle Enter key to send message (Shift+Enter for new line)
    orphyInput.addEventListener('keydown', function(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendOrphyMessage();
        }
    });
    
    // Add keyboard shortcut to open Orphy (Ctrl+Shift+O)
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.shiftKey && e.key === 'O') {
            e.preventDefault();
            openOrphyChat();
        }
    });
    
    // Initialize the chat widget
    document.addEventListener('DOMContentLoaded', function() {
        // Set initial height of textarea
        resizeTextarea(orphyInput);
    });
</script>

{% endif %}
{% endblock %}