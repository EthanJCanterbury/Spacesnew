{% extends "base.html" %}

{% block head %}
<title>Account Settings - Hack Club Spaces</title>
<link rel="stylesheet" href="{{ url_for('static', filename='css/unified.css') }}">
{% endblock %}

{% block content %}
<div class="settings-container">
    <div class="settings-header text-center">
        <h1>Account Settings</h1>
        <p class="settings-subtitle">Manage your profile, integrations, and security</p>
    </div>

    <div class="settings-grid">
        <!-- Integrations Card -->
        <div class="settings-card">
            <div class="card-icon">
                <i class="fas fa-plug"></i>
            </div>
            <h2>Integrations</h2>
            <p class="integrations-description">
                Connect your favorite services like GitHub, Hackatime, and Groq to enhance your development experience.
            </p>
            <div class="integrations-cta">
                <a href="{{ url_for('integrations') }}" class="btn-gradient full-width">
                    <i class="fas fa-cog"></i>
                    Manage Integrations
                </a>
            </div>
        </div>

        <!-- Profile Information Card -->
        <div class="settings-card">
            <div class="card-icon">
                <i class="fas fa-user"></i>
            </div>
            <h2>Profile Information</h2>
            <form id="profile-form" class="settings-form">
                <input type="hidden" name="action" value="update_profile">
                <div class="form-group">
                    <label for="username">
                        <i class="fas fa-user-tag"></i>
                        Username
                    </label>
                    <input type="text" id="username" name="username" value="{{ current_user.username }}" required>
                </div>
                <div class="form-group">
                    <label for="email">
                        <i class="fas fa-envelope"></i>
                        Email
                    </label>
                    <input type="email" id="email" name="email" value="{{ current_user.email }}" required>
                </div>
                <button type="submit" class="btn-gradient full-width">
                    <i class="fas fa-save"></i>
                    Update Profile
                </button>
            </form>
        </div>

        <!-- Security Settings Card -->
        <div class="settings-card">
            <div class="card-icon">
                <i class="fas fa-lock"></i>
            </div>
            <h2>Security Settings</h2>
            <form id="password-form" class="settings-form">
                <input type="hidden" name="action" value="change_password">
                <div class="form-group">
                    <label for="current-password">
                        <i class="fas fa-key"></i>
                        Current Password
                    </label>
                    <input type="password" id="current-password" name="current_password" required>
                </div>
                <div class="form-group">
                    <label for="new-password">
                        <i class="fas fa-lock"></i>
                        New Password
                    </label>
                    <input type="password" id="new-password" name="new_password" required>
                </div>
                <div class="form-group">
                    <label for="confirm-password">
                        <i class="fas fa-check-circle"></i>
                        Confirm New Password
                    </label>
                    <input type="password" id="confirm-password" required>
                </div>
                <button type="submit" class="btn-gradient full-width">
                    <i class="fas fa-shield-alt"></i>
                    Change Password
                </button>
            </form>
        </div>

        <!-- Club Membership Card -->
        <div class="settings-card">
            <div class="card-icon">
                <i class="fas fa-users"></i>
            </div>
            <h2>Club Membership</h2>
            <div id="club-membership-list">
                {% for membership in current_user.club_memberships %}
                <div class="club-membership-item">
                    <div class="club-info">
                        <h3>{{ membership.club.name }}</h3>
                        <span class="role-badge {% if membership.role == 'co-leader' %}role-badge-leader{% endif %}">
                            {{ membership.role|capitalize }}
                        </span>
                    </div>
                    <button class="btn-danger leave-club-btn" onclick="leaveClub({{ membership.id }})">
                        <i class="fas fa-sign-out-alt"></i> Leave
                    </button>
                </div>
                {% endfor %}
            </div>
            <div class="join-club-section">
                <h3>Join a Club</h3>
                <div class="join-code-form">
                    <input type="text" id="joinClubCode" class="form-control" placeholder="Enter join code">
                    <button type="button" onclick="showClubWarningModal()" class="btn-gradient">
                        <i class="fas fa-users"></i> Join
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toast-container"></div>

<!-- Club Warning Modal -->
<div id="clubWarningModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-exclamation-triangle"></i> Important: Club Leader Permissions</h2>
            <button class="close-btn" onclick="closeClubWarningModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="warning-message">
                <p><strong>Please be aware that by joining this club, you are granting club leaders the following permissions:</strong></p>
                <ul>
                    <li><i class="fas fa-eye"></i> <strong>View your spaces</strong> at any time</li>
                    <li><i class="fas fa-edit"></i> <strong>Edit your spaces</strong> without restriction</li>
                    <li><i class="fas fa-trash-alt"></i> <strong>Delete your spaces</strong> permanently</li>
                </ul>
                <p>This is similar to giving someone admin access to your work. Only join clubs led by people you trust.</p>
            </div>
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="confirmClubPermissions" required>
                    I understand and accept these permissions
                </label>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeClubWarningModal()">Cancel</button>
            <button class="btn btn-primary" id="confirmJoinBtn" onclick="confirmJoinClub()" disabled>
                <i class="fas fa-users"></i> Join Club
            </button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Checkbox listener for confirmation
        document.getElementById('confirmClubPermissions').addEventListener('change', function() {
            document.getElementById('confirmJoinBtn').disabled = !this.checked;
        });
    });

    function showClubWarningModal() {
        const joinCode = document.getElementById('joinClubCode').value.trim();
        if (!joinCode) {
            showToast('error', 'Please enter a join code');
            return;
        }

        document.getElementById('confirmClubPermissions').checked = false;
        document.getElementById('confirmJoinBtn').disabled = true;
        const modal = document.getElementById('clubWarningModal');
        modal.classList.add('show');
        document.body.style.overflow = 'hidden'; // Prevent scrolling
    }

    function closeClubWarningModal() {
        const modal = document.getElementById('clubWarningModal');
        modal.classList.remove('show');
        setTimeout(() => {
            document.body.style.overflow = '';
        }, 300);
    }

    function confirmJoinClub() {
        if (!document.getElementById('confirmClubPermissions').checked) {
            showToast('error', 'Please confirm you understand the permissions');
            return;
        }

        joinClub();
        closeClubWarningModal();
    }

    async function joinClub() {
        const joinCode = document.getElementById('joinClubCode').value.trim();

        if (!joinCode) {
            showToast('error', 'Please enter a join code');
            return;
        }

        try {
            const response = await fetch('/api/clubs/join', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ join_code: joinCode })
            });

            const data = await response.json();

            if (response.ok) {
                showToast('success', data.message);
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                showToast('error', data.error || 'Failed to join club');
            }
        } catch (error) {
            showToast('error', 'Failed to join club');
            console.error('Error:', error);
        }
    }

    async function leaveClub(membershipId) {
        if (!confirm('Are you sure you want to leave this club?')) {
            return;
        }

        try {
            const response = await fetch(`/api/clubs/memberships/${membershipId}/leave`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (response.ok) {
                showToast('success', data.message);
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                showToast('error', data.error || 'Failed to leave club');
            }
        } catch (error) {
            showToast('error', 'Failed to leave club');
            console.error('Error:', error);
        }
    }

    // Profile form submission
    document.getElementById('profile-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const form = this;
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true;

        try {
            const formData = new FormData(form);
            const response = await fetch('/settings', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            showToast(data.status, data.message);
        } catch (error) {
            showToast('error', 'An error occurred while updating profile');
        } finally {
            submitBtn.disabled = false;
        }
    });

    // Password form submission
    document.getElementById('password-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const form = this;
        const submitBtn = form.querySelector('button[type="submit"]');

        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;

        if (newPassword !== confirmPassword) {
            showToast('error', 'New passwords do not match');
            return;
        }

        submitBtn.disabled = true;

        try {
            const formData = new FormData(form);
            const response = await fetch('/settings', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            showToast(data.status, data.message);
            if (data.status === 'success') {
                form.reset();
            }
        } catch (error) {
            showToast('error', 'An error occurred while changing password');
        } finally {
            submitBtn.disabled = false;
        }
    });

    // Unified toast notification system
    function showToast(type, message) {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;

        const icon = type === 'success' ? 'check-circle' : 'exclamation-circle';

        toast.innerHTML = `
            <div class="toast-content">
                <i class="fas fa-${icon}"></i>
                <span class="toast-message">${message}</span>
            </div>
            <button class="toast-close" onclick="this.parentNode.remove()">&times;</button>
        `;

        toastContainer.appendChild(toast);

        // Force reflow to trigger animation
        toast.offsetHeight;

        toast.classList.add('show');

        // Auto remove after 3 seconds
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Service disconnection functions
    async function disconnectGithub() {
        if (confirm('Are you sure you want to disconnect your GitHub account?')) {
            try {
                const response = await fetch('/api/github/disconnect-account', {
                    method: 'POST'
                });
                if (response.ok) {
                    showToast('success', 'Disconnected from GitHub');
                    location.reload();
                } else {
                    showToast('error', 'Failed to disconnect from GitHub');
                }
            } catch (error) {
                showToast('error', 'Failed to disconnect from GitHub');
            }
        }
    }

    async function disconnectHackatime() {
        if (confirm('Are you sure you want to disconnect your Hackatime account?')) {
            try {
                const response = await fetch('/hackatime/disconnect', {
                    method: 'POST'
                });
                if (response.ok) {
                    showToast('success', 'Disconnected from Hackatime');
                    location.reload();
                } else {
                    showToast('error', 'Failed to disconnect from Hackatime');
                }
            } catch (error) {
                showToast('error', 'Failed to disconnect from Hackatime');
            }
        }
    }

    async function disconnectGroq() {
        if (confirm('Are you sure you want to disconnect your Groq account?')) {
            try {
                const response = await fetch('/groq/disconnect', {
                    method: 'POST'
                });
                if (response.ok) {
                    showToast('success', 'Disconnected from Groq');
                    location.reload();
                } else {
                    showToast('error', 'Failed to disconnect from Groq');
                }
            } catch (error) {
                showToast('error', 'Failed to disconnect from Groq');
            }
        }
    }
</script>
{% endblock %}