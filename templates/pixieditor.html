
{% extends "base.html" %}

{% block body_class %}editor-page{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/eclipse.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/dialog/dialog.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/matchesonscrollbar.min.css">

<link rel="stylesheet" href="{{ url_for('static', filename='css/editor.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/github.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/hackatime-badge.css') }}">
{% endblock %}

{% block content %}
<div id="loading-overlay" class="loading-overlay">
    <div class="particles-container" id="particles-js"></div>
    <div class="loading-content">
        <div class="loading-spinner-container">
            <div class="loading-spinner"></div>
            <div class="loading-spinner-shadow"></div>
        </div>
        <div class="loading-text-container">
            <p class="loading-text">Building Your Pixi Game :D</p>
        </div>
        <div class="loading-progress-container">
            <div class="loading-progress-bar">
                <div class="loading-progress-fill"></div>
            </div>
        </div>
        <div class="loading-facts">
            <div class="fact-container">
                <p class="loading-fact">Building your game canvas...</p>
            </div>
        </div>
    </div>
    <div class="loading-glow"></div>
    <div class="loading-corners">
        <div class="corner top-left"></div>
        <div class="corner top-right"></div>
        <div class="corner bottom-left"></div>
        <div class="corner bottom-right"></div>
    </div>
</div>
<div class="editor-container split-layout">
    <div class="editor-topbar">
        <div class="topbar-left">
            <a href="{{ url_for('welcome') }}" class="btn-icon" title="Back to Dashboard">
                <i class="fas fa-arrow-left"></i>
            </a>
            <h1>{{ site.name }}</h1>
        </div>
        <div class="topbar-actions">
            <button id="undoBtn" class="btn-icon" title="Undo (Ctrl+Z)" disabled>
                <i class="fas fa-undo"></i>
            </button>
            <button id="redoBtn" class="btn-icon" title="Redo (Ctrl+Y)" disabled>
                <i class="fas fa-redo"></i>
            </button>

            <div class="dropdown">
                <button class="btn-icon dropdown-toggle" title="Editor Settings">
                    <i class="fas fa-cog"></i>
                </button>
                <div class="dropdown-menu">
                    <div class="dropdown-section">
                        <label for="themeSelector">Theme:</label>
                        <select id="themeSelector" onchange="changeEditorTheme(this.value)">
                            <option value="eclipse" selected>VS Code Light</option>
                            <option value="mdn-like">MDN-like</option>
                            <option value="solarized light">Solarized Light</option>
                        </select>
                    </div>
                    <div class="dropdown-section">
                        <label for="fontSizeSelector">Font Size:</label>
                        <select id="fontSizeSelector" onchange="changeEditorFontSize(this.value)">
                            <option value="12px">Small</option>
                            <option value="14px" selected>Medium</option>
                            <option value="16px">Large</option>
                            <option value="18px">X-Large</option>
                        </select>
                    </div>
                    <div class="dropdown-section checkbox">
                        <label>
                            <input type="checkbox" id="wordWrapToggle" checked onchange="toggleWordWrap(this.checked)">
                            Word Wrap
                        </label>
                    </div>
                    <div class="dropdown-section checkbox">
                        <label>
                            <input type="checkbox" id="lintToggle" onchange="toggleLinting(this.checked)">
                            Lint Code
                        </label>
                    </div>
                </div>
            </div>

            <button id="searchBtn" class="btn-icon" title="Search (Ctrl+F)" onclick="focusSearch()">
                <i class="fas fa-search"></i>
            </button>

            <button id="analyticsBtn" class="btn-primary" onclick="openModal('analyticsModal')">
                <i class="fas fa-chart-line"></i>
                Analytics
            </button>
            <button id="orphyBtn" class="btn-primary" onclick="openOrphyChat()">
                <i class="fas fa-magic"></i>
                Orphy
            </button>
            <button id="runBtn" class="btn-primary" onclick="runCode()">
                <i class="fas fa-play"></i>
                Run
            </button>

            <button id="saveBtn" class="btn-primary" onclick="saveContent()">
                <i class="fas fa-save"></i>
                Save Changes
            </button>

            <button id="gitBtn" class="btn-primary" onclick="GitHubManager.openModal()" style="background: linear-gradient(135deg, #fa8072 0%, #e57363 100%);">
                <i class="fab fa-github"></i>
                Git
            </button>
        </div>
    </div>
    <div class="editor-main">
        <div class="editor-pane">
            <textarea id="editor">{{ site.html_content }}</textarea>
            <input type="hidden" id="site-slug" value="{{ site.slug }}">
            <input type="hidden" id="site-id" value="{{ site.id }}">
            <input type="hidden" id="site-type" value="{{ site.site_type }}">
            <div class="editor-statusbar">
                <div class="status-section">
                    <div class="status-item" id="cursorPosition">
                        <i class="fas fa-map-marker-alt"></i> Line 1, Column 1
                    </div>
                    <div class="status-item" id="fileSizeInfo">
                        <i class="fas fa-file-alt"></i> <span id="fileSize">0</span> bytes
                    </div>
                </div>
                <div class="status-section">
                    <div class="status-item" id="editorMode">
                        {{ site.site_type|upper }}
                    </div>
                    <div class="status-item" id="editorSettings">
                        <i class="fas fa-keyboard"></i>
                        <a href="#" onclick="showKeyboardShortcutsModal(); return false;">Shortcuts</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="preview-pane">
            <div class="browser-frame">
                <div class="browser-header">
                    <div class="browser-address" style="display: flex; align-items: center; width: 100%;">
                        <div style="flex: 1"></div>
                        <div style="display: flex; align-items: center; position: absolute; left: 50%; transform: translateX(-50%); z-index: 10;">
                            <i class="fas fa-lock"></i>
                            <span class="browser-url">https://hackclub.space/s/{{ site.slug|default('', true) }}</span>
                            <button id="openDeployedSiteBtn" class="btn-icon" title="Open deployed site in new tab" onclick="openDeployedSite()" style="z-index: 10000;">
                                <i class="fas fa-external-link-alt"></i>
                            </button>
                        </div>
                        <div style="flex: 1; display: flex; justify-content: flex-end; gap: 8px; z-index: 2; position: relative;">
                            <button id="deployBtn" title="Deploy your site" onclick="deploySite()">
                                <i class="fas fa-rocket" style="color: white;"></i> Deploy
                            </button>
                            <button id="runBtn" title="Run your code" onclick="saveContent()" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; border: none; border-radius: 4px; padding: 5px 12px; font-weight: 500; cursor: pointer; transition: all 0.2s ease;">
                                <i class="fas fa-play" style="color: white;"></i> Run
                            </button>
                        </div>
                    </div>
                </div>
                <iframe id="preview" frameborder="0"></iframe>
            </div>
        </div>
    </div>
</div>

<!-- Toast container -->
<div id="toast-container"></div>

<script>
function showToast(type, message) {
    // Import the shared toast.js functionality
    if (window.showToast) {
        window.showToast(type, message);
    } else {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;

        const icon = type === 'success' ? 'check-circle' : 
                     type === 'error' ? 'exclamation-circle' :
                     type === 'warning' ? 'exclamation-triangle' : 'info-circle';

        toast.innerHTML = `
            <div class="toast-content">
                <i class="fas fa-${icon}"></i>
                <span>${message}</span>
            </div>
        `;

        toastContainer.appendChild(toast);

        // Force reflow
        toast.offsetHeight;

        // Show the toast
        toast.classList.add('show');

        // Automatically remove after 3 seconds
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
}
</script>

<div id="githubModal" class="modal" style="display: none; opacity: 1; visibility: visible;">
    <div class="github-modal-content">
        <div class="github-modal-header">
            <h2><i class="fab fa-github"></i> GitHub Integration</h2>
            <button class="close-btn" onclick="GitHubManager.closeModal()">&times;</button>
        </div>
        <div class="github-modal-body" id="githubModalBody">
            <!-- Content will be dynamically loaded by GitHubManager -->
        </div>
    </div>
</div>

<div id="analyticsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Site Analytics</h2>
            <button class="close-btn" onclick="closeModal('analyticsModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="analytics-summary">
                <div class="analytics-count">
                    <span>1234</span>
                    <label>Total Views</label>
                </div>
                <div class="analytics-actions">
                    <div class="analytics-toggle">
                        <label for="analytics-toggle">Enable Analytics:</label>
                        <label class="switch">
                            <input type="checkbox" id="analytics-toggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <button id="clearAnalyticsBtn" class="btn-danger">
                        <i class="fas fa-trash"></i>
                        Clear Analytics
                    </button>
                </div>
            </div>
            <div class="analytics-info">
                <p><i class="fas fa-info-circle"></i> View count shows total visits to your site.</p>
            </div>
        </div>
    </div>
</div>

<div id="deployModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-rocket"></i> Deploy Your Site</h2>
            <button class="close-btn" onclick="closeDeployModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p>Your site is available at the following URLs:</p>
            <div id="deployUrlsContainer">
                {% set siteSlug = site.slug %}
                {% set defaultDomain = 'hackclub.space' %}
                {% set domains = ['hackclub.space', 'imahacker.lol', 'myhack.club', 'hackclub.me'] %}

                {% for domain in domains %}
                    {% set url = 'https://' + domain + '/s/' + siteSlug %}
                    <div class="site-url">
                        <input type="text" value="{{ url }}" readonly>
                        <button onclick="navigator.clipboard.writeText('{{ url }}')" class="btn-copy">Copy</button>
                        <a href="{{ url }}" target="_blank" class="btn-icon" title="Open in new tab">
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                    </div>
                {% endfor %}
            </div>
            <div class="modal-info">
                <p><strong>Note:</strong> Your default domain is <code>https://{{ defaultDomain }}/s/{{ siteSlug }}</code></p>
                {% if request.host == 'spaces.hackclub.com' %}
                    <p><strong>Warning:</strong> Public hosting is not available on spaces.hackclub.com domain</p>
                {% endif %}
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn-secondary" onclick="closeDeployModal()">Close</button>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/particles.min.js') }}"></script>

<div id="keyboardShortcutsModal" class="modal">
    <div class="modal-content shortcuts-modal">
        <div class="modal-header">
            <h2><i class="fas fa-keyboard"></i> Keyboard Shortcuts</h2>
            <button class="close-btn" onclick="closeKeyboardShortcutsModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="shortcuts-list">
                <div class="shortcut-category">
                    <h4>Editor</h4>
                    <div class="shortcut-item">
                        <span>Save</span>
                        <span class="shortcut-key">Ctrl+S</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Undo</span>
                        <span class="shortcut-key">Ctrl+Z</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Redo</span>
                        <span class="shortcut-key">Ctrl+Y</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Fold Code</span>
                        <span class="shortcut-key">Alt+F</span>
                    </div>
                </div>
                <div class="shortcut-category">
                    <h4>Search</h4>
                    <div class="shortcut-item">
                        <span>Find</span>
                        <span class="shortcut-key">Ctrl+F</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Find Next</span>
                        <span class="shortcut-key">Ctrl+G</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Find Previous</span>
                        <span class="shortcut-key">Shift+Ctrl+G</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Replace</span>
                        <span class="shortcut-key">Ctrl+H</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="orphy-widget" class="orphy-widget">
    <div class="orphy-container">
        <div class="orphy-header" id="orphy-header">
            <div class="orphy-title">
                <h2>Orphy <span class="orphy-emoji">🦖</span></h2>
            </div>
            <button class="orphy-close-btn" onclick="closeOrphyChat()">&times;</button>
        </div>
        <div class="orphy-chat">
            <div class="orphy-messages" id="orphyMessages"></div>
        </div>
        <div class="orphy-input">
            <textarea id="orphyInput" placeholder="Ask Orphy a question about your code..." rows="2"></textarea>
            <button class="orphy-send-btn" onclick="sendOrphyMessage()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closetag.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchtags.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/javascript-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/css-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/html-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/anyword-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/xml-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/search.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/searchcursor.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/dialog/dialog.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/matchesonscrollbar.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/scroll/annotatescrollbar.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/selection/active-line.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/match-highlighter.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/brace-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/xml-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/comment-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/lint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/comment/comment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/display/placeholder.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/scroll/simplescrollbars.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/vscode-dark.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/match-highlighter.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/jump-to-line.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/tern/tern.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/comment/comment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/selection/active-line.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closetag.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchtags.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/xml-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/html-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/brace-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/xml-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/comment-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/comment/comment.min.js"></script>

<script src="{{ url_for('static', filename='js/editor-core.js') }}"></script>
<script src="{{ url_for('static', filename='js/ui-utils.js') }}"></script>
<script src="{{ url_for('static', filename='js/orphy.js') }}"></script>
<script src="{{ url_for('static', filename='js/analytics.js') }}"></script>
<script src="{{ url_for('static', filename='js/file-handling.js') }}"></script>
<script src="{{ url_for('static', filename='js/github.js') }}"></script>
{% if current_user.wakatime_api_key %}
<script src="{{ url_for('static', filename='js/hackatime-tracker.js') }}"></script>
{% endif %}

{% if additional_scripts %}
{{ additional_scripts|safe }}
{% endif %}
{% endblock %}
