{% extends "base.html" %}

{% block title %}Spaces Gallery{% endblock %}

{% block styles %}
<style>
    .gallery-container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 1rem;
    }

    .gallery-header {
        text-align: center;
        margin-bottom: 3rem;
    }

    .gallery-title {
        font-size: 2.5rem;
        color: #eb3750;
        margin-bottom: 0.5rem;
    }

    .gallery-subtitle {
        font-size: 1.2rem;
        color: #444;
        max-width: 700px;
        margin: 0 auto;
    }

    .gallery-filters {
        display: flex;
        justify-content: center;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .filter-btn {
        background-color: #f5f5f5;
        border: none;
        padding: 0.6rem 1.2rem;
        border-radius: 50px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .filter-btn:hover {
        background-color: #e0e0e0;
    }

    .filter-btn.active {
        background-color: #eb3750;
        color: white;
    }

    .gallery-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 2rem;
    }

    .gallery-card {
        background-color: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        position: relative;
    }

    .gallery-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .entry-image {
        width: 100%;
        height: 180px;
        object-fit: cover;
        border-bottom: 1px solid #f0f0f0;
    }

    .entry-preview {
        width: 100%;
        height: 180px;
        background-color: #f9f9f9;
        display: flex;
        align-items: center;
        justify-content: center;
        border-bottom: 1px solid #f0f0f0;
        color: #888;
        font-style: italic;
    }

    .entry-content {
        padding: 1.2rem;
    }

    .entry-title {
        font-size: 1.2rem;
        margin: 0 0 0.5rem 0;
        color: #333;
    }

    .entry-description {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 1rem;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
        line-height: 1.4;
    }

    .entry-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.85rem;
        color: #888;
    }

    .entry-author {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .author-avatar {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background-color: #e0e0e0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        color: #666;
    }

    .entry-actions {
        display: flex;
        gap: 0.8rem;
    }

    .action-btn {
        background: none;
        border: none;
        color: #888;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.3rem;
        transition: color 0.2s ease;
    }

    .action-btn:hover {
        color: #eb3750;
    }

    .action-btn i {
        font-size: 0.9rem;
    }

    .featured-badge {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background-color: #eb3750;
        color: white;
        padding: 0.3rem 0.6rem;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: bold;
        z-index: 2;
    }

    .category-badge {
        position: absolute;
        top: 1rem;
        left: 1rem;
        background-color: #4e54c8;
        color: white;
        padding: 0.3rem 0.6rem;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: bold;
        z-index: 2;
    }

    .entry-visit {
        display: block;
        text-align: center;
        background-color: #4e54c8;
        color: white;
        padding: 0.7rem;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 500;
        margin-top: 1rem;
        transition: background-color 0.2s ease;
    }

    .entry-visit:hover {
        background-color: #3a3f9a;
    }

    .add-entry-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        background-color: #eb3750;
        color: white;
        padding: 0.7rem 1.5rem;
        border-radius: 50px;
        text-decoration: none;
        font-weight: 500;
        margin: 0 auto 2rem;
        transition: background-color 0.2s ease;
        width: fit-content;
    }

    .add-entry-btn:hover {
        background-color: #d62a43;
    }

    .gallery-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .gallery-modal.active {
        opacity: 1;
        visibility: visible;
    }

    .modal-content {
        background-color: white;
        border-radius: 12px;
        padding: 2rem;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .modal-title {
        font-size: 1.5rem;
        color: #333;
        margin: 0;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #888;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #333;
    }

    .form-control {
        width: 100%;
        padding: 0.7rem;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 1rem;
    }

    .form-select {
        width: 100%;
        padding: 0.7rem;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 1rem;
        background-color: white;
    }

    .form-submit {
        background-color: #4e54c8;
        color: white;
        border: none;
        padding: 0.8rem 1.5rem;
        border-radius: 6px;
        font-size: 1rem;
        cursor: pointer;
        font-weight: 500;
        display: block;
        width: 100%;
        transition: background-color 0.2s ease;
    }

    .form-submit:hover {
        background-color: #3a3f9a;
    }

    .empty-gallery {
        text-align: center;
        padding: 4rem 0;
    }

    .empty-icon {
        font-size: 4rem;
        color: #e0e0e0;
        margin-bottom: 1rem;
    }

    .empty-title {
        font-size: 1.5rem;
        color: #555;
        margin-bottom: 0.5rem;
    }

    .empty-text {
        color: #888;
        margin-bottom: 2rem;
    }

    .gallery-pagination {
        display: flex;
        justify-content: center;
        margin-top: 3rem;
        gap: 0.5rem;
    }

    .page-link {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #f5f5f5;
        color: #333;
        text-decoration: none;
        transition: all 0.2s ease;
    }

    .page-link:hover {
        background-color: #e0e0e0;
    }

    .page-link.active {
        background-color: #eb3750;
        color: white;
    }

    .page-nav {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0 1rem;
        height: 40px;
        border-radius: 20px;
        background-color: #f5f5f5;
        color: #333;
        text-decoration: none;
        transition: all 0.2s ease;
    }

    .page-nav:hover {
        background-color: #e0e0e0;
    }

    .page-nav.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    @media (max-width: 768px) {
        .gallery-grid {
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        }
    }

    @media (max-width: 480px) {
        .gallery-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<main class="gallery-container banner-adjusted">
    <div class="gallery-header">
        <h1 class="gallery-title">Spaces Gallery</h1>
        <p class="gallery-subtitle">Discover amazing websites created with Hack Club Spaces</p>
    </div>

    {% if current_user.is_authenticated %}
    <a href="#" class="add-entry-btn" id="addToGalleryBtn">
        <i class="fas fa-plus"></i> Add Your Space
    </a>
    {% else %}
    <a href="{{ url_for('login') }}" class="add-entry-btn">
        <i class="fas fa-sign-in-alt"></i> Login to Add Your Space
    </a>
    {% endif %}

    <div class="gallery-filters">
        <button class="filter-btn active" data-filter="all">All</button>
        <button class="filter-btn" data-filter="featured">Featured</button>
        <button class="filter-btn" data-filter="personal">Personal</button>
        <button class="filter-btn" data-filter="blog">Blog</button>
        <button class="filter-btn" data-filter="portfolio">Portfolio</button>
        <button class="filter-btn" data-filter="game">Game</button>
        <button class="filter-btn" data-filter="tool">Tool</button>
        <button class="filter-btn" data-filter="other">Other</button>
    </div>

    <div class="gallery-grid">
        {% if entries %}
            {% for entry in entries %}
            <div class="gallery-card" data-category="{{ entry.category or 'other' }}">
                {% if entry.featured %}
                <div class="featured-badge">Featured</div>
                {% endif %}
                {% if entry.category %}
                <div class="category-badge">{{ entry.category }}</div>
                {% endif %}

                {% if entry.screenshot_url %}
                <img src="{{ entry.screenshot_url }}" alt="{{ entry.title }}" class="entry-image">
                {% else %}
                <div class="entry-preview">
                    <i class="fas fa-image"></i> No preview available
                </div>
                {% endif %}

                <div class="entry-content">
                    <h3 class="entry-title">{{ entry.title }}</h3>
                    <p class="entry-description">{{ entry.description }}</p>
                    <div class="entry-meta">
                        <div class="entry-author">
                            <div class="author-avatar">
                                {{ entry.user.username[0] }}
                            </div>
                            <span>{{ entry.user.username }}</span>
                        </div>
                        <div class="entry-actions">
                            <button class="action-btn like-btn" data-id="{{ entry.id }}">
                                <i class="far fa-heart"></i>
                                <span>{{ entry.likes }}</span>
                            </button>
                        </div>
                    </div>
                    <a href="/s/{{ entry.site.slug }}" target="_blank" class="entry-visit">
                        Visit Site <i class="fas fa-external-link-alt"></i>
                    </a>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-gallery" style="grid-column: 1/-1;">
                <div class="empty-icon">
                    <i class="fas fa-rocket"></i>
                </div>
                <h2 class="empty-title">No Spaces in the Gallery Yet</h2>
                <p class="empty-text">Be the first to add your amazing creation!</p>
                {% if current_user.is_authenticated %}
                <a href="#" class="add-entry-btn" id="addToGalleryBtnEmpty">
                    <i class="fas fa-plus"></i> Add Your Space
                </a>
                {% else %}
                <a href="{{ url_for('login') }}" class="add-entry-btn">
                    <i class="fas fa-sign-in-alt"></i> Login to Add Your Space
                </a>
                {% endif %}
            </div>
        {% endif %}
    </div>

    {% if pagination and pagination.pages > 1 %}
    <div class="gallery-pagination">
        {% if pagination.has_prev %}
        <a href="{{ url_for('gallery', page=pagination.prev_num) }}" class="page-nav">
            <i class="fas fa-chevron-left"></i> Previous
        </a>
        {% else %}
        <span class="page-nav disabled">
            <i class="fas fa-chevron-left"></i> Previous
        </span>
        {% endif %}

        {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
            {% if page_num %}
                {% if page_num == pagination.page %}
                <a href="{{ url_for('gallery', page=page_num) }}" class="page-link active">{{ page_num }}</a>
                {% else %}
                <a href="{{ url_for('gallery', page=page_num) }}" class="page-link">{{ page_num }}</a>
                {% endif %}
            {% else %}
                <span class="page-link">...</span>
            {% endif %}
        {% endfor %}

        {% if pagination.has_next %}
        <a href="{{ url_for('gallery', page=pagination.next_num) }}" class="page-nav">
            Next <i class="fas fa-chevron-right"></i>
        </a>
        {% else %}
        <span class="page-nav disabled">
            Next <i class="fas fa-chevron-right"></i>
        </span>
        {% endif %}
    </div>
    {% endif %}
</main>

{% if current_user.is_authenticated %}
<!-- Gallery Modal -->
<div class="gallery-modal" id="galleryModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Add Your Space to the Gallery</h2>
            <button class="modal-close" id="closeModal">&times;</button>
        </div>
        <form id="galleryEntryForm">
            <div class="form-group">
                <label for="entryTitle" class="form-label">Title</label>
                <input type="text" id="entryTitle" name="title" class="form-control" required placeholder="Give your space a catchy title">
            </div>
            <div class="form-group">
                <label for="entryDescription" class="form-label">Description</label>
                <textarea id="entryDescription" name="description" class="form-control" required placeholder="Describe what your space is about" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="entrySite" class="form-label">Select a Space</label>
                <select id="entrySite" name="site_id" class="form-select" required>
                    <option value="">Choose a space...</option>
                    {% for site in user_sites %}
                    <option value="{{ site.id }}">{{ site.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="entryCategory" class="form-label">Category</label>
                <select id="entryCategory" name="category" class="form-select" required>
                    <option value="personal">Personal</option>
                    <option value="blog">Blog</option>
                    <option value="portfolio">Portfolio</option>
                    <option value="game">Game</option>
                    <option value="tool">Tool</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label for="entryScreenshot" class="form-label">Screenshot URL (Optional)</label>
                <input type="url" id="entryScreenshot" name="screenshot_url" class="form-control" placeholder="https://example.com/screenshot.jpg">
            </div>
            <button type="submit" class="form-submit">Add to Gallery</button>
        </form>
    </div>
</div>
{% endif %}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Filter functionality
        const filterButtons = document.querySelectorAll('.filter-btn');
        const galleryCards = document.querySelectorAll('.gallery-card');

        filterButtons.forEach(button => {
            button.addEventListener('click', function() {
                const filter = this.getAttribute('data-filter');

                // Update active button
                filterButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');

                // Filter cards
                galleryCards.forEach(card => {
                    if (filter === 'all') {
                        card.style.display = 'block';
                    } else if (filter === 'featured' && card.querySelector('.featured-badge')) {
                        card.style.display = 'block';
                    } else if (card.getAttribute('data-category') === filter) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
        });

        // Modal functionality
        const addToGalleryBtn = document.getElementById('addToGalleryBtn');
        const addToGalleryBtnEmpty = document.getElementById('addToGalleryBtnEmpty');
        const galleryModal = document.getElementById('galleryModal');
        const closeModal = document.getElementById('closeModal');
        const galleryEntryForm = document.getElementById('galleryEntryForm');

        if (addToGalleryBtn) {
            addToGalleryBtn.addEventListener('click', function(e) {
                e.preventDefault();
                galleryModal.classList.add('active');
            });
        }

        if (addToGalleryBtnEmpty) {
            addToGalleryBtnEmpty.addEventListener('click', function(e) {
                e.preventDefault();
                galleryModal.classList.add('active');
            });
        }

        if (closeModal) {
            closeModal.addEventListener('click', function() {
                galleryModal.classList.remove('active');
            });
        }

        // Close modal when clicking outside
        if (galleryModal) {
            galleryModal.addEventListener('click', function(e) {
                if (e.target === galleryModal) {
                    galleryModal.classList.remove('active');
                }
            });
        }

        // Form submission
        if (galleryEntryForm) {
            galleryEntryForm.addEventListener('submit', function(e) {
                e.preventDefault();

                const formData = new FormData(this);
                const jsonData = {};

                for (const [key, value] of formData.entries()) {
                    jsonData[key] = value;
                }

                fetch('/api/gallery/entries', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(jsonData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show success message or redirect
                        window.location.reload();
                    } else {
                        alert(data.message || 'An error occurred');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred. Please try again.');
                });
            });
        }

        // Like functionality
        const likeButtons = document.querySelectorAll('.like-btn');

        likeButtons.forEach(button => {
            button.addEventListener('click', function() {
                const entryId = this.getAttribute('data-id');

                fetch(`/api/gallery/entries/${entryId}/like`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update like count
                        const countSpan = this.querySelector('span');
                        countSpan.textContent = data.likes;

                        // Toggle heart icon
                        const icon = this.querySelector('i');
                        if (data.liked) {
                            icon.classList.remove('far');
                            icon.classList.add('fas');
                            icon.style.color = '#eb3750';
                        } else {
                            icon.classList.remove('fas');
                            icon.classList.add('far');
                            icon.style.color = '';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            });
        });
    });
</script>
{% endblock %}