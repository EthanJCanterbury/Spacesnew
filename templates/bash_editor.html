
{% extends "base.html" %}

{% block body_class %}editor-page bash-editor-page{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/xterm/3.14.5/xterm.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/editor.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/github.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/hackatime-badge.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/bash-editor.css') }}">
{% endblock %}

{% block content %}
<div id="loading-overlay" class="loading-overlay">
    <div class="particles-container" id="particles-js"></div>
    <div class="loading-content">
        <div class="loading-spinner-container">
            <div class="loading-spinner"></div>
            <div class="loading-spinner-shadow"></div>
        </div>
        <div class="loading-text-container">
            <p class="loading-text">Building Your Bash Space :D</p>
        </div>
        <div class="loading-progress-container">
            <div class="loading-progress-bar">
                <div class="loading-progress-fill"></div>
            </div>
        </div>
        <div class="loading-facts">
            <div class="fact-container">
                <p class="loading-fact">Starting Debian QEMU instance...</p>
            </div>
        </div>
    </div>
    <div class="loading-glow"></div>
    <div class="loading-corners">
        <div class="corner top-left"></div>
        <div class="corner top-right"></div>
        <div class="corner bottom-left"></div>
        <div class="corner bottom-right"></div>
    </div>
</div>

<div class="editor-container split-layout">
    <div class="editor-topbar">
        <div class="topbar-left">
            <a href="{{ url_for('welcome') }}" class="btn-icon" title="Back to Dashboard">
                <i class="fas fa-arrow-left"></i>
            </a>
            <h1>{{ site.name }}</h1>
        </div>
        <div class="topbar-actions">
            <button id="fileExplorerBtn" class="btn-icon" title="File Explorer">
                <i class="fas fa-folder"></i>
            </button>
            
            <div class="dropdown">
                <button class="btn-icon dropdown-toggle" title="Terminal Settings">
                    <i class="fas fa-cog"></i>
                </button>
                <div class="dropdown-menu">
                    <div class="dropdown-section">
                        <label for="fontSizeSelector">Font Size:</label>
                        <select id="fontSizeSelector" onchange="changeTerminalFontSize(this.value)">
                            <option value="12px">Small</option>
                            <option value="14px" selected>Medium</option>
                            <option value="16px">Large</option>
                            <option value="18px">X-Large</option>
                        </select>
                    </div>
                </div>
            </div>

            <button id="restartBtn" class="btn-primary" onclick="restartBashInstance()">
                <i class="fas fa-redo"></i>
                Restart
            </button>

            <button id="gitBtn" class="btn-primary" onclick="GitHubManager.openModal()" style="background: linear-gradient(135deg, #fa8072 0%, #e57363 100%);">
                <i class="fab fa-github"></i>
                Git
            </button>
        </div>
    </div>
    <div class="editor-main">
        <div id="file-explorer" class="file-explorer-panel">
            <div class="file-explorer-header">
                <h3>File Explorer</h3>
                <button id="closeFileExplorer" class="btn-icon">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="file-tree" class="file-tree">
                <div class="file-tree-loading">Loading files...</div>
            </div>
            <div class="file-actions">
                <button id="newFileBtn" class="btn-sm">
                    <i class="fas fa-file"></i> New File
                </button>
                <button id="newFolderBtn" class="btn-sm">
                    <i class="fas fa-folder"></i> New Folder
                </button>
            </div>
        </div>
        <div class="terminal-pane">
            <div id="terminal-container"></div>
            <input type="hidden" id="site-slug" value="{{ site.slug }}">
            <input type="hidden" id="site-id" value="{{ site.id }}">
            <input type="hidden" id="site-type" value="bash">
        </div>
    </div>
</div>

<div id="toast-container"></div>

<div id="githubModal" class="modal" style="display: none; opacity: 1; visibility: visible;">
    <div class="github-modal-content">
        <div class="github-modal-header">
            <h2><i class="fab fa-github"></i> GitHub Integration</h2>
            <button class="close-btn" onclick="GitHubManager.closeModal()">&times;</button>
        </div>
        <div class="github-modal-body" id="githubModalBody">
            <!-- Content will be dynamically loaded by GitHubManager -->
        </div>
    </div>
</div>

<div id="new-file-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Create New File</h2>
            <button class="close-btn">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="newFilenamePath">Filename (include path):</label>
                <input type="text" id="newFilenamePath" placeholder="e.g., project/script.sh">
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn-secondary" id="cancelNewFile">Cancel</button>
            <button class="btn-primary" id="createNewFile">Create</button>
        </div>
    </div>
</div>

<div id="new-folder-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Create New Folder</h2>
            <button class="close-btn">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="newFolderPath">Folder Path:</label>
                <input type="text" id="newFolderPath" placeholder="e.g., project/scripts">
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn-secondary" id="cancelNewFolder">Cancel</button>
            <button class="btn-primary" id="createNewFolder">Create</button>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/particles.min.js') }}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xterm/3.14.5/xterm.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xterm/3.14.5/addons/fit/fit.min.js"></script>
<script src="{{ url_for('static', filename='js/github.js') }}"></script>

<script src="{{ url_for('static', filename='js/bash-editor.js') }}"></script>
<script src="{{ url_for('static', filename='js/ui-utils.js') }}"></script>
{% if current_user.wakatime_api_key %}
<script src="{{ url_for('static', filename='js/hackatime-tracker.js') }}"></script>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    initBashTerminal();
    
    // Show loading overlay
    const loadingOverlay = document.getElementById('loading-overlay');
    if (loadingOverlay) {
        loadingOverlay.style.display = 'flex';
        
        // Initialize particles
        particlesJS('particles-js', {
            particles: {
                number: { value: 80, density: { enable: true, value_area: 800 } },
                color: { value: "#ffffff" },
                shape: { type: "circle" },
                opacity: { value: 0.5, random: false },
                size: { value: 3, random: true },
                line_linked: { enable: true, distance: 150, color: "#ffffff", opacity: 0.4, width: 1 },
                move: { enable: true, speed: 6, direction: "none", random: false, straight: false, out_mode: "out", bounce: false }
            },
            interactivity: {
                detect_on: "canvas",
                events: { onhover: { enable: true, mode: "repulse" }, onclick: { enable: true, mode: "push" } },
                modes: { repulse: { distance: 100, duration: 0.4 }, push: { particles_nb: 4 } }
            }
        });
        
        // Simulate progress
        const progressFill = document.querySelector('.loading-progress-fill');
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += Math.random() * 10;
            if (progress >= 100) {
                progress = 100;
                clearInterval(progressInterval);
                
                // Hide loading overlay after terminal is ready
                setTimeout(() => {
                    loadingOverlay.style.opacity = '0';
                    setTimeout(() => {
                        loadingOverlay.style.display = 'none';
                    }, 500);
                }, 1000);
            }
            progressFill.style.width = `${progress}%`;
        }, 300);
    }
    
    // File explorer toggle
    document.getElementById('fileExplorerBtn').addEventListener('click', function() {
        document.getElementById('file-explorer').classList.toggle('show');
    });
    
    document.getElementById('closeFileExplorer').addEventListener('click', function() {
        document.getElementById('file-explorer').classList.remove('show');
    });
    
    // New file modal
    document.getElementById('newFileBtn').addEventListener('click', function() {
        openModal('new-file-modal');
    });
    
    document.getElementById('cancelNewFile').addEventListener('click', function() {
        closeModal('new-file-modal');
    });
    
    document.getElementById('createNewFile').addEventListener('click', function() {
        const filePath = document.getElementById('newFilenamePath').value.trim();
        if (filePath) {
            createNewFile(filePath);
            closeModal('new-file-modal');
        }
    });
    
    // New folder modal
    document.getElementById('newFolderBtn').addEventListener('click', function() {
        openModal('new-folder-modal');
    });
    
    document.getElementById('cancelNewFolder').addEventListener('click', function() {
        closeModal('new-folder-modal');
    });
    
    document.getElementById('createNewFolder').addEventListener('click', function() {
        const folderPath = document.getElementById('newFolderPath').value.trim();
        if (folderPath) {
            createNewFolder(folderPath);
            closeModal('new-folder-modal');
        }
    });
    
    // Close modals when clicking on X
    document.querySelectorAll('.close-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const modal = this.closest('.modal');
            if (modal) {
                closeModal(modal.id);
            }
        });
    });
    
    // Load file tree
    loadFileTree();
});

function changeTerminalFontSize(size) {
    const terminal = document.getElementById('terminal-container');
    if (terminal) {
        terminal.style.fontSize = size;
    }
}

function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'flex';
        setTimeout(() => {
            modal.classList.add('show');
        }, 10);
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }
}

function createNewFile(filePath) {
    const siteId = document.getElementById('site-id').value;
    
    fetch(`/api/bash/${siteId}/file`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ path: filePath, content: '' })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('File created successfully', 'success');
            loadFileTree();
        } else {
            showNotification(data.message || 'Failed to create file', 'error');
        }
    })
    .catch(error => {
        console.error('Error creating file:', error);
        showNotification('Failed to create file', 'error');
    });
}

function createNewFolder(folderPath) {
    const siteId = document.getElementById('site-id').value;
    
    fetch(`/api/bash/${siteId}/folder`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ path: folderPath })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Folder created successfully', 'success');
            loadFileTree();
        } else {
            showNotification(data.message || 'Failed to create folder', 'error');
        }
    })
    .catch(error => {
        console.error('Error creating folder:', error);
        showNotification('Failed to create folder', 'error');
    });
}

function loadFileTree() {
    const siteId = document.getElementById('site-id').value;
    const fileTree = document.getElementById('file-tree');
    
    fileTree.innerHTML = '<div class="file-tree-loading">Loading files...</div>';
    
    fetch(`/api/bash/${siteId}/files`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.files) {
                renderFileTree(data.files);
            } else {
                fileTree.innerHTML = '<div class="file-tree-error">Failed to load files</div>';
            }
        })
        .catch(error => {
            console.error('Error loading file tree:', error);
            fileTree.innerHTML = '<div class="file-tree-error">Failed to load files</div>';
        });
}

function renderFileTree(files) {
    const fileTree = document.getElementById('file-tree');
    fileTree.innerHTML = '';
    
    const rootUl = document.createElement('ul');
    rootUl.className = 'file-tree-list';
    
    files.forEach(file => {
        const li = document.createElement('li');
        li.className = file.type === 'directory' ? 'folder-item' : 'file-item';
        
        const icon = document.createElement('i');
        icon.className = file.type === 'directory' ? 'fas fa-folder' : 'fas fa-file';
        
        const span = document.createElement('span');
        span.textContent = file.name;
        
        li.appendChild(icon);
        li.appendChild(span);
        
        if (file.type === 'file') {
            li.addEventListener('click', () => {
                sendCommand(`cat "${file.path}"`);
            });
        }
        
        rootUl.appendChild(li);
    });
    
    fileTree.appendChild(rootUl);
}

function restartBashInstance() {
    if (confirm('Are you sure you want to restart the Bash instance? Any unsaved changes will be lost.')) {
        const siteId = document.getElementById('site-id').value;
        
        fetch(`/api/bash/${siteId}/restart`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Bash instance restarted', 'success');
                location.reload();
            } else {
                showNotification(data.message || 'Failed to restart Bash instance', 'error');
            }
        })
        .catch(error => {
            console.error('Error restarting Bash instance:', error);
            showNotification('Failed to restart Bash instance', 'error');
        });
    }
}

function showNotification(message, type = 'info', duration = 3000) {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `<div class="toast-content">${message}</div>`;
    
    const container = document.getElementById('toast-container');
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('show');
    }, 10);
    
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            container.removeChild(toast);
        }, 300);
    }, duration);
}
</script>
{% endblock %}
{% extends 'base.html' %}

{% block title %}Bash Space: {{ site.name }}{% endblock %}

{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/bash-editor.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/xterm/3.14.5/xterm.min.css">
{% endblock %}

{% block content %}
<div class="bash-editor-page">
  <input type="hidden" id="site-id" value="{{ site.id }}">
  <div class="editor-controls">
    <div class="editor-title">
      <h3>{{ site.name }}</h3>
      <button class="toggle-files-btn" onclick="toggleFileExplorer()">
        <i class="fas fa-folder"></i> Files
      </button>
    </div>
    <div class="editor-actions">
      <button id="restartBtn" class="btn btn-warning" onclick="restartBashInstance()">
        <i class="fas fa-sync-alt"></i> Restart
      </button>
      <button class="btn" id="gitBtn">
        <i class="fab fa-github"></i> GitHub
      </button>
    </div>
  </div>
  
  <div class="editor-main">
    <div class="file-explorer-panel" id="fileExplorer">
      <div class="file-explorer-header">
        <h3>Files</h3>
        <div>
          <button class="btn-icon" onclick="createNewFile()"><i class="fas fa-file-plus"></i></button>
          <button class="btn-icon" onclick="createNewFolder()"><i class="fas fa-folder-plus"></i></button>
        </div>
      </div>
      <div class="file-tree" id="fileTree">
        <ul class="file-tree-list" id="fileTreeList">
          <!-- Files will be populated here -->
        </div>
      </div>
    </div>
    
    <div class="terminal-pane">
      <div id="terminal-container"></div>
    </div>
  </div>
</div>

<!-- File Edit Modal -->
<div class="modal" id="fileEditModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="fileEditTitle">Edit File</h3>
      <span class="close" onclick="closeFileEditModal()">&times;</span>
    </div>
    <div class="modal-body">
      <textarea id="fileEditContent" rows="20" cols="80"></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeFileEditModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveFile()">Save</button>
    </div>
  </div>
</div>

<!-- New File Modal -->
<div class="modal" id="newFileModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Create New File</h3>
      <span class="close" onclick="closeNewFileModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="newFilePath">File Path:</label>
        <input type="text" id="newFilePath" class="form-control" placeholder="/home/user/example.sh">
      </div>
      <div class="form-group">
        <label for="newFileContent">Content:</label>
        <textarea id="newFileContent" rows="15" cols="80" class="form-control">#!/bin/bash
# New bash script</textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeNewFileModal()">Cancel</button>
      <button class="btn btn-primary" onclick="createFile()">Create</button>
    </div>
  </div>
</div>

<!-- New Folder Modal -->
<div class="modal" id="newFolderModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Create New Folder</h3>
      <span class="close" onclick="closeNewFolderModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="newFolderPath">Folder Path:</label>
        <input type="text" id="newFolderPath" class="form-control" placeholder="/home/user/newfolder">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeNewFolderModal()">Cancel</button>
      <button class="btn btn-primary" onclick="createFolder()">Create</button>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xterm/3.14.5/xterm.min.js"></script>
  <script src="{{ url_for('static', filename='js/bash-editor.js') }}"></script>
{% endblock %}
