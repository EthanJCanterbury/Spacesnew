{% extends "base.html" %}

{% block head %}
<title>Connect Hackatime - Hack Club Spaces</title>
<link rel="stylesheet" href="{{ url_for('static', filename='css/hackatime.css') }}">
{% endblock %}

{% block content %}
<div class="hackatime-container">
    <div class="hackatime-card">
        <div class="header">
            <h1 class="title">Connect with Hackatime</h1>
            <div class="subtitle">Track your coding time and see your stats</div>
        </div>


        <div class="info-section">
            <h2>What is Hackatime?</h2>
            <p>Hackatime is Hack Club's coding time tracker that helps you visualize your programming activity and track progress over time. We also use it to verify your time developing so we can send rewards!</p>

            <div class="connection-steps">
                <h3>How to connect:</h3>
                <ol>
                    <li>Visit <a href="https://hackatime.hackclub.com/" target="_blank" rel="noopener">hackatime.hackclub.com</a></li>
                    <li>Go to your account settings</li>
                    <li>Copy your API key</li>
                    <li>Paste it below to connect your account</li>
                    <li>Start tracking your time and earning rewards!</li>
                </ol>
            </div>
        </div>

        {% if current_user.wakatime_api_key %}
            <div class="success-message">
                <i class="fas fa-check-circle"></i>
                <p>Your Hackatime account is connected!</p>
                <button id="disconnect-btn" class="disconnect-button">Disconnect Account</button>
            </div>
        {% else %}
            <form id="hackatime-form" method="post" action="{{ url_for('hackatime_connect') }}" class="api-key-form">
                <div class="form-group">
                    <label for="api_key">Your Hackatime API Key</label>
                    <input type="password" id="api_key" name="api_key" placeholder="Paste your API key here" required minlength="20">
                    <button type="button" id="toggle-visibility" class="toggle-btn">
                        <i class="fas fa-eye"></i>
                    </button>
                    <div id="api-key-feedback" class="mt-2 text-muted small">
                        <span id="api-key-length">0</span> characters (should be at least 36)
                    </div>
                    <div id="api-key-help" class="mt-2 p-3 border rounded bg-light">
                        <h5>Troubleshooting API Key Issues</h5>
                        <ul>
                            <li>Make sure you copied the full API key without any extra spaces</li>
                            <li>API keys should be long strings (36+ characters)</li>
                            <li>If you're getting 401 errors, your key may be expired or invalid</li>
                            <li>You may need to regenerate a new key at <a href="https://waka.hackclub.com/settings/api-key" target="_blank">waka.hackclub.com</a></li>
                        </ul>
                    </div>
                    <div class="hint">The API key will be stored securely and only used to fetch your coding stats.</div>
                </div>

                <button type="submit" class="connect-button">
                    <span>Connect Hackatime</span>
                    <i class="fas fa-arrow-right"></i>
                </button>
            </form>
        {% endif %}

        <div class="benefits">
            <div class="benefit-item">
                <i class="fas fa-chart-line"></i>
                <span>Track your coding progress</span>
            </div>
            <div class="benefit-item">
                <i class="fas fa-trophy"></i>
                <span>Earn super cool rewards while developing</span>
            </div>
            <div class="benefit-item">
                <i class="fas fa-users"></i>
                <span>Compare with club members</span>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const toggleBtn = document.getElementById('toggle-visibility');
    const apiKeyInput = document.getElementById('api_key');
    const disconnectBtn = document.getElementById('disconnect-btn');

    if (toggleBtn && apiKeyInput) {
        toggleBtn.addEventListener('click', function() {
            const type = apiKeyInput.getAttribute('type') === 'password' ? 'text' : 'password';
            apiKeyInput.setAttribute('type', type);

            const icon = toggleBtn.querySelector('i');
            icon.classList.toggle('fa-eye');
            icon.classList.toggle('fa-eye-slash');
        });
    }

    if (disconnectBtn) {
        disconnectBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to disconnect your Hackatime account?')) {
                fetch('/hackatime/disconnect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.reload();
                    } else {
                        alert('Failed to disconnect: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while disconnecting your account.');
                });
            }
        });
    }

    const form = document.getElementById('hackatime-form');
    // Update API key length counter
    if (apiKeyInput) {
        apiKeyInput.addEventListener('input', function() {
            const keyLength = apiKeyInput.value.trim().length;
            document.getElementById('api-key-length').textContent = keyLength;
            
            // Visual feedback
            const feedbackEl = document.getElementById('api-key-feedback');
            if (keyLength < 20) {
                feedbackEl.className = 'mt-2 text-danger small';
            } else if (keyLength < 36) {
                feedbackEl.className = 'mt-2 text-warning small';
            } else {
                feedbackEl.className = 'mt-2 text-success small';
            }
        });
    }

    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                alert('Please enter your Hackatime API key.');
                return;
            }
            
            if (apiKey.length < 20) {
                alert('This API key seems too short. API keys are typically at least 36 characters long. Please check your key and try again.');
                return;
            }

            fetch('/hackatime/connect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    api_key: apiKey
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('Failed to connect: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while connecting your account.');
            });
        });
    }
});
</script>
{% endblock %}