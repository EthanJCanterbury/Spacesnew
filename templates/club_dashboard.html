{% extends "base.html" %}

{% block content %}
<div class="club-dashboard-container">
    <div class="dashboard-header">
        <h1><i class="fas fa-users"></i> Club Dashboard</h1>

        {% if club %}
            <!-- Club Leader View -->
            <div class="club-tabs-container">
                <div class="club-info-header" data-club-id="{{ club.id }}">
                    <h2>{{ club.name }}</h2>
                    <div class="club-actions">
                        <button class="btn-primary edit-club-btn" onclick="openEditClubModal()">
                            <i class="fas fa-edit"></i> Edit Club
                        </button>
                        <button class="btn-primary" onclick="generateJoinCode()">
                            <i class="fas fa-key"></i> Join Code: <span id="join-code-display">{{ club.join_code }}</span>
                        </button>
                    </div>
                </div>

                <div class="tabs">
                    <button class="tab-btn active" onclick="openTab('stream')"><i class="fas fa-stream"></i> Stream</button>
                    <button class="tab-btn" onclick="openTab('assignments')"><i class="fas fa-tasks"></i> Assignments</button>
                    <button class="tab-btn" onclick="openTab('members')"><i class="fas fa-user-friends"></i> Members</button>
                    <button class="tab-btn" onclick="openTab('chat')"><i class="fas fa-comments"></i> Chat</button>
                    <button class="tab-btn" onclick="openTab('resources')"><i class="fas fa-link"></i> Resources</button>
                    <button class="tab-btn" onclick="openTab('settings')"><i class="fas fa-cog"></i> Settings</button>
                </div>
            </div>
        {% elif current_user.club_memberships|length > 0 %}
            <!-- Member View of Clubs -->
            <div class="my-clubs-section">
                <h2>My Clubs</h2>
                <div class="clubs-grid">
                    {% for membership in current_user.club_memberships %}
                    <div class="club-card" onclick="viewClub({{ membership.club.id }})">
                        <div class="club-card-header">
                            <h3>{{ membership.club.name }}</h3>
                            <span class="role-badge {% if membership.role == 'co-leader' %}role-badge-leader{% endif %}">
                                {{ membership.role|capitalize }}
                            </span>
                        </div>
                        <div class="club-card-body">
                            <p>{{ membership.club.description or 'No description available' }}</p>
                            <div class="club-meta">
                                <span><i class="fas fa-map-marker-alt"></i> {{ membership.club.location or 'No location' }}</span>
                                <span><i class="fas fa-user-friends"></i> {{ membership.club.members|length }} members</span>
                            </div>
                        </div>
                        <div class="club-card-footer">
                            <button class="btn-primary">View Club</button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        {% else %}
            <!-- Empty State -->
            <div class="club-empty-state">
                <div class="empty-icon">
                    <i class="fas fa-users-slash"></i>
                </div>
                <h2>You haven't joined any clubs yet</h2>
                <p>Join an existing club with a join code or create your own!</p>
                <div class="empty-actions">
                    <button class="btn-primary" onclick="openCreateClubModal()">
                        <i class="fas fa-plus"></i> Create Club
                    </button>
                    <button class="btn-secondary" onclick="openJoinClubModal()">
                        <i class="fas fa-sign-in-alt"></i> Join Club
                    </button>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Tab Contents for Club Leader or Member View of a Specific Club -->
    {% if club %}
    <div class="tab-content">
        <!-- Stream Tab Content -->
        <div id="stream" class="tab-pane active">
            <div class="stream-container">
                <div class="post-composer">
                    <div class="composer-header">
                        <h3><i class="fas fa-pen"></i> Create Announcement</h3>
                    </div>
                    <div class="composer-body">
                        <textarea id="post-content" placeholder="Share an announcement with your club..."></textarea>
                        <div class="composer-actions">
                            <button onclick="createPost()" class="btn-primary"><i class="fas fa-paper-plane"></i> Post</button>
                        </div>
                    </div>
                </div>

                <div class="posts-list" id="posts-container">
                    <div class="post-card">
                        <div class="post-header">
                            <img src="{{ url_for('static', filename='images/logo-rounded.png') }}" alt="Profile" class="avatar">
                            <div class="post-info">
                                <h3>Club Leader</h3>
                                <span class="post-date">Just now</span>
                            </div>
                            <div class="post-actions">
                                <button class="btn-icon"><i class="fas fa-ellipsis-v"></i></button>
                            </div>
                        </div>
                        <div class="post-content">
                            <p>Welcome to our club! This is a sample announcement. Real announcements will appear here once you create them.</p>
                        </div>
                        <div class="post-footer">
                            <button class="post-action"><i class="far fa-heart"></i> Like</button>
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Assignments Tab Content -->
        <div id="assignments" class="tab-pane">
            <div class="assignments-container">
                <div class="assignments-header">
                    <h3>Club Assignments</h3>
                    <button class="btn-primary" onclick="openCreateAssignmentModal()">
                        <i class="fas fa-plus"></i> New Assignment
                    </button>
                </div>

                <div class="assignments-list" id="assignments-container">
                    <div class="assignment-card">
                        <div class="assignment-status">
                            <span class="status-badge status-active">Active</span>
                        </div>
                        <div class="assignment-body">
                            <h3>Sample Assignment</h3>
                            <p>This is a sample assignment to demonstrate how assignments will look in your club dashboard.</p>
                            <div class="assignment-meta">
                                <span><i class="fas fa-calendar-alt"></i> Due: Next week</span>
                                <span><i class="fas fa-users"></i> For: All members</span>
                            </div>
                        </div>
                        <div class="assignment-actions">
                            <button class="btn-primary"><i class="fas fa-eye"></i> View</button>
                            <button class="btn-secondary"><i class="fas fa-edit"></i> Edit</button>
                            <button class="btn-danger"><i class="fas fa-trash"></i> Delete</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Members Tab Content -->
        <div id="members" class="tab-pane">
            <div class="members-container">
                <div class="members-header">
                    <h3>Club Members</h3>
                    <button class="btn-primary" onclick="openAddMemberModal()">
                        <i class="fas fa-user-plus"></i> Add Member
                    </button>
                </div>

                <div class="members-list">
                    <table class="members-table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="membersTableBody">
                            {% for membership in club.members %}
                                <tr>
                                    <td>{{ membership.user.username }}</td>
                                    <td>{{ membership.user.email }}</td>
                                    <td>
                                        <span class="role-badge {% if membership.role == 'co-leader' %}role-badge-leader{% endif %}">
                                            {{ membership.role|capitalize }}
                                        </span>
                                    </td>
                                    <td>{{ membership.joined_at.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn-icon" onclick="openChangeRoleModal({{ membership.id }}, '{{ membership.user.username }}', '{{ membership.role }}')">
                                                <i class="fas fa-user-tag"></i>
                                            </button>
                                            <button class="btn-icon delete-action" onclick="openRemoveMemberModal({{ membership.id }}, '{{ membership.user.username }}')">
                                                <i class="fas fa-user-minus"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Chat Tab Content -->
        <div id="chat" class="tab-pane">
            <div class="chat-container">
                <div class="chat-sidebar">
                    <div class="chat-channels">
                        <h3>Channels</h3>
                        <ul class="channels-list">
                            <li class="active"><i class="fas fa-hashtag"></i> general</li>
                            <li><i class="fas fa-hashtag"></i> announcements</li>
                            <li><i class="fas fa-hashtag"></i> help</li>
                        </ul>
                        <button class="btn-secondary btn-sm" onclick="openCreateChannelModal()">
                            <i class="fas fa-plus"></i> New Channel
                        </button>
                    </div>
                </div>

                <div class="chat-main">
                    <div class="chat-header">
                        <h3><i class="fas fa-hashtag"></i> general</h3>
                    </div>

                    <div class="chat-messages" id="chat-messages-container">
                        <div class="chat-message">
                            <img src="{{ url_for('static', filename='images/logo-rounded.png') }}" alt="Profile" class="avatar">
                            <div class="message-content">
                                <div class="message-header">
                                    <span class="message-sender">Club Bot</span>
                                    <span class="message-time">Just now</span>
                                </div>
                                <p>Welcome to the club chat! This is where you and your members can communicate in real-time.</p>
                            </div>
                        </div>
                    </div>

                    <div class="chat-input">
                        <textarea placeholder="Message #general" id="chat-message-input"></textarea>
                        <button class="send-button" onclick="sendChatMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resources Tab Content -->
        <div id="resources" class="tab-pane">
            <div class="resources-container">
                <div class="resources-header">
                    <h3>Quick Links & Resources</h3>
                    <button class="btn-primary" onclick="openAddResourceModal()">
                        <i class="fas fa-plus"></i> Add Resource
                    </button>
                </div>

                <div class="resources-grid" id="resources-container">
                    <div class="resource-card">
                        <div class="resource-icon">
                            <i class="fas fa-book"></i>
                        </div>
                        <div class="resource-content">
                            <h3>Sample Resource</h3>
                            <p>This is an example resource that shows how your links will appear.</p>
                        </div>
                        <div class="resource-actions">
                            <a href="#" class="btn-primary btn-sm">Visit</a>
                            <button class="btn-icon"><i class="fas fa-ellipsis-v"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab Content -->
        <div id="settings" class="tab-pane">
            <div class="settings-container">
                <h3>Club Settings</h3>

                <div class="settings-card">
                    <div class="settings-section">
                        <h4>General Information</h4>
                        <form id="editClubForm">
                            <div class="form-group">
                                <label for="editClubName">Club Name</label>
                                <input type="text" id="editClubName" name="editClubName" value="{{ club.name }}" class="form-input">
                            </div>
                            <div class="form-group">
                                <label for="editClubLocation">Location</label>
                                <input type="text" id="editClubLocation" name="editClubLocation" value="{{ club.location }}" class="form-input">
                            </div>
                            <div class="form-group">
                                <label for="editClubDescription">Description</label>
                                <textarea id="editClubDescription" name="editClubDescription" rows="4" class="form-textarea">{{ club.description }}</textarea>
                            </div>
                            <button type="button" onclick="updateClub()" class="btn-primary">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                        </form>
                    </div>

                    <div class="settings-section danger-zone">
                        <h4>Danger Zone</h4>
                        <p>Deleting a club is permanent and will remove all members, posts, and assignments.</p>
                        <button class="btn-danger" onclick="openDeleteClubModal()">
                            <i class="fas fa-trash"></i> Delete Club
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Create Club Modal -->
<div id="createClubModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-users"></i> Create New Club</h2>
            <button class="close-btn" onclick="closeCreateClubModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="createClubForm">
                <div class="form-group">
                    <label for="clubName">Club Name <span class="required">*</span></label>
                    <input type="text" id="clubName" name="clubName" required placeholder="E.g., Hack Club Central High" class="form-input">
                </div>
                <div class="form-group">
                    <label for="clubLocation">Location</label>
                    <input type="text" id="clubLocation" name="clubLocation" placeholder="E.g., Room 203, Central High School" class="form-input">
                </div>

                <div class="form-group">
                    <label for="clubDescription">Description</label>
                    <textarea id="clubDescription" name="clubDescription" rows="4" placeholder="Tell us about your club..." class="form-textarea"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-actions">
            <button class="btn-secondary" onclick="closeCreateClubModal()">Cancel</button>
            <button class="btn-primary" onclick="createClub()">
                <i class="fas fa-plus"></i> Create Club
            </button>
        </div>
    </div>
</div>

<!-- Join Club Modal -->
<div id="joinClubModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-sign-in-alt"></i> Join a Club</h2>
            <button class="close-btn" onclick="closeJoinClubModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="joinCode">Club Join Code <span class="required">*</span></label>
                <input type="text" id="joinCode" name="joinCode" required placeholder="Enter the join code provided by your club leader" class="form-input">
            </div>
            <div class="info-box">
                <i class="fas fa-info-circle"></i>
                <p>By joining a club, you grant club leaders access to view and manage your spaces.</p>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn-secondary" onclick="closeJoinClubModal()">Cancel</button>
            <button class="btn-primary" onclick="joinClub()">
                <i class="fas fa-sign-in-alt"></i> Join Club
            </button>
        </div>
    </div>
</div>

<!-- Edit Club Modal (Same as Create but preloaded)-->
<div id="editClubModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-edit"></i> Edit Club</h2>
            <button class="close-btn" onclick="closeEditClubModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editClubForm">
                <div class="form-group">
                    <label for="editClubName">Club Name <span class="required">*</span></label>
                    <input type="text" id="editClubName" name="editClubName" required class="form-input">
                </div>
                <div class="form-group">
                    <label for="editClubLocation">Location</label>
                    <input type="text" id="editClubLocation" name="editClubLocation" class="form-input">
                </div>
                <div class="form-group">
                    <label for="editClubDescription">Description</label>
                    <textarea id="editClubDescription" name="editClubDescription" rows="4" class="form-textarea"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-actions">
            <button class="btn-secondary" onclick="closeEditClubModal()">Cancel</button>
            <button class="btn-primary" onclick="updateClub()">
                <i class="fas fa-save"></i> Save Changes
            </button>
        </div>
    </div>
</div>

<!-- Add Member Modal -->
<div id="addMemberModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-user-plus"></i> Add Member</h2>
            <button class="close-btn" onclick="closeAddMemberModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="join-code-info">
                <div class="info-card">
                    <h3><i class="fas fa-key"></i> Join Code</h3>
                    <p>Share your club's join code with members and let them join on their own.</p>
                    <div class="join-code-display">
                        {% if club.join_code %}
                            <div class="code-box">{{ club.join_code }}</div>
                            <button class="btn-primary" onclick="copyJoinCode()">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        {% else %}
                            <button class="btn-primary" onclick="generateJoinCode()">
                                <i class="fas fa-key"></i> Generate Join Code
                            </button>
                        {% endif %}
                    </div>
                    <p><small>Members can join by entering this code on their dashboard.</small></p>
                </div>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn-secondary" onclick="closeAddMemberModal()">Close</button>
        </div>
    </div>
</div>

<!-- Change Role Modal -->
<div id="changeRoleModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-user-tag"></i> Change Member Role</h2>
            <button class="close-btn" onclick="closeChangeRoleModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p>Change role for <span id="roleUsername" class="highlighted-text"></span>:</p>
            <input type="hidden" id="membershipIdForRole">
            <div class="role-selector">
                <label class="role-option">
                    <input type="radio" name="memberRole" value="member" id="roleMember">
                    <span class="role-card">
                        <i class="fas fa-user"></i>
                        <span>Member</span>
                        <span class="role-description">Regular club member with basic privileges</span>
                    </span>
                </label>
                <label class="role-option">
                    <input type="radio" name="memberRole" value="co-leader" id="roleLeader">
                    <span class="role-card">
                        <i class="fas fa-crown"></i>
                        <span>Co-Leader</span>
                        <span class="role-description">Can manage members and club settings</span>
                    </span>
                </label>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn-secondary" onclick="closeChangeRoleModal()">Cancel</button>
            <button class="btn-primary" onclick="changeRole()">
                <i class="fas fa-save"></i> Save Changes
            </button>
        </div>
    </div>
</div>

<!-- Create Assignment Modal -->
<div id="createAssignmentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-tasks"></i> Create Assignment</h2>
            <button class="close-btn" onclick="closeCreateAssignmentModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="createAssignmentForm">
                <div class="form-group">
                    <label for="assignmentTitle">Title <span class="required">*</span></label>
                    <input type="text" id="assignmentTitle" required class="form-input">
                </div>
                <div class="form-group">
                    <label for="assignmentDescription">Description <span class="required">*</span></label>
                    <textarea id="assignmentDescription" rows="4" required class="form-textarea"></textarea>
                </div>
                <div class="form-group">
                    <label for="assignmentDueDate">Due Date</label>
                    <input type="date" id="assignmentDueDate" class="form-input">
                </div>
                <div class="form-group">
                    <label>Assignment For:</label>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="assignAllMembers" checked> All Members
                        </label>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-actions">
            <button class="btn-secondary" onclick="closeCreateAssignmentModal()">Cancel</button>
            <button class="btn-primary" onclick="createAssignment()">
                <i class="fas fa-plus"></i> Create Assignment
            </button>
        </div>
    </div>
</div>

<!-- Add Resource Modal -->
<div id="addResourceModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-link"></i> Add Resource</h2>
            <button class="close-btn" onclick="closeAddResourceModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="addResourceForm">
                <div class="form-group">
                    <label for="resourceTitle">Title <span class="required">*</span></label>
                    <input type="text" id="resourceTitle" required class="form-input">
                </div>
                <div class="form-group">
                    <label for="resourceUrl">URL <span class="required">*</span></label>
                    <input type="url" id="resourceUrl" required class="form-input">
                </div>
                <div class="form-group">
                    <label for="resourceDescription">Description</label>
                    <textarea id="resourceDescription" rows="3" class="form-textarea"></textarea>
                </div>
                <div class="form-group">
                    <label for="resourceIcon">Icon</label>
                    <select id="resourceIcon" class="form-input">
                        <option value="book">Book</option>
                        <option value="link">Link</option>
                        <option value="file">File</option>
                        <option value="video">Video</option>
                        <option value="code">Code</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-actions">
            <button class="btn-secondary" onclick="closeAddResourceModal()">Cancel</button>
            <button class="btn-primary" onclick="addResource()">
                <i class="fas fa-plus"></i> Add Resource
            </button>
        </div>
    </div>
</div>

<!-- Create Channel Modal -->
<div id="createChannelModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-hashtag"></i> Create Channel</h2>
            <button class="close-btn" onclick="closeCreateChannelModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="createChannelForm">
                <div class="form-group">
                    <label for="channelName">Channel Name <span class="required">*</span></label>
                    <input type="text" id="channelName" required placeholder="e.g. homework-help" class="form-input">
                </div>
                <div class="form-group">
                    <label for="channelDescription">Description</label>
                    <textarea id="channelDescription" placeholder="What's this channel about?" rows="3" class="form-textarea"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-actions">
            <button class="btn-secondary" onclick="closeCreateChannelModal()">Cancel</button>
            <button class="btn-primary" onclick="createChannel()">
                <i class="fas fa-plus"></i> Create Channel
            </button>
        </div>
    </div>
</div>

<!-- Toast container for notifications -->
<div id="toast-container"></div>

<style>
/* ===== Base Styles ===== */
:root {
    --primary: #ec3750;
    --primary-dark: #cf142b;
    --primary-light: #ff5a69;
    --secondary: #e83e8c;
    --success: #059669;
    --warning: #d97706;
    --danger: #dc2626;
    --light: #f3f4f6;
    --dark: #1f2937;
    --text-primary: #111827;
    --text-secondary: #4b5563;
    --text-muted: #6b7280;
    --border-color: #e5e7eb;
    --card-bg: #ffffff;
    --body-bg: #f9fafb;
    --gradient-start: #ec3750;
    --gradient-end: #ff8c38;
}

.club-dashboard-container {
    max-width: 1200px;
    margin: 80px auto 40px;
    padding: 0 1.5rem;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
}

.dashboard-header {
    margin-bottom: 2rem;
}

.dashboard-header h1 {
    margin-bottom: 1.5rem;
    font-size: 2.25rem;
    font-weight: 700;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

/* Button Styles */
.btn-primary {
    background-color: var(--primary);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 10px 16px;
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s ease;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.btn-primary:hover {
    background-color: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.btn-secondary {
    background-color: var(--light);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 10px 16px;
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s ease;
}

.btn-secondary:hover {
    background-color: #e5e7eb;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.btn-danger {
    background-color: var(--danger);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 10px 16px;
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s ease;
}

.btn-danger:hover {
    background-color: #b91c1c;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.btn-icon {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background-color: var(--light);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-icon:hover {
    background-color: #e5e7eb;
    color: var(--primary);
    transform: translateY(-2px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.btn-sm {
    padding: 6px 12px;
    font-size: 0.8125rem;
}

/* Form Styles */
.form-input, 
.form-textarea {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 1rem;
    color: var(--text-primary);
    background-color: var(--light);
    transition: all 0.2s ease;
}

.form-input:focus,
.form-textarea:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(236, 55, 80, 0.2);
    outline: none;
}

.form-textarea {
    min-height: 120px;
    resize: vertical;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: var(--text-primary);
}

.required {
    color: var(--danger);
    margin-left: 3px;
}

/* Club Empty State */
.club-empty-state {
    background-color: var(--card-bg);
    border-radius: 16px;
    padding: 4rem 2rem;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05), 0 5px 10px rgba(0, 0, 0, 0.02);
    text-align: center;
    margin-bottom: 2rem;
}

.empty-icon {
    font-size: 5rem;
    color: var(--primary);
    margin-bottom: 2rem;
    opacity: 0.8;
}

.club-empty-state h2 {
    margin: 0 0 1rem;
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-primary);
}

.club-empty-state p {
    margin: 0 0 2rem;
    colorvar(--text-secondary);
    font-size: 1.25rem;
}

.empty-actions {
    display: flex;
    justify-content: center;
    gap: 1rem;
}

/* Club Info Header */
.club-info-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-color);
}

.club-info-header h2 {
    margin: 0;
    font-size: 1.875rem;
    font-weight: 700;
    color: var(--text-primary);
}

.club-actions {
    display: flex;
    gap: 1rem;
}

/* Tabs */
.club-tabs-container {
    background-color: var(--card-bg);
    border-radius: 16px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05), 0 5px 10px rgba(0, 0, 0, 0.02);
    padding: 2rem;
    margin-bottom: 2rem;
}

.tabs {
    display: flex;
    overflow-x: auto;
    background-color: var(--light);
    border-radius: 8px;
    padding: 0.5rem;
    gap: 0.5rem;
    margin-top: 1rem;
}

.tab-btn {
    padding: 0.75rem 1.25rem;
    border: none;
    background: none;
    color: var(--text-secondary);
    font-weight: 500;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 6px;
}

.tab-btn:hover {
    background-color: rgba(0, 0, 0, 0.05);
    color: var(--text-primary);
}

.tab-btn.active {
    background-color: white;
    color: var(--primary);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.tab-content {
    background-color: var(--card-bg);
    border-radius: 16px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05), 0 5px 10px rgba(0, 0, 0, 0.02);
    padding: 2rem;
}

.tab-pane {
    display: none;
}

.tab-pane.active {
    display: block;
}

/* Club Cards for Members View */
.clubs-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
}

.club-card {
    background-color: var(--card-bg);
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    overflow: hidden;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
}

.club-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
}

.club-card-header {
    padding: 1.5rem 1.5rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.club-card-header h3 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
}

.club-card-body {
    padding: 0 1.5rem 1.5rem;
    flex-grow: 1;
}

.club-card-body p {
    margin: 0 0 1rem;
    color: var(--text-secondary);
    font-size: 0.9375rem;
    line-height: 1.5;
}

.club-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    font-size: 0.875rem;
    color: var(--text-muted);
}

.club-card-footer {
    padding: 1rem 1.5rem;
    background-color: var(--light);
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
}

/* Stream Tab */
.stream-container {
    display: flex;
    flex-direction: column;
    gap: 2rem;
}

.post-composer {
    background-color: var(--light);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.composer-header {
    padding: 1rem 1.5rem;
    background-color: white;
    border-bottom: 1px solid var(--border-color);
}

.composer-header h3 {
    margin: 0;
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.composer-body {
    padding: 1.5rem;
}

.composer-body textarea {
    width: 100%;
    min-height: 100px;
    padding: 1rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    resize: vertical;
    font-size: 1rem;
    margin-bottom: 1rem;
}

.composer-body textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(236, 55, 80, 0.1);
}

.composer-actions {
    display: flex;
    justify-content: space-between;
}

.posts-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.post-card {
    background-color: white;
    border-radius: 12px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    padding: 1.5rem;
    border: 1px solid var(--border-color);
}

.post-header {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
}

.avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 1rem;
    object-fit: cover;
}

.post-info {
    flex-grow: 1;
}

.post-info h3 {
    margin: 0;
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-primary);
}

.post-date {
    font-size: 0.875rem;
    color: var(--text-muted);
}

.post-actions {
    position: relative;
    display: block !important;
}

.post-content {
    margin-bottom: 1.5rem;
    line-height: 1.6;
    color: var(--text-primary);
}

.post-footer {
    display: flex;
    gap: 1rem;
    border-top: 1px solid var(--border-color);
    padding-top: 1rem;
}

.post-action {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 0.9375rem;
    cursor: pointer;
    padding: 0.5rem 0.75rem;
    border-radius: 4px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 6px;
}

.post-action:hover {
    background-color: var(--light);
    color: var(--primary);
}

/* Assignments Tab */
.assignments-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.assignments-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.assignments-header h3 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
}

.assignments-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
}

.assignment-card {
    background-color: white;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    overflow: hidden;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.assignment-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
}

.assignment-status {
    padding: 0.75rem 1.5rem;
    background-color: #f8fafc;
    border-bottom: 1px solid var(--border-color);
}

.status-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 50px;
    font-size: 0.75rem;
    font-weight: 500;
}

.status-active {
    background-color: rgba(5, 150, 105, 0.1);
    color: #059669;
}

.assignment-body {
    padding: 1.5rem;
}

.assignment-body h3 {
    margin: 0 0 0.75rem;
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-primary);
}

.assignment-body p {
    margin: 0 0 1rem;
    color: var(--text-secondary);
    font-size: 0.9375rem;
    line-height: 1.5;
}

.assignment-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    font-size: 0.875rem;
    color: var(--text-muted);
}

.assignment-actions {
    padding: 1rem 1.5rem;
    background-color: #f8fafc;
    border-top: 1px solid var(--border-color);
    display: flex;
    gap: 0.5rem;
}

/* Members Tab */
.members-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.members-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.members-header h3 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
}

.members-table {
    width: 100%;
    border-collapse: collapse;
}

.members-table th,
.members-table td {
    padding: 1rem;
    text-align: left;
}

.members-table th {
    font-weight: 600;
    color: var(--text-secondary);
    background-color: var(--light);
}

.members-table tr {
    border-bottom: 1px solid var(--border-color);
}

.members-table tr:last-child {
    border-bottom: none;
}

.members-table tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.02);
}

.role-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 50px;
    font-size: 0.75rem;
    font-weight: 500;
    background-color: #e9ecef;
    color: var(--text-secondary);
}

.role-badge-leader {
    background-color: rgba(236, 55, 80, 0.15);
    color: var(--primary);
}

.action-buttons {
    display: flex;
    gap: 0.5rem;
}

/* Chat Tab */
.chat-container {
    display: flex;
    height: 600px;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
}

.chat-sidebar {
    width: 240px;
    background-color: #f8fafc;
    border-right: 1px solid var(--border-color);
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 2rem;
    overflow-y: auto;
}

.chat-channels h3 {
    margin: 0 0 1rem;
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.channels-list {
    list-style: none;
    padding: 0;
    margin: 0 0 1rem;
}

.channels-list li {
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    cursor: pointer;
    margin-bottom: 0.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9375rem;
    color: var(--text-secondary);
    transition: all 0.2s ease;
}

.channels-list li:hover {
    background-color: rgba(0, 0, 0, 0.05);
    color: var(--text-primary);
}

.channels-list li.active {
    background-color: rgba(236, 55, 80, 0.1);
    color: var(--primary);
    font-weight: 500;
}

.chat-main {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
}

.chat-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border-color);
    background-color: white;
}

.chat-header h3 {
    margin: 0;
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.chat-messages {
    flex-grow: 1;
    padding: 1.5rem;
    overflow-y: auto;
    background-color: white;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.chat-message {
    display: flex;
    gap: 1rem;
}

.message-content {
    flex-grow: 1;
}

.message-header {
    display: flex;
    align-items: baseline;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.message-sender {
    font-weight: 600;
    color: var(--text-primary);
}

.message-time {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.message-content p {
    margin: 0;
    color: var(--text-primary);
    line-height: 1.5;
}

.chat-input {
    padding: 1rem;
    border-top: 1px solid var(--border-color);
    background-color: white;
    display: flex;
    gap: 1rem;
}

.chat-input textarea {
    flex-grow: 1;
    padding: 0.75rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    resize: none;
    height: 2.5rem;
    max-height: 150px;
    line-height: 1.5;
    font-size: 0.9375rem;
}

.chat-input textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(236, 55, 80, 0.1);
}

.send-button {
    background-color: var(--primary);
    color: white;
    border: none;
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
}

.send-button:hover {
    background-color: var(--primary-dark);
    transform: translateY(-2px);
}

/* Resources Tab */
.resources-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.resources-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.resources-header h3 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
}

.resources-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 1.5rem;
}

.resource-card {
    background-color: white;
    border-radius: 12px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    padding: 1.5rem;
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    gap: 1rem;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.resource-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
}

.resource-icon {
    width: 3rem;
    height: 3rem;
    background-color: #f0fdf4;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #10b981;
    font-size: 1.5rem;
}

.resource-content h3 {
    margin: 0 0 0.5rem;
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-primary);
}

.resource-content p {
    margin: 0;
    font-size: 0.9375rem;
    color: var(--text-secondary);
    line-height: 1.5;
}

.resource-actions {
    margin-top: auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* Settings Tab */
.settings-container {
    padding: 1rem 0;
}

.settings-container h3 {
    margin: 0 0 1.5rem;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
}

.settings-card {
    background-color: white;
    border-radius: 12px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    border: 1px solid var(--border-color);
    overflow: hidden;
}

.settings-section {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
}

.settings-section:last-child {
    border-bottom: none;
}

.settings-section h4 {
    margin: 0 0 1.5rem;
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-primary);
}

.danger-zone {
    background-color: #fff5f5;
}

.danger-zone h4 {
    color: var(--danger);
}

.danger-zone p {
    margin: 0 0 1.5rem;
    color: var(--text-secondary);
    font-size: 0.9375rem;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1000;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    align-items: center;
    justify-content: center;
    padding: 1rem;
    animation: fadeIn 0.2s ease;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
}

.modal[style*="display: flex"],
.modal.visible {
    display: flex !important;
    opacity: 1 !important;
    visibility: visible !important;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal-content {
    background-color: var(--card-bg);
    border-radius: 16px;
    width: 100%;
    max-width: 550px;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from { transform: translateY(30px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem 2rem;
    border-bottom: 1px solid var(--border-color);
}

.modal-header h2 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 12px;
}

.close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--text-secondary);
    padding: 0;
    margin: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background-color 0.2s ease;
}

.close-btn:hover {
    background-color: var(--light);
    color: var(--text-primary);
}

.modal-body {
    padding: 2rem;
}

.modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    padding: 1.5rem 2rem;
    border-top: 1px solid var(--border-color);
}

/* Join Code Display */
.join-code-info {
    background-color: rgba(236, 55, 80, 0.05);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.info-card h3 {
    margin-top: 0;
    margin-bottom: 1rem;
    font-size: 1.25rem;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 12px;
}

.join-code-display {
    display: flex;
    align-items: center;
    gap: 16px;
    margin: 1.5rem 0;
}

.code-box {
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
    font-size: 1.25rem;
    font-weight: 600;
    letter-spacing: 0.1em;
    background-color: var(--light);
    padding: 12px 20px;
    border-radius: 8px;
    color: var(--primary);
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    border: 1px solid var(--border-color);
    flex-grow: 1;
    text-align: center;
}

/* Role Selector */
.role-selector {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin-top: 1rem;
}

.role-option {
    cursor: pointer;
    position: relative;
}

.role-option input {
    position: absolute;
    opacity: 0;
    cursor: pointer;
}

.role-card {
    display: flex;
    flex-direction: column;
    padding: 1.5rem;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    transition: all 0.2s ease;
}

.role-option input:checked + .role-card {
    border-color: var(--primary);
    background-color: rgba(236, 55, 80, 0.05);
}

.role-card i {
    font-size: 1.5rem;
    margin-bottom: 8px;
    color: var(--text-secondary);
}

.role-option input:checked + .role-card i {
    color: var(--primary);
}

.role-card span:nth-child(2) {
    font-weight: 600;
    font-size: 1.125rem;
    margin-bottom: 4px;
}

.role-description {
    font-size: 0.875rem;
    color: var(--text-muted);
}

/* Info Box */
.info-box {
    background-color: #f0f9ff;
    border-radius: 8px;
    padding: 1rem;
    display: flex;
    gap: 0.75rem;
    margin-top: 1rem;
}

.info-box i {
    color: #0ea5e9;
    font-size: 1.25rem;
    margin-top: 2px;
}

.info-box p {
    margin: 0;
    font-size: 0.9375rem;
    color: var(--text-secondary);
    line-height: 1.5;
}

/* Checkbox Styles */
.checkbox-group {
    margin-top: 0.5rem;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    font-size: 0.9375rem;
    color: var(--text-primary);
}

/* Responsive Adjustments */
@media (max-width: 992px) {
    .chat-container {
        flex-direction: column;
        height: auto;
    }

    .chat-sidebar {
        width: 100%;
        padding: 1rem;
    }

    .chat-messages {
        height: 400px;
    }

    .tabs {
        overflow-x: auto;
        flex-wrap: nowrap;
    }
}

@media (max-width: 768px) {
    .club-dashboard-container {
        padding: 0 1rem;
    }

    .club-info-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }

    .assignments-list, 
    .resources-grid {
        grid-template-columns: 1fr;
    }

    .members-table {
        display: block;
        overflow-x: auto;
    }

    .post-composer, 
    .post-card {
        padding: 1rem;
    }

    .modal-content {
        max-width: 100%;
    }
}

@media (max-width: 576px) {
    .dashboard-header h1 {
        font-size: 1.75rem;
    }

    .empty-actions {
        flex-direction: column;
        gap: 0.75rem;
    }

    .club-actions {
        flex-direction: column;
        width: 100%;
        gap: 0.5rem;
    }

    .club-actions button {
        width: 100%;
    }

    .join-code-display {
        flex-direction: column;
    }

    .club-card-header {
        flex-direction: column;
        gap: 0.5rem;
    }
}
</style>

<script>
// Tab functionality
function openTab(tabName) {
    const tabContents = document.querySelectorAll('.tab-pane');
    const tabButtons = document.querySelectorAll('.tab-btn');

    tabContents.forEach(tab => {
        tab.classList.remove('active');
    });

    tabButtons.forEach(button => {
        button.classList.remove('active');
    });

    document.getElementById(tabName).classList.add('active');
    document.querySelector(`.tab-btn[onclick="openTab('${tabName}')"]`).classList.add('active');
}

// Modal Functions with improved visibility handling
function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) return;

    modal.style.display = 'flex';
    modal.style.opacity = '1';
    modal.style.visibility = 'visible';
    modal.classList.add('visible');
    document.body.style.overflow = 'hidden';
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) return;

    modal.style.opacity = '0';
    modal.style.visibility = 'hidden';
    setTimeout(() => {
        modal.style.display = 'none';
        modal.classList.remove('visible');
        document.body.style.overflow = '';
    }, 300);
}

// Create Club Modal
function openCreateClubModal() {
    openModal('createClubModal');
}

function closeCreateClubModal() {
    closeModal('createClubModal');
    document.getElementById('createClubForm').reset();
}

// Join Club Modal
function openJoinClubModal() {
    openModal('joinClubModal');
}

function closeJoinClubModal() {
    closeModal('joinClubModal');
    document.getElementById('joinCode').value = '';
}

// Edit Club Modal
function openEditClubModal() {
    // Fetch current club data
    fetch('/api/clubs/current')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showToast('error', data.error);
                return;
            }

            document.getElementById('editClubName').value = data.name || '';
            document.getElementById('editClubLocation').value = data.location || '';
            document.getElementById('editClubDescription').value = data.description || '';

            openModal('editClubModal');
        })
        .catch(error => {
            showToast('error', 'Failed to fetch club details');
            console.error('Error:', error);
        });
}

function closeEditClubModal() {
    closeModal('editClubModal');
}

// Add Member Modal
function openAddMemberModal() {
    openModal('addMemberModal');
}

function closeAddMemberModal() {
    closeModal('addMemberModal');
}

// Change Role Modal
function openChangeRoleModal(membershipId, username, currentRole) {
    document.getElementById('membershipIdForRole').value = membershipId;
    document.getElementById('roleUsername').textContent = username;

    // Set the current role
    if (currentRole === 'member') {
        document.getElementById('roleMember').checked = true;
    } else if (currentRole === 'co-leader') {
        document.getElementById('roleLeader').checked = true;
    }

    openModal('changeRoleModal');
}

function closeChangeRoleModal() {
    closeModal('changeRoleModal');
}

// Create Assignment Modal
function openCreateAssignmentModal() {
    openModal('createAssignmentModal');
}

function closeCreateAssignmentModal() {
    closeModal('createAssignmentModal');
    document.getElementById('createAssignmentForm').reset();
}

// Add Resource Modal
function openAddResourceModal() {
    openModal('addResourceModal');
}

function closeAddResourceModal() {
    closeModal('addResourceModal');
    document.getElementById('addResourceForm').reset();
}

// Create Channel Modal
function openCreateChannelModal() {
    openModal('createChannelModal');
}

function closeCreateChannelModal() {
    closeModal('createChannelModal');
    document.getElementById('createChannelForm').reset();
}

// Copy join code to clipboard
function copyJoinCode() {
    const joinCodeDisplay = document.getElementById('join-code-display');
    if (joinCodeDisplay) {
        const joinCode = joinCodeDisplay.textContent;
        navigator.clipboard.writeText(joinCode).then(() => {
            showToast('success', 'Join code copied to clipboard');
        }).catch(err => {
            showToast('error', 'Failed to copy join code');
            console.error('Could not copy text: ', err);
        });
    }
}

// Generate new join code
function generateJoinCode() {
    fetch('/api/clubs/join-code/generate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            showToast('success', data.message);
            if (data.join_code) {
                const joinCodeDisplay = document.getElementById('join-code-display');
                if (joinCodeDisplay) {
                    joinCodeDisplay.textContent = data.join_code;
                }
            } else {
                setTimeout(() => {
                    location.reload();
                }, 1500);
            }
        } else if (data.error) {
            showToast('error', data.error);
        } else {
            showToast('error', 'Failed to generate join code');
        }
    })
    .catch(error => {
        showToast('error', 'Failed to generate join code');
        console.error('Error:', error);
    });
}

// Create club functionality
function createClub() {
    const formData = {
        name: document.getElementById('clubName').value.trim(),
        location: document.getElementById('clubLocation').value.trim(),
        description: document.getElementById('clubDescription').value.trim()
    };

    if (!formData.name) {
        showToast('error', 'Club name is required');
        return;
    }

    fetch('/api/clubs', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            showToast('success', data.message);
            closeCreateClubModal();
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else if (data.error) {
            showToast('error', data.error);
        } else {
            showToast('error', 'Failed to create club');
        }
    })
    .catch(error => {
        showToast('error', 'Failed to create club');
        console.error('Error:', error);
    });
}

// Join club functionality
function joinClub() {
    const joinCode = document.getElementById('joinCode').value.trim();

    if (!joinCode) {
        showToast('error', 'Join code is required');
        return;
    }

    fetch('/api/clubs/join', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ join_code: joinCode })
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            showToast('success', data.message);
            closeJoinClubModal();
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else if (data.error) {
            showToast('error', data.error);
        } else {
            showToast('error', 'Failed to join club');
        }
    })
    .catch(error => {
        showToast('error', 'Failed to join club');
        console.error('Error:', error);
    });
}

// Update club functionality
function updateClub() {
    const formData = {
        name: document.getElementById('editClubName').value.trim(),
        location: document.getElementById('editClubLocation').value.trim(),
        description: document.getElementById('editClubDescription').value.trim()
    };

    if (!formData.name) {
        showToast('error', 'Club name is required');
        return;
    }

    fetch('/api/clubs/current', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            showToast('success', data.message);
            closeEditClubModal();
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else if (data.error) {
            showToast('error', data.error);
        } else {
            showToast('error', 'Failed to update club');
        }
    })
    .catch(error => {
        showToast('error', 'Failed to update club');
        console.error('Error:', error);
    });
}

// Change member role
function changeRole() {
    const membershipId = document.getElementById('membershipIdForRole').value;
    const selectedRole = document.querySelector('input[name="memberRole"]:checked').value;

    fetch(`/api/clubs/members/${membershipId}/role`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ role: selectedRole })
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            showToast('success', data.message);
            closeChangeRoleModal();
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else if (data.error) {
            showToast('error', data.error);
        } else {
            showToast('error', 'Failed to update member role');
        }
    })
    .catch(error => {
        showToast('error', 'Failed to update member role');
        console.error('Error:', error);
    });
}

// Get club ID from the page
function getClubId() {
    // Try to get from the club-info-header data attribute
    const clubInfoHeader = document.querySelector('.club-info-header');
    if (clubInfoHeader && clubInfoHeader.dataset.clubId) {
        return clubInfoHeader.dataset.clubId;
    }

    // Fallback to URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const clubId = urlParams.get('club_id');
    if (clubId) {
        return clubId;
    }

    // If all else fails, try to find it in the DOM
    const clubIdElement = document.querySelector('[data-club-id]');
    if (clubIdElement) {
        return clubIdElement.dataset.clubId;
    }

    return null;
}

// Fetch and display posts
function loadPosts() {
    const clubId = getClubId();
    if (!clubId) {
        console.error('Could not determine club ID');
        return;
    }

    const postsContainer = document.getElementById('posts-container');
    postsContainer.innerHTML = `
        <div class="loading-state">
            <div class="loading-spinner"></div>
            <p>Loading posts...</p>
        </div>
    `;

    fetch(`/api/clubs/${clubId}/posts`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showToast('error', data.error);
                return;
            }

            if (data.posts.length === 0) {
                postsContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-comment-slash"></i>
                        <p>No posts yet. Be the first to post!</p>
                    </div>
                `;
                return;
            }

            postsContainer.innerHTML = '';

            data.posts.forEach(post => {
                const postCard = document.createElement('div');
                postCard.classList.add('post-card');
                postCard.setAttribute('data-post-id', post.id);

                const postDate = new Date(post.created_at);
                const formattedDate = postDate.toLocaleString();

                // Get the current user ID from body data attribute or use alternative method
                const userId = document.querySelector('body').dataset.userId;
                const currentUserId = userId ? parseInt(userId) : null;
                const isCurrentUser = post.user.id === currentUserId;

                // Check if the current user has liked this post
                const liked = post.liked_by ? post.liked_by.includes(currentUserId) : false;
                const likesCount = post.likes || 0;

                postCard.innerHTML = `
                    <div class="post-header">
                        <img src="/static/images/logo-rounded.png" alt="Profile" class="avatar">
                        <div class="post-info">
                            <h3>${post.user.username}</h3>
                            <span class="post-date">${formattedDate}</span>
                        </div>
                        <div class="post-actions">
                            <button class="btn-icon post-menu-btn" onclick="togglePostMenu(${post.id})">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <div class="post-menu" id="post-menu-${post.id}">
                                ${isCurrentUser ? `
                                <button onclick="editPost(${post.id})">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                ` : ''}
                                <button class="delete-btn" onclick="deletePost(${post.id})">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="post-content">
                        <p>${post.content}</p>
                    </div>
                    <div class="post-footer">
                        <button class="post-action" onclick="toggleLike(${post.id})">
                            <i class="${liked ? 'fas' : 'far'} fa-heart"></i> 
                            <span id="like-count-${post.id}">${likesCount}</span> Likes
                        </button>
                        
                    </div>
                `;

                postsContainer.appendChild(postCard);
            });
        })
        .catch(error => {
            console.error('Error loading posts:', error);
            postsContainer.innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-circle"></i>
                    <p>Failed to load posts. Please try again.</p>
                </div>
            `;
        });
}

// Toggle post menu
function togglePostMenu(postId) {
    const menu = document.getElementById(`post-menu-${postId}`);
    if (!menu) {
        console.error(`Menu element with ID post-menu-${postId} not found`);
        return;
    }

    menu.classList.toggle('active');

    // Close other open menus
    document.querySelectorAll('.post-menu.active').forEach(openMenu => {
        if (openMenu.id !== `post-menu-${postId}`) {
            openMenu.classList.remove('active');
        }
    });

    // Close menu when clicking outside
    document.addEventListener('click', function closeMenuOutside(e) {
        if (!e.target.closest('.post-menu') && !e.target.closest('.post-menu-btn')) {
            menu.classList.remove('active');
            document.removeEventListener('click', closeMenuOutside);
        }
    });

    // Prevent the click event from propagating
    event.stopPropagation();
}

// Edit post
function editPost(postId) {
    const postCard = document.querySelector(`.post-card[data-post-id="${postId}"]`);
    const postContent = postCard.querySelector('.post-content p').textContent;

    // Create edit form
    const contentArea = postCard.querySelector('.post-content');
    const originalContent = contentArea.innerHTML;

    contentArea.innerHTML = `
        <textarea class="edit-post-textarea" id="edit-post-${postId}">${postContent}</textarea>
        <div class="edit-actions">
            <button class="btn-secondary" onclick="cancelEditPost(${postId}, '${encodeURIComponent(originalContent)}')">
                Cancel
            </button>
            <button class="btn-primary" onclick="saveEditPost(${postId})">
                Save
            </button>
        </div>
    `;

    // Focus the textarea
    const textarea = document.getElementById(`edit-post-${postId}`);
    textarea.focus();
    textarea.setSelectionRange(textarea.value.length, textarea.value.length);
}

// Cancel post edit
function cancelEditPost(postId, originalContent) {
    const postCard = document.querySelector(`.post-card[data-post-id="${postId}"]`);
    const contentArea = postCard.querySelector('.post-content');
    contentArea.innerHTML = decodeURIComponent(originalContent);
}

// Save post edit
function saveEditPost(postId) {
    const clubId = getClubId();
    const textarea = document.getElementById(`edit-post-${postId}`);
    const content = textarea.value.trim();

    if (!content) {
        showToast('error', 'Post content cannot be empty');
        return;
    }

    fetch(`/api/clubs/${clubId}/posts/${postId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ content })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showToast('error', data.error);
            return;
        }

        const postCard = document.querySelector(`.post-card[data-post-id="${postId}"]`);
        const contentArea = postCard.querySelector('.post-content');
        contentArea.innerHTML = `<p>${data.post.content}</p>`;

        showToast('success', 'Post updated successfully');
    })
    .catch(error => {
        console.error('Error updating post:', error);
        showToast('error', 'Failed to update post');
    });
}

// Delete post
function deletePost(postId) {
    if (!confirm('Are you sure you want to delete this post?')) {
        return;
    }

    const clubId = getClubId();

    fetch(`/api/clubs/${clubId}/posts/${postId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showToast('error', data.error);
            return;
        }

        const postCard = document.querySelector(`.post-card[data-post-id="${postId}"]`);
        postCard.classList.add('fade-out');

        setTimeout(() => {
            postCard.remove();
            if (document.querySelectorAll('.post-card').length === 0) {
                document.getElementById('posts-container').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-comment-slash"></i>
                        <p>No posts yet. Be the first to post!</p>
                    </div>
                `;
            }
        }, 300);

        showToast('success', 'Post deleted successfully');
    })
    .catch(error => {
        console.error('Error deleting post:', error);
        showToast('error', 'Failed to delete post');
    });
}

// Create a new post in the stream
function createPost() {
    const content = document.getElementById('post-content').value.trim();

    if (!content) {
        showToast('error', 'Post content cannot be empty');
        return;
    }

    const clubId = getClubId();

    fetch(`/api/clubs/${clubId}/posts`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ content })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showToast('error', data.error);
            return;
        }

        // Clear any empty state
        const postsContainer = document.getElementById('posts-container');
        if (postsContainer.querySelector('.empty-state')) {
            postsContainer.innerHTML = '';
        }

        // Create new post element
        const newPost = document.createElement('div');
        newPost.classList.add('post-card');
        newPost.setAttribute('data-post-id', data.post.id);

        const postDate = new Date(data.post.created_at);
        const formattedDate = postDate.toLocaleString();

        newPost.innerHTML = `
            <div class="post-header">
                <img src="/static/images/logo-rounded.png" alt="Profile" class="avatar">
                <div class="post-info">
                    <h3>${data.post.user.username}</h3>
                    <span class="post-date">${formattedDate}</span>
                </div>
                <div class="post-actions">
                    <button class="btn-icon post-menu-btn" onclick="togglePostMenu(${data.post.id})">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <div class="post-menu" id="post-menu-${data.post.id}">
                        <button onclick="editPost(${data.post.id})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="delete-btn" onclick="deletePost(${data.post.id})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
            <div class="post-content">
                <p>${data.post.content}</p>
            </div>
            <div class="post-footer">
                <button class="post-action" onclick="toggleLike(${data.post.id})">
                    <i class="far fa-heart"></i> <span id="like-count-${data.post.id}">0</span> Likes
                </button>
                
            </div>
        `;

        // Add to top of posts container
        postsContainer.insertBefore(newPost, postsContainer.firstChild);

        // Clear input
        document.getElementById('post-content').value = '';

        // Show success message
        showToast('success', 'Post created successfully');
    })
    .catch(error => {
        console.error('Error creating post:', error);
        showToast('error', 'Failed to create post');
    });
}

// Load assignments
function loadAssignments() {
    const clubId = getClubId();
    if (!clubId) {
        console.error('Could not determine club ID');
        return;
    }

    const assignmentsContainer = document.getElementById('assignments-container');
    assignmentsContainer.innerHTML = `
        <div class="loading-state">
            <div class="loading-spinner"></div>
            <p>Loading assignments...</p>
        </div>
    `;

    fetch(`/api/clubs/${clubId}/assignments`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showToast('error', data.error);
                return;
            }

            if (data.assignments.length === 0) {
                assignmentsContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-tasks"></i>
                        <p>No assignments yet. Create one to get started.</p>
                    </div>
                `;
                return;
            }

            assignmentsContainer.innerHTML = '';

            data.assignments.forEach(assignment => {
                const assignmentCard = document.createElement('div');
                assignmentCard.classList.add('assignment-card');
                assignmentCard.setAttribute('data-assignment-id', assignment.id);

                let dueDate = 'No due date';
                if (assignment.due_date) {
                    const date = new Date(assignment.due_date);
                    dueDate = date.toLocaleDateString();
                }

                assignmentCard.innerHTML = `
                    <div class="assignment-status">
                        <span class="status-badge ${assignment.is_active ? 'status-active' : 'status-inactive'}">
                            ${assignment.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </div>
                    <div class="assignment-body">
                        <h3>${assignment.title}</h3>
                        <p>${assignment.description}</p>
                        <div class="assignment-meta">
                            <span><i class="fas fa-calendar-alt"></i> Due: ${dueDate}</span>
                            <span><i class="fas fa-user"></i> By: ${assignment.creator.username}</span>
                        </div>
                    </div>
                    <div class="assignment-actions">
                        <button class="btn-primary" onclick="viewAssignment(${assignment.id})">
                            <i class="fas fa-eye"></i> View
                        </button>
                        <button class="btn-secondary" onclick="editAssignment(${assignment.id})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn-danger" onclick="deleteAssignment(${assignment.id})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                `;

                assignmentsContainer.appendChild(assignmentCard);
            });
        })
        .catch(error => {
            console.error('Error loading assignments:', error);
            assignmentsContainer.innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-circle"></i>
                    <p>Failed to load assignments. Please try again.</p>
                </div>
            `;
        });
}

// View assignment details
function viewAssignment(assignmentId) {
    const clubId = getClubId();

    fetch(`/api/clubs/${clubId}/assignments/${assignmentId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Server returned ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                showToast('error', data.error);
                return;
            }

            // Format due date for display
            let formattedDueDate = 'None';
            if (data.assignment.due_date) {
                const dueDate = new Date(data.assignment.due_date);
                formattedDueDate = dueDate.toLocaleDateString() + ' ' + dueDate.toLocaleTimeString();
            }

            // Create and show modal with assignment details
            const detailsHtml = `
                <div class="assignment-details-modal">
                    <h2>${data.assignment.title}</h2>
                    <p class="details-meta">Due: ${formattedDueDate}</p>
                    <div class="details-content">${data.assignment.description}</div>
                </div>
            `;

            // Create modal to display details
            const modalContainer = document.createElement('div');
            modalContainer.className = 'modal';
            modalContainer.style.display = 'flex';
            modalContainer.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2><i class="fas fa-tasks"></i> Assignment Details</h2>
                        <button class="close-btn" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${detailsHtml}
                    </div>
                    <div class="modal-actions">
                        <button class="btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modalContainer);
        })
        .catch(error => {
            console.error('Error fetching assignment:', error);
            showToast('error', 'Failed to load assignment details: ' + error.message);
        });
}

// Edit assignment
function editAssignment(assignmentId) {
    // Fetch assignment data and pre-fill edit form
    const clubId = getClubId();

    fetch(`/api/clubs/${clubId}/assignments/${assignmentId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Server returned ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                showToast('error', data.error);
                return;
            }

            const assignment = data.assignment;

            // Open modal and prefill data
            document.getElementById('assignmentTitle').value = assignment.title;
            document.getElementById('assignmentDescription').value = assignment.description;
            if (assignment.due_date) {
                document.getElementById('assignmentDueDate').value = assignment.due_date.split('T')[0];
            }

            // Change the save button behavior
            const saveBtn = document.querySelector('#createAssignmentModal .modal-actions .btn-primary');
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Update Assignment';
            saveBtn.onclick = function() {
                updateAssignment(assignmentId);
            };

            openCreateAssignmentModal();
        })
        .catch(error => {
            console.error('Error fetching assignment for edit:', error);
            showToast('error', 'Failed to load assignment details: ' + error.message);
        });
}

// Update assignment
function updateAssignment(assignmentId) {
    const clubId = getClubId();
    const title = document.getElementById('assignmentTitle').value.trim();
    const description = document.getElementById('assignmentDescription').value.trim();
    const dueDate = document.getElementById('assignmentDueDate').value;

    if (!title || !description) {
        showToast('error', 'Title and description are required');
        return;
    }

    const data = {
        title,
        description,
        due_date: dueDate || null
    };

    fetch(`/api/clubs/${clubId}/assignments/${assignmentId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showToast('error', data.error);
            return;
        }

        showToast('success', 'Assignment updated successfully');
        closeCreateAssignmentModal();

        // Reset the save button
        const saveBtn = document.querySelector('#createAssignmentModal .modal-actions .btn-primary');
        saveBtn.innerHTML = '<i class="fas fa-plus"></i> Create Assignment';
        saveBtn.onclick = createAssignment;

        // Reload assignments
        loadAssignments();
    })
    .catch(error => {
        console.error('Error updating assignment:', error);
        showToast('error', 'Failed to update assignment');
    });
}

// Delete assignment
function deleteAssignment(assignmentId) {
    if (!confirm('Are you sure you want to delete this assignment?')) {
        return;
    }

    const clubId = getClubId();

    fetch(`/api/clubs/${clubId}/assignments/${assignmentId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showToast('error', data.error);
            return;
        }

        const assignmentCard = document.querySelector(`.assignment-card[data-assignment-id="${assignmentId}"]`);
        assignmentCard.classList.add('fade-out');

        setTimeout(() => {
            assignmentCard.remove();
            if (document.querySelectorAll('.assignment-card').length === 0) {
                document.getElementById('assignments-container').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-tasks"></i>
                        <p>No assignments yet. Create one to get started.</p>
                    </div>
                `;
            }
        }, 300);

        showToast('success', 'Assignment deleted successfully');
    })
    .catch(error => {
        console.error('Error deleting assignment:', error);
        showToast('error', 'Failed to delete assignment');
    });
}

// Create a new assignment
function createAssignment() {
    const clubId = getClubId();
    const title = document.getElementById('assignmentTitle').value.trim();
    const description = document.getElementById('assignmentDescription').value.trim();
    const dueDate = document.getElementById('assignmentDueDate').value;

    if (!title || !description) {
        showToast('error', 'Title and description are required');
        return;
    }

    const data = {
        title,
        description,
        due_date: dueDate || null
    };

    fetch(`/api/clubs/${clubId}/assignments`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showToast('error', data.error);
            return;
        }

        showToast('success', 'Assignment created successfully');
        closeCreateAssignmentModal();

        // Clear form
        document.getElementById('createAssignmentForm').reset();

        // Reload assignments
        loadAssignments();
    })
    .catch(error => {
        console.error('Error creating assignment:', error);
        showToast('error', 'Failed to create assignment');
    });
}

// Load resources
function loadResources() {
    const clubId = getClubId();
    if (!clubId) {
        console.error('Could not determine club ID');
        return;
    }

    const resourcesContainer = document.getElementById('resources-container');
    resourcesContainer.innerHTML = `
        <div class="loading-state">
            <div class="loading-spinner"></div>
            <p>Loading resources...</p>
        </div>
    `;

    fetch(`/api/clubs/${clubId}/resources`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showToast('error', data.error);
                return;
            }

            if (data.resources.length === 0) {
                resourcesContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-link"></i>
                        <p>No resources yet. Add some links to get started.</p>
                    </div>
                `;
                return;
            }

            resourcesContainer.innerHTML = '';

            data.resources.forEach(resource => {
                const resourceCard = document.createElement('div');
                resourceCard.classList.add('resource-card');
                resourceCard.setAttribute('data-resource-id', resource.id);

                resourceCard.innerHTML = `
                    <div class="resource-icon">
                        <i class="fas fa-${resource.icon || 'link'}"></i>
                    </div>
                    <div class="resource-content">
                        <h3>${resource.title}</h3>
                        <p>${resource.description || 'No description provided'}</p>
                    </div>
                    <div class="resource-actions">
                        <a href="${resource.url}" target="_blank" class="btn-primary btn-sm">
                            <i class="fas fa-external-link-alt"></i> Visit
                        </a>
                        <button class="btn-icon resource-menu-btn" onclick="toggleResourceMenu(${resource.id})">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <div class="resource-menu" id="resource-menu-${resource.id}">
                            <button onclick="editResource(${resource.id})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="delete-btn" onclick="deleteResource(${resource.id})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `;

                resourcesContainer.appendChild(resourceCard);
            });
        })
        .catch(error => {
            console.error('Error loading resources:', error);
            resourcesContainer.innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-circle"></i>
                    <p>Failed to load resources. Please try again.</p>
                </div>
            `;
        });
}

// Toggle resource menu
function toggleResourceMenu(resourceId) {
    const menu = document.getElementById(`resource-menu-${resourceId}`);
    menu.classList.toggle('active');

    // Close other open menus
    document.querySelectorAll('.resource-menu.active, .post-menu.active').forEach(openMenu => {
        if (openMenu.id !== `resource-menu-${resourceId}`) {
            openMenu.classList.remove('active');
        }
    });

    // Close menu when clicking outside
    document.addEventListener('click', function closeMenuOutside(e) {
        if (!e.target.closest('.resource-menu') && !e.target.closest('.resource-menu-btn')) {
            menu.classList.remove('active');
            document.removeEventListener('click', closeMenuOutside);
        }
    });

    // Prevent the click event from propagating
    event.stopPropagation();
}

// Edit resource
function editResource(resourceId) {
    const clubId = getClubId();

    fetch(`/api/clubs/${clubId}/resources/${resourceId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Server returned ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                showToast('error', data.error);
                return;
            }

            const resource = data.resource;

            // Open modal and prefill data
            document.getElementById('resourceTitle').value = resource.title;
            document.getElementById('resourceUrl').value = resource.url;
            document.getElementById('resourceDescription').value = resource.description || '';
            document.getElementById('resourceIcon').value = resource.icon || 'link';

            // Change the save button behavior
            const saveBtn = document.querySelector('#addResourceModal .modal-actions .btn-primary');
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Update Resource';
            saveBtn.onclick = function() {
                updateResource(resourceId);
            };

            openAddResourceModal();
        })
        .catch(error => {
            console.error('Error fetching resource for edit:', error);
            showToast('error', 'Failed to load resource details: ' + error.message);
        });
}

// Update resource
function updateResource(resourceId) {
    const clubId = getClubId();
    const title = document.getElementById('resourceTitle').value.trim();
    const url = document.getElementById('resourceUrl').value.trim();
    const description = document.getElementById('resourceDescription').value.trim();
    const icon = document.getElementById('resourceIcon').value;

    if (!title || !url) {
        showToast('error', 'Title and URL are required');
        return;
    }

    const data = {
        title,
        url,
        description,
        icon
    };

    fetch(`/api/clubs/${clubId}/resources/${resourceId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showToast('error', data.error);
            return;
        }

        showToast('success', 'Resource updated successfully');
        closeAddResourceModal();

        // Reset the save button
        const saveBtn = document.querySelector('#addResourceModal .modal-actions .btn-primary');
        saveBtn.innerHTML = '<i class="fas fa-plus"></i> Add Resource';
        saveBtn.onclick = addResource;

        // Reload resources
        loadResources();
    })
    .catch(error => {
        console.error('Error updating resource:', error);
        showToast('error', 'Failed to update resource');
    });
}

// Delete resource
function deleteResource(resourceId) {
    if (!confirm('Are you sure you want to delete this resource?')) {
        return;
    }

    const clubId = getClubId();

    fetch(`/api/clubs/${clubId}/resources/${resourceId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showToast('error', data.error);
            return;
        }

        const resourceCard = document.querySelector(`.resource-card[data-resource-id="${resourceId}"]`);
        resourceCard.classList.add('fade-out');

        setTimeout(() => {
            resourceCard.remove();
            if (document.querySelectorAll('.resource-card').length === 0) {
                document.getElementById('resources-container').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-link"></i>
                        <p>No resources yet. Add some links to get started.</p>
                    </div>
                `;
            }
        }, 300);

        showToast('success', 'Resource deleted successfully');
    })
    .catch(error => {
        console.error('Error deleting resource:', error);
        showToast('error', 'Failed to delete resource');
    });
}

// Add a new resource/link
function addResource() {
    const clubId = getClubId();
    const title = document.getElementById('resourceTitle').value.trim();
    const url = document.getElementById('resourceUrl').value.trim();
    const description = document.getElementById('resourceDescription').value.trim();
    const icon = document.getElementById('resourceIcon').value;

    if (!title || !url) {
        showToast('error', 'Title and URL are required');
        return;
    }

    const data = {
        title,
        url,
        description,
        icon
    };

    fetch(`/api/clubs/${clubId}/resources`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showToast('error', data.error);
            return;
        }

        showToast('success', 'Resource added successfully');
        closeAddResourceModal();

        // Clear form
        document.getElementById('addResourceForm').reset();

        // Reload resources
        loadResources();
    })
    .catch(error => {
        console.error('Error adding resource:', error);
        showToast('error', 'Failed to add resource');
    });
}

// Load chat channels
function loadChatChannels() {
    const clubId = getClubId();
    if (!clubId) {
        console.error('Could not determine club ID');
        return;
    }

    const channelsList = document.querySelector('.channels-list');
    channelsList.innerHTML = `
        <li><div class="loading-spinner-small"></div> Loading...</li>
    `;

    fetch(`/api/clubs/${clubId}/channels`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showToast('error', data.error);
                return;
            }

            if (data.channels.length === 0) {
                // Create a default general channel
                createDefaultChannel();
                return;
            }

            channelsList.innerHTML = '';

            data.channels.forEach(channel => {
                const channelItem = document.createElement('li');
                channelItem.setAttribute('data-channel-id', channel.id);
                channelItem.innerHTML = `<i class="fas fa-hashtag"></i> ${channel.name}`;

                // Make general channel active by default
                if (channel.name === 'general') {
                    channelItem.classList.add('active');
                    loadChannelMessages(channel.id);
                }

                channelItem.addEventListener('click', () => {
                    document.querySelectorAll('.channels-list li').forEach(item => {
                        item.classList.remove('active');
                    });
                    channelItem.classList.add('active');
                    loadChannelMessages(channel.id);

                    // Update chat header
                    document.querySelector('.chat-header h3').innerHTML = `<i class="fas fa-hashtag"></i> ${channel.name}`;
                });

                channelsList.appendChild(channelItem);
            });

            // If no channel was set as active, select the first one
            if (!document.querySelector('.channels-list li.active') && data.channels.length > 0) {
                const firstChannel = document.querySelector('.channels-list li');
                firstChannel.classList.add('active');
                loadChannelMessages(firstChannel.dataset.channelId);
            }
        })
        .catch(error => {
            console.error('Error loading channels:', error);
            channelsList.innerHTML = `
                <li class="error-item">
                    <i class="fas fa-exclamation-circle"></i> Failed to load channels
                </li>
            `;
        });
}

// Create default general channel if none exists
function createDefaultChannel() {
    const clubId = getClubId();

    fetch(`/api/clubs/${clubId}/channels`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            name: 'general',
            description: 'General discussion channel'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showToast('error', data.error);
            return;
        }

        // Reload channels after creating default
        loadChatChannels();
    })
    .catch(error => {
        console.error('Error creating default channel:', error);
        showToast('error', 'Failed to create default channel');
    });
}

// Load messages for a channel
function loadChannelMessages(channelId) {
    const clubId = getClubId();
    if (!clubId || !channelId) {
        console.error('Missing club ID or channel ID');
        return;
    }

    const messagesContainer = document.getElementById('chat-messages-container');
    messagesContainer.innerHTML = `
        <div class="loading-state">
            <div class="loading-spinner"></div>
            <p>Loading messages...</p>
        </div>
    `;

    // Store current channel ID in the chat input data attribute
    document.getElementById('chat-message-input').dataset.channelId = channelId;

    fetch(`/api/clubs/${clubId}/channels/${channelId}/messages`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showToast('error', data.error);
                return;
            }

            if (data.messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-comments"></i>
                        <p>No messages yet. Start the conversation!</p>
                    </div>
                `;
                return;
            }

            messagesContainer.innerHTML = '';

            data.messages.forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.classList.add('chat-message');

                const messageDate = new Date(message.created_at);
                const formattedDate = messageDate.toLocaleString();

                messageElement.innerHTML = `
                    <img src="/static/images/logo-rounded.png" alt="Profile" class="avatar">
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-sender">${message.user.username}</span>
                            <span class="message-time">${formattedDate}</span>
                        </div>
                        <p>${message.content}</p>
                    </div>
                `;

                messagesContainer.appendChild(messageElement);
            });

            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        })
        .catch(error => {
            console.error('Error loading messages:', error);
            messagesContainer.innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-circle"></i>
                    <p>Failed to load messages. Please try again.</p>
                </div>
            `;
        });
}

// Create a new chat channel
function createChannel() {
    const clubId = getClubId();
    const channelName = document.getElementById('channelName').value.trim().toLowerCase();
    const channelDescription = document.getElementById('channelDescription').value.trim();

    if (!channelName) {
        showToast('error', 'Channel name is required');
        return;
    }

    // Validate channel name (only lowercase letters, numbers, and hyphens)
    if (!/^[a-z0-9\-]+$/.test(channelName)) {
        showToast('error', 'Channel name can only contain lowercase letters, numbers, and hyphens');
        return;
    }

    fetch(`/api/clubs/${clubId}/channels`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            name: channelName,
            description: channelDescription
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showToast('error', data.error);
            return;
        }

        showToast('success', 'Channel created successfully');
        closeCreateChannelModal();

        // Clear form
        document.getElementById('createChannelForm').reset();

        // Reload channels
        loadChatChannels();
    })
    .catch(error => {
        console.error('Error creating channel:', error);
        showToast('error', 'Failed to create channel');
    });
}

// Send a chat message
function sendChatMessage() {
    const messageInput = document.getElementById('chat-message-input');
    const message = messageInput.value.trim();
    const channelId = messageInput.dataset.channelId;
    const clubId = getClubId();

    if (!message) {
        return;
    }

    if (!channelId) {
        showToast('error', 'No channel selected');
        return;
    }

    fetch(`/api/clubs/${clubId}/channels/${channelId}/messages`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ content: message })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showToast('error', data.error);
            return;
        }

        // Clear input
        messageInput.value = '';

        // Add message to chat
        const messagesContainer = document.getElementById('chat-messages-container');

        // Clear empty state if needed
        if (messagesContainer.querySelector('.empty-state')) {
            messagesContainer.innerHTML = '';
        }

        const messageElement = document.createElement('div');
        messageElement.classList.add('chat-message');

        const messageDate = new Date(data.chat_message.created_at);
        const formattedDate = messageDate.toLocaleString();

        messageElement.innerHTML = `
            <img src="/static/images/logo-rounded.png" alt="Profile" class="avatar">
            <div class="message-content">
                <div class="message-header">
                    <span class="message-sender">${data.chat_message.user.username}</span>
                    <span class="message-time">${formattedDate}</span>
                </div>
                <p>${data.chat_message.content}</p>
            </div>
        `;

        messagesContainer.appendChild(messageElement);

        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    })
    .catch(error => {
        console.error('Error sending message:', error);
        showToast('error', 'Failed to send message');
    });
}

// Initialize everything when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Make sure the active tab is set
    const activeTab = document.querySelector('.tab-btn.active');
    if (activeTab) {
        const tabName = activeTab.getAttribute('onclick').match(/openTab\('(.+?)'\)/)[1];
        openTab(tabName);

        // Load data for active tab
        if (tabName === 'stream') {
            loadPosts();
        } else if (tabName === 'assignments') {
            loadAssignments();
        } else if (tabName === 'resources') {
            loadResources();
        } else if (tabName === 'chat') {
            loadChatChannels();
        }
    }

    // Add tab change handlers
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const tabName = this.getAttribute('onclick').match(/openTab\('(.+?)'\)/)[1];

            // Load data when switching to tab
            if (tabName === 'stream') {
                loadPosts();
            } else if (tabName === 'assignments') {
                loadAssignments();
            } else if (tabName === 'resources') {
                loadResources();
            } else if (tabName === 'chat') {
                loadChatChannels();
            }
        });
    });

    // Make chat input send on Enter key
    document.getElementById('chat-message-input').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendChatMessage();
        }
    });
});

// Display toast notifications
function showToast(type, message) {
    const toastContainer = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.classList.add('toast', `toast-${type}`);

    let icon = '';
    switch (type) {
        case 'success':
            icon = '<i class="fas fa-check-circle"></i>';
            break;
        case 'error':
            icon = '<i class="fas fa-exclamation-circle"></i>';
            break;
        case 'warning':
            icon = '<i class="fas fa-exclamation-triangle"></i>';
            break;
        case 'info':
            icon = '<i class="fas fa-info-circle"></i>';
            break;
    }

    toast.innerHTML = `
        <div class="toast-content">
            ${icon}
            <span>${message}</span>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
    `;

    toastContainer.appendChild(toast);

    // Auto-remove the toast after 5 seconds
    setTimeout(() => {
        toast.classList.add('toast-fade-out');
        setTimeout(() => {
            toast.remove();
        }, 300);
    }, 5000);
}

// View a specific club for members with multiple clubs
function viewClub(clubId) {
    window.location.href = `/club-dashboard?club_id=${clubId}`;
}

// Initialize when document is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Make sure the active tab is set
    const activeTab = document.querySelector('.tab-btn.active');
    if (activeTab && activeTab.getAttribute('onclick')) {
        const match = activeTab.getAttribute('onclick').match(/openTab\('(.+?)'\)/);
        if (match && match[1]) {
            openTab(match[1]);
        }
    }
    
    // Add null checks for document event listeners
    const createChannelForm = document.getElementById('createChannelForm');
    if (createChannelForm) {
        createChannelForm.addEventListener('submit', function(e) {
            e.preventDefault();
            createChannel();
        });
    }
    
    const chatMessageInput = document.getElementById('chat-message-input');
    if (chatMessageInput) {
        chatMessageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChatMessage();
            }
        });
    }
});

function openDeleteClubModal() {
    if (confirm('Are you sure you want to delete this club? This action cannot be undone.')) {
        const clubId = getClubId();
        if (clubId) {
            fetch(`/api/clubs/current`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showToast('error', data.error);
                    return;
                }

                showToast('success', 'Club deleted successfully');
                setTimeout(() => {
                    window.location.href = '/club-dashboard';
                }, 1500);
            })
            .catch(error => {
                console.error('Error deleting club:', error);
                showToast('error', 'Failed to delete club');
            });
        }
    }
}

function changeClubMemberRole(membershipId, username, currentRole) {

}

function toggleLike(postId) {
    const clubId = getClubId();
    const likeCountSpan = document.getElementById(`like-count-${postId}`);
    const likeButtonIcon = likeCountSpan.previousElementSibling; // Get the i element

    fetch(`/api/clubs/${clubId}/posts/${postId}/like`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showToast('error', data.error);
            return;
        }

        const liked = data.liked;
        const likesCount = data.likes;
        likeCountSpan.textContent = likesCount;
        likeButtonIcon.className = liked ? 'fas fa-heart' : 'far fa-heart'; // Update class name
    })
    .catch(error => {
        console.error('Error toggling like:', error);
        showToast('error', 'Failed to toggle like');
    });
}


</script>
<style>
.post-menu {
    position: absolute;
    right: 0;
    top: 100%;
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    z-index: 10;
    display: none;
    min-width: 150px;
    padding: 8px 0;
}

.post-menu.active {
    display: block;
}

.post-menu button {
    display: block;
    width: 100%;
    padding: 8px 16px;
    text-align: left;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 0.9rem;
    color: var(--text-primary);
    transition: background-color 0.2s;
}

.post-menu button:hover {
    background-color: var(--light);
}

.post-menu button.delete-btn {
    color: var(--danger);
}

.post-menu button.delete-btn:hover,
.resource-menu button.delete-btn:hover {
    background-color: rgba(220, 38, 38, 0.1);
}

.resource-menu {
    position: absolute;
    right: 0;
    top: 100%;
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    z-index: 10;
    display: none;
    min-width: 150px;
    padding: 8px 0;
}

.resource-menu.active {
    display: block;
}

.resource-menu button {
    display: block;
    width: 100%;
    padding: 8px 16px;
    text-align: left;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 0.9rem;
    color: var(--text-primary);
    transition: background-color 0.2s;
}

.resource-menu button:hover {
    background-color: var(--light);
}

.resource-actions {
    position: relative;
}
</style>

{% endblock %}