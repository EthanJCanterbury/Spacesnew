{% extends "base.html" %}

{% block content %}
<div class="club-dashboard-container">
    <!-- Sidebar Navigation -->
    <div class="club-sidebar">
        <div class="club-profile">
            <div class="profile-avatar">
                <i class="fas fa-users"></i>
            </div>
            <div class="profile-info">
                <h3>{% if club %}{{ club.name }}{% else %}Club Dashboard{% endif %}</h3>
                <span class="club-badge">{% if club and current_user.id == club.leader_id %}Club Leader{% elif club %}Member{% else %}No Club{% endif %}</span>
            </div>
        </div>

        <nav class="club-nav">
            <ul>
                <li>
                    <a href="#dashboard" class="nav-link active" data-section="dashboard">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </li>

<style>
    /* Button styles for modals */
    .modal-footer {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 10px;
        padding: 15px;
    }

    .btn-primary {
        background-color: #ec3750;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 10px 20px;
        font-weight: 500;
        cursor: pointer;
        display: inline-block;
        font-size: 14px;
        text-align: center;
        min-width: 120px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .btn-secondary {
        background-color: transparent;
        color: #333;
        border: none;
        padding: 10px 20px;
        font-weight: 500;
        cursor: pointer;
        display: inline-block;
        font-size: 14px;
        text-align: center;
    }

    /* System fonts only (to avoid CSP issues) */
    :root {
        --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
        --font-mono: SFMono-Regular, Menlo, Monaco, Consolas, 'Courier New', monospace;
    }

    body, button, input, select, textarea {
        font-family: var(--font-sans);
    }

    code, pre {
        font-family: var(--font-mono);
    }

    /* Meeting styles */
    .meeting-item {
        background-color: #fff;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        border: 1px solid var(--border-color);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .meeting-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .meeting-item h3 {
        margin-top: 0;
        margin-bottom: 8px;
        color: var(--primary);
        font-size: 1.1rem;
    }

    .meeting-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 8px;
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    .meeting-meta span {
        display: flex;
        align-items: center;
    }

    .meeting-meta i {
        margin-right: 5px;
        width: 16px;
        color: var(--primary);
    }

    .meeting-actions {
        margin-top: 12px;
        display: flex;
        gap: 8px;
    }

    /* Event modal styling */
    .event-detail-row {
        margin-bottom: 16px;
    }

    .event-detail-label {
        font-weight: 500;
        margin-right: 8px;
        display: inline-block;
        width: 100px;
        color: #555;
    }

    .event-detail-label i {
        width: 16px;
        margin-right: 6px;
        color: #ec3750;
    }

    #eventModalDescription {
        margin-top: 8px;
        line-height: 1.5;
        color: #333;
    }
</style>

                <li>
                    <a href="#stream" class="nav-link" data-section="stream">
                        <i class="fas fa-stream"></i>
                        <span>Stream</span>
                    </a>
                </li>
                <li>
                    <a href="#assignments" class="nav-link" data-section="assignments">
                        <i class="fas fa-tasks"></i>
                        <span>Assignments</span>
                    </a>
                </li>
                <li>
                    <a href="#members" class="nav-link" data-section="members">
                        <i class="fas fa-user-friends"></i>
                        <span>Members</span>
                    </a>
                </li>
                <li>
                    <a href="#projects" class="nav-link" data-section="projects">
                        <i class="fas fa-code"></i>
                        <span>Projects</span>
                    </a>
                </li>
                <li>

<script>
    let currentEventId = null;

    function openEventModal(eventData) {
        try {
            currentEventId = eventData.eventId;
            const titleEl = document.getElementById('eventModalTitle');
            const dateEl = document.getElementById('eventDate');
            const timeEl = document.getElementById('eventTime');
            const locationEl = document.getElementById('eventLocation');
            const descriptionEl = document.getElementById('eventDescription');

            if (titleEl) titleEl.textContent = eventData.eventTitle;
            if (dateEl) dateEl.textContent = new Date(eventData.eventDate).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            if (timeEl) timeEl.textContent = eventData.eventTime;
            if (locationEl) locationEl.textContent = eventData.eventLocation;
            if (descriptionEl) descriptionEl.textContent = eventData.eventDescription;

            openModal('eventDetailsModal');
        } catch (error) {
            console.error('Error in openEventModal:', error);
            showToast('error', 'Failed to open event details');
        }
    }

    function closeEventModal() {
        closeModal('eventDetailsModal');
        currentEventId = null;
    }
    function formatDate(dateStr) {
        try {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        } catch (e) {
            return dateStr;
        }
    }
</script>


                    <a href="#resources" class="nav-link" data-section="resources">
                        <i class="fas fa-link"></i>
                        <span>Resources</span>
                    </a>
                </li>
                <li>
                    <a href="#schedule" class="nav-link" data-section="schedule">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Schedule</span>
                    </a>
                </li>
                <li>
                    <a href="#rewards" class="nav-link" data-section="rewards">
                        <i class="fas fa-gift"></i>
                        <span>Rewards</span>
                    </a>
                </li>
                {% if current_user.id == club.leader_id or (club.members|selectattr('user_id', 'eq', current_user.id)|selectattr('role', 'eq', 'co-leader')|list|length > 0) %}
                <li>
                    <a href="#hackatime" class="nav-link" data-section="hackatime">
                        <i class="fas fa-clock"></i>
                        <span>Hackatime</span>
                    </a>
                </li>
                <li>
                    <a href="#pizza" class="nav-link" data-section="pizza">
                        <i class="fas fa-pizza-slice"></i>
                        <span>Pizza</span>
                    </a>
                </li>
                {% endif %}
                {% if current_user.id == club.leader_id or (club.members|selectattr('user_id', 'eq', current_user.id)|selectattr('role', 'eq', 'co-leader')|list|length > 0) %}
                <li>
                    <a href="#settings" class="nav-link" data-section="settings">
                        <i class="fas fa-cogs"></i>
                        <span>Settings</span>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>

        <div class="club-sidebar-footer">
            <div class="sidebar-collapse-btn" id="sidebarCollapseBtn">
                <i class="fas fa-chevron-left"></i>
            </div>
            <a href="/logout" class="logout-link">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </a>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="club-content">
        <!-- Horizontal Navbar -->
        <div class="horizontal-navbar">
            <div class="navbar-title">
                <h1><i class="fas fa-users"></i> {% if club %}{{ club.name }}{% else %}Club Dashboard{% endif %}</h1>
            </div>
            <div class="navbar-actions">
                {% if club %}
                    {% if current_user.id == club.leader_id or (club.members|selectattr('user_id', 'eq', current_user.id)|selectattr('role', 'eq', 'co-leader')|list|length > 0) %}
                        <button class="btn-edit" onclick="openClubSettings()">
                            <i class="fas fa-edit"></i> Edit Club
                        </button>
                        <script>
                            function openClubSettings() {
                                // Switch to the settings tab
                                const settingsTab = document.querySelector('a[href="#settings"]');
                                if (settingsTab) {
                                    settingsTab.click();
                                } else {
                                    // Fallback if tab navigation doesn't work
                                    const settingsSection = document.getElementById('settings');
                                    if (settingsSection) {
                                        // Hide all sections
                                        document.querySelectorAll('.club-section').forEach(section => {
                                            section.classList.remove('active');
                                        });
                                        // Show settings section
                                        settingsSection.classList.add('active');
                                        // Update nav links
                                        document.querySelectorAll('.nav-link').forEach(link => {
                                            link.classList.remove('active');
                                        });
                                        document.querySelector('a[href="#settings"]').classList.add('active');
                                    }
                                }
                            }
                        </script>
                        <button class="btn-join-code" onclick="generateJoinCode()">
                            <i class="fas fa-key"></i> Join Code: <span id="join-code-display">{{ club.join_code }}</span>
                        </button>
                    {% else %}
                        <div class="club-info">
                            <span class="join-code-display-only"><i class="fas fa-users"></i> Member since: {{ current_user.club_memberships|selectattr('club_id', 'eq', club.id)|map(attribute='joined_at')|first|default('', true)|string|truncate(10, True, '') }}</span>
                        </div>
                    {% endif %}
                {% endif %}
            </div>
        </div>

        {% if not club %}
        <!-- Empty State -->
        <div class="club-empty-state">
            <div class="empty-icon">
                <i class="fas fa-users-slash"></i>
            </div>
            <h2>You haven't joined any clubs yet</h2>
            <p>Join an existing club with a join code or create your own!</p>
            <div class="empty-actions">
                <button class="btn-primary" onclick="openCreateClubModal()">
                    <i class="fas fa-plus"></i> Create Club
                </button>
                <button class="btn-secondary" onclick="openJoinClubModal()">
                    <i class="fas fa-sign-in-alt"></i> Join Club
                </button>
            </div>

            <script>
                function createClub() {
                    const clubName = document.getElementById('clubName').value;
                    const clubLocation = document.getElementById('clubLocation').value;
                    const clubDescription = document.getElementById('clubDescription').value;

                    if (!clubName) {



                        showToast('error', 'Please enter a club name');
                        return;
                    }

                    const clubData = {
                        name: clubName,
                        location: clubLocation, 
                        description: clubDescription
                    };

                    fetch('/api/clubs', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(clubData)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            showToast('error', data.error);
                        } else {
                            showToast('success', 'Club created successfully!');
                            closeCreateClubModal();
                            // Redirect to the new club dashboard
                            window.location.href = `/club-dashboard/${data.club_id}`;
                        }
                    })
                    .catch(error => {
                        showToast('error', 'Failed to create club');
                        console.error('Error:', error);
                    });
                }

                function joinClub() {
                    const joinCode = document.getElementById('joinCode').value;

                    if (!joinCode) {
                        showToast('error', 'Please enter a join code');
                        return;
                    }

                    fetch('/api/clubs/join', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ join_code: joinCode })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            showToast('error', data.error);
                        } else {
                            showToast('success', 'Joined club successfully!');
                            closeJoinClubModal();
                            // Redirect to the club dashboard
                            window.location.href = `/club-dashboard/${data.club_id}`;
                        }
                    })
                    .catch(error => {
                        showToast('error', 'Failed to join club');
                        console.error('Error:', error);
                    });
                }
            </script>
        </div>

        {% elif current_user.club_memberships|length > 0 and not club %}
        <!-- Member View of Clubs -->
        <div class="my-clubs-section">
            <h2>My Clubs</h2>
            <div class="clubs-grid">
                {% for membership in current_user.club_memberships %}
                <div class="club-card" onclick="viewClub({{ membership.club.id }})">
                    <div class="club-card-header">
                        <h3>{{ membership.club.name }}</h3>
                        <span class="role-badge {% if membership.role == 'co-leader' %}role-badge-leader{% endif %}">
                            {{ membership.role|capitalize }}
                        </span>
                    </div>
                    <div class="club-card-body">
                        <p>{{ membership.club.description or 'No description available' }}</p>
                        <div class="club-meta">
                            <span><i class="fas fa-map-marker-alt"></i> {{ membership.club.location or 'No location' }}</span>
                            <span><i class="fas fa-user-friends"></i> {{ membership.club.members|length }} members</span>
                        </div>
                    </div>
                    <div class="club-card-footer">
                        <button class="btn-primary">View Club</button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% else %}

        <!-- Dashboard Section -->
        <section id="dashboard" class="club-section active">
            <div class="section-header" style="text-align: center; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                <h2 style="text-align: center;"><i class="fas fa-tachometer-alt"></i> Dashboard</h2>
                <p style="text-align: center; width: 100%;">Welcome to {% if club %}{{ club.name }}{% else %}your club{% endif %}</p>
                <p class="club-subtitle" style="text-align: center; width: 100%;">Manage your hack club and empower your members with coding skills</p>
            </div>

            <div class="club-info-bar">
                <div class="club-code-box">
                    <span class="club-code-label"><i class="fas fa-key"></i> Join Code:</span>
                    <span class="club-code-value">{{ club.join_code }}</span>
                    <button class="refresh-code-btn" onclick="generateJoinCode()" title="Refresh Join Code">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>

            <div class="dashboard-card-grid">
                <!-- Club Members Card -->
                <div class="dashboard-feature-card">
                    <div class="card-icon member-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="card-content">
                        <div class="card-header">
                            <h3>Club Members</h3>
                            <span class="card-subtitle">{% if current_user.id == club.leader_id or (club.members|selectattr('user_id', 'eq', current_user.id)|selectattr('role', 'eq', 'co-leader')|list|length > 0) %}Manage Members{% else %}View Members{% endif %}</span>
                        </div>
                        <div class="card-metric">
                            <span class="metric-value">{{ club.members|length + 1 }}</span> total members
                        </div>
                        <p class="card-description">{% if current_user.id == club.leader_id or (club.members|selectattr('user_id', 'eq', current_user.id)|selectattr('role', 'eq', 'co-leader')|list|length > 0) %}View and manage all your club members{% else %}View club members{% endif %}</p>
                        <div class="card-action">
                            <a href="#members" class="btn-action" onclick="openTab('members')">
                                <i class="fas fa-{% if current_user.id == club.leader_id or (club.members|selectattr('user_id', 'eq', current_user.id)|selectattr('role', 'eq', 'co-leader')|list|length > 0) %}plus{% else %}users{% endif %}"></i> {% if current_user.id == club.leader_id or (club.members|selectattr('user_id', 'eq', current_user.id)|selectattr('role', 'eq', 'co-leader')|list|length > 0) %}Add & View Members{% else %}View Members{% endif %}
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Club Meetings Card -->
                <div class="dashboard-feature-card">
                    <div class="card-icon meeting-icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="card-content">
                        <div class="card-header">
                            <h3>Club Meetings</h3>
                            <span class="card-subtitle">{% if current_user.id == club.leader_id or (club.members|selectattr('user_id', 'eq', current_user.id)|selectattr('role', 'eq', 'co-leader')|list|length > 0) %}Schedule Meetings{% else %}View Meetings{% endif %}</span>
                        </div>
                        <p class="card-description">{% if current_user.id == club.leader_id or (club.members|selectattr('user_id', 'eq', current_user.id)|selectattr('role', 'eq', 'co-leader')|list|length > 0) %}Planning your next club meeting{% else %}View upcoming club meetings{% endif %}</p>
                        <div class="card-action">
                            <a href="#schedule" class="btn-action" onclick="openTab('schedule')">
                                <i class="fas fa-{% if current_user.id == club.leader_id or (club.members|selectattr('user_id', 'eq', current_user.id)|selectattr('role', 'eq', 'co-leader')|list|length > 0) %}plus{% else %}calendar-alt{% endif %}"></i> {% if current_user.id == club.leader_id or (club.members|selectattr('user_id', 'eq', current_user.id)|selectattr('role', 'eq', 'co-leader')|list|length > 0) %}Schedule Meeting{% else %}View Meetings{% endif %}
                            </a>
                        </div>
                    </div>
                </div>

                {% if current_user.id == club.leader_id or (club.members|selectattr('user_id', 'eq', current_user.id)|selectattr('role', 'eq', 'co-leader')|list|length > 0) %}
                <!-- Club Budget Card (Leaders Only) -->
                <div class="dashboard-feature-card">
                    <div class="card-icon budget-icon">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="card-content">
                        <div class="card-header">
                            <h3>Club Budget</h3>
                            <span class="card-subtitle">Manage Finances</span>
                        </div>
                        <p class="card-description">Track your club expenses and funding</p>
                        <div class="card-action">
                            <a href="#resources" class="btn-action" onclick="openTab('resources')">
                                <i class="fas fa-eye"></i> View Resources
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Club Tasks Card -->
                <div class="dashboard-feature-card">
                    <div class="card-icon task-icon">
                        <i class="fas fa-tasks"></i>
                    </div>
                    <div class="card-content">
                        <div class="card-header">
                            <h3>Club Tasks</h3>
                            <span class="card-subtitle">{% if current_user.id == club.leader_id or (club.members|selectattr('user_id', 'eq', current_user.id)|selectattr('role', 'eq', 'co-leader')|list|length > 0) %}Manage Tasks{% else %}View Tasks{% endif %}</span>
                        </div>
                        <p class="card-description">{% if current_user.id == club.leader_id or (club.members|selectattr('user_id', 'eq', current_user.id)|selectattr('role', 'eq', 'co-leader')|list|length > 0) %}Assign coding challenges to members{% else %}View assigned coding challenges{% endif %}</p>
                        <div class="card-action">
                            <a href="#assignments" class="btn-action" onclick="openTab('assignments')">
                                <i class="fas fa-{% if current_user.id == club.leader_id or (club.members|selectattr('user_id', 'eq', current_user.id)|selectattr('role', 'eq', 'co-leader')|list|length > 0) %}plus{% else %}list-ul{% endif %}"></i> {% if current_user.id == club.leader_id or (club.members|selectattr('user_id', 'eq', current_user.id)|selectattr('role', 'eq', 'co-leader')|list|length > 0) %}Create Task{% else %}View Tasks{% endif %}
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Learning Pathways Card -->
                <div class="dashboard-feature-card">
                    <div class="card-icon pathway-icon">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div class="card-content">
                        <div class="card-header">
                            <h3>Learning Pathways</h3>
                            <span class="card-subtitle">Member Progress</span>
                        </div>
                        <p class="card-description">Track member coding project progress</p>
                        <div class="card-action">
                            <a href="#projects" class="btn-action" onclick="openTab('projects')">
                                <i class="fas fa-eye"></i> View Pathways
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Resources Card -->
                <div class="dashboard-feature-card">
                    <div class="card-icon resources-icon">
                        <i class="fas fa-book"></i>
                    </div>
                    <div class="card-content">
                        <div class="card-header">
                            <h3>{% if current_user.id == club.leader_id or (club.members|selectattr('user_id', 'eq', current_user.id)|selectattr('role', 'eq', 'co-leader')|list|length > 0) %}Leader Resources{% else %}Club Resources{% endif %}</h3>
                            <span class="card-subtitle">Hack Club Resources</span>
                        </div>
                        <p class="card-description">Access Hack Club workshops and resources</p>
                        <div class="card-action">
                            <a href="#resources" class="btn-action" onclick="openTab('resources')">
                                <i class="fas fa-link"></i> Access Resources
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="dashboard-secondary-row">
                <div class="dashboard-card upcoming-meetings">
                    <div class="card-header">
                        <h3><i class="fas fa-calendar"></i> Upcoming Meetings</h3>
                        <a href="#schedule" class="card-link" onclick="openTab('schedule')">Schedule</a>
                    </div>
                    <div class="card-content" id="upcoming-meetings-mini">
                        <div class="loading-state">
                            <div class="loading-spinner"></div>
                            <p>Loading upcoming meetings...</p>
                        </div>
                    </div>
                </div>

                <div class="dashboard-card active-assignments">
                    <div class="card-header">
                        <h3><i class="fas fa-clipboard-list"></i> Active Assignments</h3>
                        <a href="#assignments" class="card-link" onclick="openTab('assignments')">View All</a>
                    </div>
                    <div class="card-content" id="active-assignments-mini">
                        <div class="loading-state">
                            <div class="loading-spinner"></div>
                            <p>Loading active assignments...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hidden counters for dashboard stats -->
            <div style="display: none;">
                <span id="projectCount">0</span>
                <span id="assignmentCount">0</span>
            </div>

            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    // Load mini dashboards when the dashboard is active
                    loadMiniDashboards();
                });

                function loadMiniDashboards() {
                    try {
                        // Load upcoming meetings mini dashboard
                        fetch(`/api/clubs/{{ club.id }}/meetings?limit=2&upcoming=true`)
                        .then(response => response.json())
                        .then(data => {
                            const container = document.getElementById('upcoming-meetings-mini');
                            if (!container) return;

                        container.innerHTML = '';

                        if (data.meetings && data.meetings.length > 0) {
                            data.meetings.forEach(meeting => {
                                const meetingDate = new Date(meeting.meeting_date);
                                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

                                const meetingEl = document.createElement('div');
                                meetingEl.className = 'upcoming-meeting';
                                meetingEl.innerHTML = `
                                    <div class="meeting-date">
                                        <span class="date-num">${meetingDate.getDate()}</span>
                                        <span class="date-month">${monthNames[meetingDate.getMonth()]}</span>
                                    </div>
                                    <div class="meeting-details">
                                        <h4>${meeting.title}</h4>
                                        <p><i class="fas fa-clock"></i> ${meeting.start_time}${meeting.end_time ? ` - ${meeting.end_time}` : ''}</p>
                                        <p><i class="fas fa-map-marker-alt"></i> ${meeting.location || 'No location set'}</p>
                                    </div>
                                `;
                                container.appendChild(meetingEl);
                            });
                        } else {
                            container.innerHTML = '<div class="empty-state">No upcoming meetings. <a href="#schedule" onclick="openTab(\'schedule\')">Schedule one!</a></div>';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading meetings:', error);
                        const container = document.getElementById('upcoming-meetings-mini');
                        if (container) {
                            container.innerHTML = '<div class="error-state">Failed to load meetings.</div>';
                        }
                    });
                    } catch (err) {
                        console.log("Error loading mini dashboards:", err);
                    }

                    try {
                        // Load active assignments mini dashboard
                    fetch(`/api/clubs/{{ club.id }}/assignments?limit=2&active=true`)
                    .then(response => response.json())
                    .then(data => {
                        const container = document.getElementById('active-assignments-mini');
                        if (!container) return;

                        container.innerHTML = '';

                        if (data.assignments && data.assignments.length > 0) {
                            data.assignments.forEach(assignment => {
                                const assignmentEl = document.createElement('div');
                                assignmentEl.className = 'assignment-item';
                                assignmentEl.innerHTML = `
                                    <div class="assignment-status">
                                        <span class="status-badge status-active">Active</span>
                                    </div>
                                    <div class="assignment-details">
                                        <h4>${assignment.title}</h4>
                                        <p>${assignment.description.length > 80 ? assignment.description.substring(0, 80) + '...' : assignment.description}</p>
                                        <div class="assignment-meta">
                                            ${assignment.due_date ? 
                                            `<span><i class="fas fa-calendar-alt"></i> Due: ${new Date(assignment.due_date).toLocaleDateString()}</span>` : 
                                            '<span><i class="fas fa-infinity"></i> No due date</span>'}
                                        </div>
                                    </div>
                                `;
                                container.appendChild(assignmentEl);
                            });
                        } else {
                            container.innerHTML = '<div class="empty-state">No active assignments. <a href="#assignments" onclick="openTab(\'assignments\')">Create one!</a></div>';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading assignments:', error);
                        const container = document.getElementById('active-assignments-mini');
                        if (container) {
                            container.innerHTML = '<div class="error-state">Failed to load assignments.</div>';
                        }
                    });
                    } catch (err) {
                        console.log("Error loading assignments dashboard:", err);
                    }
                }
            </script>

            <style>
                .club-subtitle {
                    color: #666;
                    margin-top: 0;
                    font-size: 0.9rem;
                    text-align: center;
                }

                .club-info-bar {
                    display: flex;
                    background-color: #f8f9fa;
                    padding: 15px;
                    border-radius: 8px;
                    margin-bottom: 24px;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                }

                .club-code-box {
                    display: flex;
                    align-items: center;
                }

                .club-code-label {
                    font-weight: 500;
                    margin-right: 10px;
                    color: #555;
                }

                .club-code-value {
                    background-color: #ec3750;
                    color: white;
                    padding: 3px 10px;
                    border-radius: 4px;
                    font-family: monospace;
                    font-weight: bold;
                    letter-spacing: 1px;
                }

                .refresh-code-btn {
                    background: none;
                    border: none;
                    color: #666;
                    cursor: pointer;
                    margin-left: 10px;
                    transition: transform 0.2s ease;
                }

                .refresh-code-btn:hover {
                    transform: scale(1.1);
                }

                .dashboard-card-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                    grid-gap: 24px;
                    margin-bottom: 24px;
                }

                .dashboard-feature-card {
                    background-color: #fff;
                    border-radius: 8px;
                    padding: 20px;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
                    transition: transform 0.2s ease, box-shadow 0.2s ease;
                }

                .dashboard-feature-card:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                }

                .card-icon {
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    width: 60px;
                    height: 60px;
                    background-color: #f8f9fa;
                    border-radius: 50%;
                    margin-bottom: 15px;
                    margin-right: 15px;
                }

                .member-icon, .meeting-icon, .budget-icon, .task-icon, .pathway-icon, .resources-icon {
                    color: #ec3750;
                    font-size: 2rem;
                }

                .card-content {
                    display: flex;
                    flex-direction: column;
                    align-items: flex-start;
                }

                .card-header h3 {
                    margin-top: 0;
                    font-size: 1.2rem;
                    color: #333;
                }

                .card-subtitle {
                    font-size: 0.9rem;
                    color: #666;
                    margin-bottom: 10px;
                }

                .card-metric {
                    font-size: 1.4rem;
                    font-weight: 500;
                    color: #333;
                    margin-bottom: 8px;
                }

                .card-description {
                    font-size: 1rem;
                    line-height: 1.5;
                    color: #666;
                    margin-bottom: 15px;
                }

                .card-action {
                    display: flex;
                    align-items: center;
                }

                .btn-action {
                    background-color: #ec3750;
                    color: white;
                    padding: 8px 16px;
                    border-radius: 4px;
                    font-size: 1rem;
                    font-weight: 500;
                    cursor: pointer;
                    transition: transform 0.2s ease;
                    border: none;
                    margin-right: 5px;
                    display: inline-block;
                }

                .btn-action:hover {
                    transform: scale(1.05);
                }

                .btn-action i {
                    margin-right: 5px;
                }

                .dashboard-secondary-row {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                    grid-gap: 24px;
                    margin-bottom: 24px;
                }

                .dashboard-card {
                    background-color: #fff;
                    border-radius: 8px;
                    padding: 20px;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
                    transition: transform 0.2s ease, box-shadow 0.2s ease;
                }

                .dashboard-card:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                }

                .card-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 15px;
                }

                .card-header h3 {
                    margin-top: 0;
                    font-size: 1.1rem;
                    color: #333;
                }

                .card-link {
                    color: #ec3750;
                    text-decoration: none;
                    font-weight: 500;
                    transition: transform 0.2s ease;
                }

                .card-link:hover {
                    transform: scale(1.1);
                }

                .upcoming-meetings, .active-assignments {
                    display: flex;
                    flex-direction: column;
                    align-items: flex-start;
                }

                .upcoming-meeting, .assignment-item {
                    background-color: #f8f9fa;
                    padding: 10px;
                    margin-bottom: 10px;
                    border-radius: 4px;
                }

                .upcoming-meeting .meeting-date {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    margin-right: 10px;
                }

                .upcoming-meeting .date-num {
                    font-size: 1.2rem;
                    font-weight: bold;
                    color: #333;
                }

                .upcoming-meeting .date-month {
                    font-size: 0.9rem;
                    color: #666;
                }

                .upcoming-meeting .meeting-details h4 {
                    margin-top: 0;
                    font-size: 1rem;
                    color: #333;
                }

                .upcoming-meeting .meeting-details p {
                    font-size: 0.9rem;
                    color: #666;
                    margin-bottom: 2px;
                }

                .assignment-item .assignment-status {
                    display: flex;
                    justify-content: flex-start;
                    align-items: center;
                    margin-right: 10px;
                    margin-bottom: 5px;
                }

                .status-badge {
                    background-color: #28a745;
                    color: white;
                    padding: 4px 8px;
                    border-radius: 4px;
                    font-size: 0.8rem;
                    font-weight: bold;
                    text-transform: uppercase;
                }

                .status-active {
                    background-color: #ffc107;
                }

                .assignment-item .assignment-details h4 {
                    margin-top: 0;
                    font-size: 1rem;
                    color: #333;
                }

                .assignment-item .assignment-details p {
                    font-size: 0.9rem;
                    color: #666;
                    margin-bottom: 5px;
                }

                .assignment-meta {
                    display: flex;
                    align-items: center;
                    font-size: 0.8rem;
                    color: #666;
                }

                .assignment-meta span {
                    margin-right: 10px;
                }

                .empty-state, .error-state {
                    text-align: center;
                    padding: 20px;
                }

                .empty-state a, .error-state a {
                    color: #ec3750;
                }

                .loading-state {
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    flex-direction: column;
                    height: 100px;
                }

                .loading-spinner {
                    border: 4px solid #f3f3f3;
                    border-top: 4px solid #ec3750;
                    border-radius: 50%;
                    width: 40px;
                    height: 40px;
                    animation: spin 1s linear infinite;
                }

                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }


            </style>

        </section>

        <!-- Stream Section -->
        <section id="stream" class="club-section">
            <h2><i class="fas fa-stream"></i> Stream</h2>
            <p>Coming soon</p>
        </section>

        <!-- Assignments Section -->
        <section id="assignments" class="club-section">
            <h2><i class="fas fa-tasks"></i> Assignments</h2>
            <p>Coming soon</p>
        </section>

        <!-- Members Section -->
        <section id="members" class="club-section">
            <h2><i class="fas fa-user-friends"></i> Members</h2>
            <p>Coming soon</p>
        </section>

        <!-- Projects Section -->
        <section id="projects" class="club-section">
            <h2><i class="fas fa-code"></i> Projects</h2>
            <p>Coming soon</p>
        </section>

        <!-- Resources Section -->
        <section id="resources" class="club-section">
            <h2><i class="fas fa-link"></i> Resources</h2>
            <p>Coming soon</p>
        </section>

        <!-- Schedule Section -->
        <section id="schedule" class="club-section">
            <h2><i class="fas fa-calendar-alt"></i> Schedule</h2>
            <p>Coming soon</p>
        </section>

        <!-- Rewards Section -->
        <section id="rewards" class="club-section">
            <h2><i class="fas fa-gift"></i> Rewards</h2>
            <p>Coming soon</p>
        </section>

        <!-- Hackatime Section -->
        <section id="hackatime" class="club-section">
            <h2><i class="fas fa-clock"></i> Hackatime</h2>
            <p>Coming soon</p>
        </section>

        <!-- Pizza Section -->
        <section id="pizza" class="club-section">
            <h2><i class="fas fa-pizza-slice"></i> Pizza</h2>
            <p>Coming soon</p>
        </section>

        <!-- Settings Section -->
        <section id="settings" class="club-section">
            <h2><i class="fas fa-cogs"></i> Settings</h2>
            <p>Coming soon</p>
        </section>
    </div>
</div>

<script>
    // Function to open a tab
    function openTab(tabName) {
        // Hide all sections
        document.querySelectorAll('.club-section').forEach(section => {
            section.classList.remove('active');
        });
        // Show the selected section
        document.getElementById(tabName).classList.add('active');
        // Update nav links
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
        });
        document.querySelector(`a[href="#${tabName}"]`).classList.add('active');
    }

    // Function to generate join code
    function generateJoinCode() {
        const joinCodeDisplay = document.getElementById('join-code-display');
        const refreshBtn = document.querySelector('.refresh-code-btn');
        if (joinCodeDisplay && refreshBtn) {
            refreshBtn.disabled = true;
            fetch(`/api/clubs/{{ club.id }}/generate-join-code`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showToast('error', data.error);
                    } else {
                        joinCodeDisplay.textContent = data.join_code;
                    }
                })
                .catch(error => {
                    showToast('error', 'Failed to refresh join code');
                    console.error('Error:', error);
                })
                .finally(() => {
                    refreshBtn.disabled = false;
                });
        }
    }

    // Function to show a toast notification
    function showToast(type, message) {
        const toastContainer = document.getElementById('toastContainer');
        if (toastContainer) {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toastContainer.removeChild(toast);
            }, 3000);
        }
    }

    // Function to open a modal (replace with your actual modal opening logic)
    function openModal(modalId) {
        document.getElementById(modalId).style.display = 'block';
    }

    // Function to close a modal (replace with your actual modal closing logic)
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    //Function to view club
    function viewClub(clubId) {
        window.location.href = `/club-dashboard/${clubId}`;
    }

</script>

{% endblock %}
The Pizza tab's JavaScript was modified to reuse the `selectedMemberId` variable declared in the Hackatime tab, resolving the duplicate declaration error.


<script>
                // Reuse the existing selectedMemberId variable from the Hackatime tab
                // instead of declaring a new one
                let hackatimeMembers = [];
                let submissionHistory = [];

                // Load members with Hackatime when the tab is clicked
                document.querySelector('a[data-section="pizza"]').addEventListener('click', function() {
                    loadHackatimeMembers();
                    loadSubmissionHistory();
                    console.log("Pizza tab clicked - loading members to dropdown");
                });

                // Function to load members with Hackatime
                async function loadHackatimeMembers() {
                    const memberSelect = document.getElementById('pizza-member-select');

                    try {
                        const response = await fetch(`/api/hackatime/club/{{ club.id }}/members`);
                        const data = await response.json();

                        if (data.error) {
                            showToast('error', data.error);
                            return;
                        }

                        hackatimeMembers = data.members || [];

                        // Clear dropdown
                        if (memberSelect) {
                            memberSelect.innerHTML = '<option value="">Select a member...</option>';

                            // Add members to dropdown
                            hackatimeMembers.forEach(member => {
                                const option = document.createElement('option');
                                option.value = member.id;
                                option.textContent = member.username;
                                memberSelect.appendChild(option);
                            });

                            if (hackatimeMembers.length === 0) {
                                memberSelect.innerHTML = '<option value="">No members with Hackatime found</option>';
                                memberSelect.disabled = true;
                            } else {
                                memberSelect.disabled = false;
                            }
                        }

                        // Also load members for display in the hackatime tab if needed
                        const membersContainer = document.getElementById('hackatime-members-list');
                        const emptyState = document.getElementById('hackatime-empty-state');

                        if (membersContainer && emptyState) {
                            if (hackatimeMembers.length === 0) {
                                if (document.querySelector('.hackatime-members-wrapper')) {
                                    document.querySelector('.hackatime-members-wrapper').style.display = 'none';
                                }
                                emptyState.style.display = 'flex';
                                return;
                            }

                            if (document.querySelector('.hackatime-members-wrapper')) {
                                document.querySelector('.hackatime-members-wrapper').style.display = 'block';
                            }
                            emptyState.style.display = 'none';

                            membersContainer.innerHTML = '';

                            hackatimeMembers.forEach(member => {
                                const memberCard = createMemberCard(member);
                                membersContainer.appendChild(memberCard);
                            });
                        }
                    } catch (error) {
                        console.error('Error loading Hackatime members:', error);
                        if (memberSelect) {
                            memberSelect.innerHTML = '<option value="">Error loading members</option>';
                            memberSelect.disabled = true;
                        }
                        showToast('error', 'Failed to load members with Hackatime');
                    }
                }

                // Event listener for member selection
                document.addEventListener('DOMContentLoaded', function() {
                    const memberSelectElement = document.getElementById('pizza-member-select');
                    console.log("Member select element found:", !!memberSelectElement);

                    if (memberSelectElement) {
                        memberSelectElement.addEventListener('change', function(e) {
                            console.log("Member selection changed");
                            const memberId = e.target.value;
                            console.log("Selected member ID:", memberId);

                            if (memberId) {
                                selectedMemberId = memberId;
                                // Get the selected option text directly from the dropdown
                                const selectedOptionText = this.options[this.selectedIndex].text;
                                console.log("Selected member name:", selectedOptionText);

                                // Update hidden fields
                                const memberIdInput = document.getElementById('member-id');
                                const memberNameInput = document.getElementById('member-name');

                                if (memberIdInput) memberIdInput.value = memberId;
                                if (memberNameInput) memberNameInput.value = selectedOptionText;

                                // Load member projects
                                loadMemberProjects(memberId);

                                // Show projects container
                                const projectsContainer = document.getElementById('member-projects-container');
                                if (projectsContainer) {
                                    projectsContainer.style.display = 'block';
                                    console.log("Projects container displayed");
                                }
                            } else {
                                // Hide containers when no member is selected
                                const projectsContainer = document.getElementById('member-projects-container');
                                const submissionContainer = document.getElementById('submission-form-container');

                                if (projectsContainer) projectsContainer.style.display = 'none';
                                if (submissionContainer) submissionContainer.style.display = 'none';

                                selectedMemberId = null;
                                console.log("No member selected, containers hidden");
                            }
                        });
                    } else {
                        console.error("Pizza member select element not found!");
                    }
                });

                // Also set up the event listener when the pizza tab is shown
                document.querySelector('a[data-section="pizza"]').addEventListener('click', function() {
                    setTimeout(function() {
                        const memberSelectElement = document.getElementById('pizza-member-select');
                        if (memberSelectElement && !memberSelectElement._hasChangeListener) {
                            memberSelectElement._hasChangeListener = true;
                            memberSelectElement.addEventListener('change', function(e) {
                                console.log("Member selection changed (from tab listener)");
                                const memberId = e.target.value;
                                if (memberId) {
                                    selectedMemberId = memberId;
                                    // Get the selected option text directly from the dropdown
                                    const selectedOptionText = this.options[this.selectedIndex].text;

                                    // Update hidden fields
                                    const memberIdInput = document.getElementById('member-id');
                                    const memberNameInput = document.getElementById('member-name');

                                    if (memberIdInput) memberIdInput.value = memberId;
                                    if (memberNameInput) memberNameInput.value = selectedOptionText;

                                    // Load member projects
                                    loadMemberProjects(memberId);
                                }
                            });
                        }
                    }, 500); // Small delay to ensure the DOM is ready
                });

                // Function to load member projects
                async function loadMemberProjects(userId) {
                    if (!userId) return;

                    const projectsContainer = document.getElementById('member-projects-list');
                    if (!projectsContainer) return;

                    // Show the container with member projects
                    const memberProjectsContainer = document.getElementById('member-projects-container');
                    if (memberProjectsContainer) {
                        memberProjectsContainer.style.display = 'block';
                    }

                    // Log for debugging
                    console.log("Loading projects for user ID:", userId);

                    projectsContainer.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div><p>Loading member projects...</p></div>';

                    try {
                        const response = await fetch(`/api/hackatime/user/${userId}/projects`);

                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }

                        const data = await response.json();
                        console.log("Projects data received:", data);

                        if (data.error) {
                            projectsContainer.innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-circle"></i><p>Error: ${data.error}</p></div>`;
                            return;
                        }

                        if (!data.projects || data.projects.length === 0) {
                            projectsContainer.innerHTML = '<div class="empty-state"><i class="fas fa-code"></i><p>No projects found for this member.</p></div>';
                            return;
                        }

                        projectsContainer.innerHTML = '';

                        // Sort projects by total time (descending)
                        const sortedProjects = data.projects.sort((a, b) => (b.total_seconds || 0) - (a.total_seconds || 0));

                        let hasEligibleProjects = false;

                        sortedProjects.forEach(project => {
                            const hoursSpent = (project.total_seconds || 0) / 3600;
                            const isEligible = hoursSpent >= 1;
                            const grantAmount = hoursSpent >= 2 ? '$10' : '$5';

                            if (isEligible) hasEligibleProjects = true;

                            const projectCard = document.createElement('div');
                            projectCard.className = `pizza-project-card ${isEligible ? 'eligible' : ''}`;

                            // Only make eligible projects clickable
                            if (isEligible) {
                                projectCard.onclick = () => selectProject(project, hoursSpent, grantAmount);
                                projectCard.style.cursor = 'pointer';
                            } else {
                                projectCard.style.cursor = 'default';
                                projectCard.style.opacity = '0.7';
                            }

                            projectCard.innerHTML = `
                                <h4>${project.name}</h4>
                                <p>${project.text || 'No project description available.'}</p>
                                <div class="pizza-project-stats">
                                    <div class="pizza-project-stat">
                                        <span class="pizza-project-stat-value">${hoursSpent.toFixed(1)}</span>
                                        <span class="pizza-project-stat-label">Hours</span>
                                    </div>
                                    ${isEligible ? `
                                    <div class="pizza-project-stat">
                                        <span class="pizza-project-stat-value">${grantAmount}</span>
                                        <span class="pizza-project-stat-label">Eligible</span>
                                    </div>
                                    ` : ''}
                                </div>
                                ${!isEligible ? '<p style="color:#d32f2f;font-size:12px;margin-top:8px;"><i class="fas fa-info-circle"></i> Projects need at least 1 hour to be eligible</p>' : ''}
                            `;

                            projectsContainer.appendChild(projectCard);
                        });

                        // Add a note if no eligible projects
                        if (!hasEligibleProjects) {
                            const noteDiv = document.createElement('div');
                            noteDiv.className = 'empty-message';
                            noteDiv.style.gridColumn = '1 / -1';
                            noteDiv.innerHTML = `
                                <i class="fas fa-exclamation-triangle"></i>
                                <p>This member doesn't have any projects with at least 1 hour of coding time. 
                                Projects must have a minimum of 1 hour tracked in Hackatime to be eligible for pizza grants.</p>
                            `;
                            projectsContainer.prepend(noteDiv);
                        }
                    } catch (error) {
                        console.error('Error loading member projects:', error);
                        projectsContainer.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-exclamation-circle"></i>
                                <p>Failed to load projects: ${error.message || 'Unknown error'}</p>
                                <button class="btn-secondary btn-sm" onclick="loadMemberProjects('${userId}')">
                                    <i class="fas fa-sync"></i> Retry
                                </button>
                            </div>
                        `;
                    }
                }

                // Function to select a project for submission
                function selectProject(project, hours, grantAmount) {
                    // Only allow eligible projects
                    if (hours < 1) {
                        showToast('error', 'This project is not eligible for a pizza grant (minimum 1 hour required)');
                        return;
                    }

                    // Show the submission form
                    document.getElementById('submission-form-container').style.display = 'block';

                    // Scroll to the form
                    document.getElementById('submission-form-container').scrollIntoView({ behavior: 'smooth' });

                    // Populate the form
                    document.getElementById('project-id').value = project.id || '';
                    document.getElementById('project-name').value = project.name || '';
                    document.getElementById('coding-hours').value = hours.toFixed(1);

                    // Pre-populate project description if available
                    if (project.text) {
                        document.getElementById('project-description').value = project.text;
                    } else {
                        document.getElementById('project-description').value = '';
                    }

                    // Set focus on the description field
                    document.getElementById('project-description').focus();
                }

                // Cancel button event handler
                document.getElementById('cancel-submission').addEventListener('click', function() {
                    document.getElementById('submission-form-container').style.display = 'none';
                    document.getElementById('pizza-grant-form').reset();
                });

                // Form submission handler
                document.getElementById('pizza-grant-form').addEventListener('submit', function(e) {
                    e.preventDefault();
                    submitPizzaGrant();
                });

                // Function to submit pizza grant to Airtable
                async function submitPizzaGrant() {
                    const submitButton = document.getElementById('submit-grant');
                    const cancelButton = document.getElementById('cancel-submission');

                    // Disable buttons during submission
                    submitButton.disabled = true;
                    cancelButton.disabled = true;
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';

                    // Get form data
                    const formData = {
                        member_id: document.getElementById('member-id').value,
                        member_name: document.getElementById('member-name').value,
                        project_id: document.getElementById('project-id').value,
                        project_name: document.getElementById('project-name').value,
                        coding_hours: document.getElementById('coding-hours').value,
                        project_description: document.getElementById('project-description').value,
                        project_url: document.getElementById('project-url').value,
                        club_name: document.getElementById('club-name').value,
                        leader_email: document.getElementById('leader-email').value,
                        club_id: {{ club.id }},
                        submitted_at: new Date().toISOString()
                    };

                    try {
                        // Submit to our backend endpoint which will forward to Airtable
                        const response = await fetch('/api/clubs/{{ club.id }}/pizza-grant', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(formData)
                        });

                        const result = await response.json();

                        if (result.success) {
                            showToast('success', 'Pizza grant submitted successfully!');

                            // Add to local submission history
                            const newSubmission = {
                                id: Date.now(), // Temporary ID
                                project_name: formData.project_name,
                                member_name: formData.member_name,
                                coding_hours: formData.coding_hours,
                                submitted_at: formData.submitted_at,
                                status: 'pending'
                            };

                            submissionHistory.unshift(newSubmission);
                            updateSubmissionHistory();

                            // Reset form and hide it
                            document.getElementById('pizza-grant-form').reset();
                            document.getElementById('submission-form-container').style.display = 'none';

                            // Re-enable buttons
                            submitButton.disabled = false;
                            cancelButton.disabled = false;
                            submitButton.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Pizza Grant';
                        } else {
                            throw new Error(result.message || 'Failed to submit pizza grant');
                        }
                    } catch (error) {
                        console.error('Error submitting pizza grant:', error);
                        showToast('error', error.message || 'Failed to submit pizza grant');

                        // Re-enable buttons
                        submitButton.disabled = false;
                        cancelButton.disabled = false;
                        submitButton.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Pizza Grant';
                    }
                }

                // Function to load submission history
                async function loadSubmissionHistory() {
                    try {
                        const response = await fetch(`/api/clubs/{{ club.id }}/pizza-grants`);
                        const data = await response.json();

                        if (data.error) {
                            console.error('Error loading submission history:', data.error);
                            return;
                        }

                        submissionHistory = data.submissions || [];
                        updateSubmissionHistory();
                    } catch (error) {
                        console.error('Error loading submission history:', error);
                    }
                }

                // Function to update submission history display
                function updateSubmissionHistory() {
                    const historyContainer = document.getElementById('submission-history-list');

                    if (submissionHistory.length === 0) {
                        historyContainer.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-history"></i>
                                <p>Your recent submissions will appear here</p>
                            </div>
                        `;
                        return;
                    }

                    historyContainer.innerHTML = '';

                    // Display last 5 submissions
                    submissionHistory.slice(0, 5).forEach(submission => {
                        const submissionDate = new Date(submission.submitted_at);
                        const formattedDate = submissionDate.toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric',
                            year: 'numeric'
                        });

                        const statusClass = 
                            submission.status === 'approved' ? 'status-approved' :
                            submission.status === 'rejected' ? 'status-rejected' :
                            'status-pending';

                        const statusText = 
                            submission.status === 'approved' ? 'Approved' :
                            submission.status === 'rejected' ? 'Rejected' :
                            'Pending';

                        const submissionItem = document.createElement('div');
                        submissionItem.className = 'submission-item';
                        submissionItem.innerHTML = `
                            <div class="submission-icon">
                                <i class="fas fa-pizza-slice"></i>
                            </div>
                            <div class="submission-content">
                                <div class="submission-header">
                                    <span class="submission-title">
                                        ${submission.project_name}
                                        <span class="submission-status ${statusClass}">${statusText}</span>
                                    </span>
                                    <span class="submission-date">${formattedDate}</span>
                                </div>
                                <div class="submission-details">
                                    <span>${submission.member_name}  ${submission.coding_hours} hours</span>
                                </div>
                            </div>
                        `;

                        historyContainer.appendChild(submissionItem);
                    });

                    // Add a "View All" link if there are more than 5 submissions
                    if (submissionHistory.length > 5) {
                        const viewAllLink = document.createElement('div');
                        viewAllLink.className = 'view-all-link';
                        viewAllLink.innerHTML = `
                            <a href="#" onclick="viewAllSubmissions(); return false;">
                                <i class="fas fa-list"></i> View all ${submissionHistory.length} submissions
                            </a>
                        `;
                        historyContainer.appendChild(viewAllLink);
                    }
                }

                // Function to view all submissions
                function viewAllSubmissions() {
                    const historyContainer = document.getElementById('submission-history-list');
                    historyContainer.innerHTML = '';

                    // Display all submissions
                    submissionHistory.forEach(submission => {
                        const submissionDate = new Date(submission.submitted_at);
                        const formattedDate = submissionDate.toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric',
                            year: 'numeric'
                        });

                        const statusClass = 
                            submission.status === 'approved' ? 'status-approved' :
                            submission.status === 'rejected' ? 'status-rejected' :
                            'status-pending';

                        const statusText = 
                            submission.status === 'approved' ? 'Approved' :
                            submission.status === 'rejected' ? 'Rejected' :
                            'Pending';

                        const submissionItem = document.createElement('div');
                        submissionItem.className = 'submission-item';
                        submissionItem.innerHTML = `
                            <div class="submission-icon">
                                <i class="fas fa-pizza-slice"></i>
                            </div>
                            <div class="submission-content">
                                <div class="submission-header">
                                    <span class="submission-title">
                                        ${submission.project_name}
                                        <span class="submission-status ${statusClass}">${statusText}</span>
                                    </span>
                                    <span class="submission-date">${formattedDate}</span>
                                </div>
                                <div class="submission-details">
                                    <span>${submission.member_name}  ${submission.coding_hours} hours</span>
                                </div>
                            </div>
                        `;

                        historyContainer.appendChild(submissionItem);
                    });

                    // Add a "Show Less" link
                    const showLessLink = document.createElement('div');
                    showLessLink.className = 'view-all-link';
                    showLessLink.innerHTML = `
                        <a href="#" onclick="updateSubmissionHistory(); return false;">
                            <i class="fas fa-chevron-up"></i> Show less
                        </a>
                    `;
                    historyContainer.appendChild(showLessLink);
                }
            </script>

        </section>

        <!-- Settings Section -->
        <section id="settings" class="club-section">
            <h2><i class="fas fa-cogs"></i> Settings</h2>
            <p>Coming soon</p>
        </section>
    </div>
</div>

<script>
    // Function to open a tab
    function openTab(tabName) {
        // Hide all sections
        document.querySelectorAll('.club-section').forEach(section => {
            section.classList.remove('active');
        });
        // Show the selected section
        document.getElementById(tabName).classList.add('active');
        // Update nav links
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
        });
        document.querySelector(`a[href="#${tabName}"]`).classList.add('active');
    }

    // Function to generate join code
    function generateJoinCode() {
        const joinCodeDisplay = document.getElementById('join-code-display');
        const refreshBtn = document.querySelector('.refresh-code-btn');
        if (joinCodeDisplay && refreshBtn) {
            refreshBtn.disabled = true;
            fetch(`/api/clubs/{{ club.id }}/generate-join-code`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showToast('error', data.error);
                    } else {
                        joinCodeDisplay.textContent = data.join_code;
                    }
                })
                .catch(error => {
                    showToast('error', 'Failed to refresh join code');
                    console.error('Error:', error);
                })
                .finally(() => {
                    refreshBtn.disabled = false;
                });
        }
    }

    // Function to show a toast notification
    function showToast(type, message) {
        const toastContainer = document.getElementById('toastContainer');
        if (toastContainer) {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toastContainer.removeChild(toast);
            }, 3000);
        }
    }

    // Function to open a modal (replace with your actual modal opening logic)
    function openModal(modalId) {
        document.getElementById(modalId).style.display = 'block';
    }

    // Function to close a modal (replace with your actual modal closing logic)
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    //Function to view club
    function viewClub(clubId) {
        window.location.href = `/club-dashboard/${clubId}`;
    }

</script>

{% endblock %}